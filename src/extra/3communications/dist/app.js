!function(t){function e(e){for(var o,i,r=e[0],c=e[1],l=e[2],p=0,u=[];p<r.length;p++)i=r[p],Object.prototype.hasOwnProperty.call(a,i)&&a[i]&&u.push(a[i][0]),a[i]=0;for(o in c)Object.prototype.hasOwnProperty.call(c,o)&&(t[o]=c[o]);for(h&&h(e);u.length;)u.shift()();return s.push.apply(s,l||[]),n()}function n(){for(var t,e=0;e<s.length;e++){for(var n=s[e],o=!0,r=1;r<n.length;r++){var c=n[r];0!==a[c]&&(o=!1)}o&&(s.splice(e--,1),t=i(i.s=n[0]))}return t}var o={},a={1:0},s=[];function i(e){if(o[e])return o[e].exports;var n=o[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.e=function(t){var e=[],n=a[t];if(0!==n)if(n)e.push(n[2]);else{var o=new Promise((function(e,o){n=a[t]=[e,o]}));e.push(n[2]=o);var s,r=document.createElement("script");r.charset="utf-8",r.timeout=120,i.nc&&r.setAttribute("nonce",i.nc),r.src=function(t){return i.p+""+({}[t]||t)+".js"}(t);var c=new Error;s=function(e){r.onerror=r.onload=null,clearTimeout(l);var n=a[t];if(0!==n){if(n){var o=e&&("load"===e.type?"missing":e.type),s=e&&e.target&&e.target.src;c.message="Loading chunk "+t+" failed.\n("+o+": "+s+")",c.name="ChunkLoadError",c.type=o,c.request=s,n[1](c)}a[t]=void 0}};var l=setTimeout((function(){s({type:"timeout",target:r})}),12e4);r.onerror=r.onload=s,document.head.appendChild(r)}return Promise.all(e)},i.m=t,i.c=o,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="dist/",i.oe=function(t){throw t};var r=window.webpackJsonp=window.webpackJsonp||[],c=r.push.bind(r);r.push=e,r=r.slice();for(var l=0;l<r.length;l++)e(r[l]);var h=c;s.push([28,0,2]),n()}({28:function(t,e,n){"use strict";n.r(e);var o=n(0),a=n.n(o),s=n(1),i=n(10),r=n.n(i),c=(n(19),n(9)),l=class extends c.a{constructor(){super(),this.name="SdnContacts",this.conns=window.navigator.b2g.mobileConnections,this.sdnContacts=[],this.fetchSDN()}get(){return this.sdnContacts}fetchSDN(){if(this.conns)for(let t=0;t<this.conns.length;t++){const{iccId:e}=this.conns[t];if(this.sdnContacts[t]=new Map,e){const n=navigator.b2g.iccManager.getIccById(e);if(n){const e=n.readContacts("sdn");e.onsuccess=()=>{const{result:n}=e;for(let e=0;e<n.length;e++){const o=n[e].number;o&&this.sdnContacts[t].set(o,n[e].name||"")}}}}}}},h=n(11),p=n(12),u=n(3),d=n(6),g=class extends a.a.PureComponent{constructor(t){super(t),this.menu=a.a.createRef()}componentDidUpdate(){const{optionMenuParams:t={},showOptionMenu:e,openOptionMenu:n}=this.props;n&&this.menu&&this.menu.on&&(document.activeElement!==this.menu&&this.menu.focus(),this.menu.show(t),this.menu.on("closed",()=>{e({openOptionMenu:!1}),u.a.request("focus")}))}render(){const{openOptionMenu:t}=this.props;return a.a.createElement("div",{id:"menu-root"},t&&a.a.createElement(d.a,{ref:t=>{this.menu=t}}))}};function m(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var w=n(13);function f(){return(f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}).apply(this,arguments)}var S=class extends a.a.PureComponent{constructor(t){var e,n;super(t),n=()=>{const{showDialog:t}=this.props;t({openDialog:!1})},(e="onBack")in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n,this.dialog=a.a.createRef()}componentDidUpdate(){const{openDialog:t,showDialog:e}=this.props;t&&this.dialog&&this.dialog.on&&(this.dialog.on("closed",()=>{e({openDialog:!1}),u.a.request("focus")}),this.dialog.focus())}render(){const{openDialog:t,dialogParams:e}=this.props;return a.a.createElement("div",{id:"dialog-root"},t&&a.a.createElement(w.a,f({onBack:this.onBack,ref:t=>this.dialog=t},e)))}},v=n(8),b=n.n(v);const M=()=>a.a.createElement("div",null);var D={listView:{name:"listView",component:b()({loader:()=>Promise.all([n.e(0),n.e(3)]).then(n.bind(null,42)),loading:M}),dis:"Communications main view!"},listInfoView:{name:"listInfoView",component:b()({loader:()=>Promise.all([n.e(0),n.e(4)]).then(n.bind(null,43)),loading:M}),dis:"Communications item detail view!"}};const y={sortBy:ContactsManager.SortOption.FAMILY_NAME,sortOrder:ContactsManager.Order.ASCENDING,sortLanguage:navigator.language||"de"};function O(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const C=new Map(JSON.parse(window.localStorage.logs||"[]")),E=new Map(JSON.parse(window.localStorage.contacts||"[]"));function P(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}n(23);var L=(t=>class extends a.a.Component{constructor(t){super(t),O(this,"processingListData",t=>{let e=[...t.entries()].sort((t,e)=>t[1].date-e[1].date);const n=window.MAX_LIST_LENGTH;return e.length>n&&(e=e.slice(-n)),new Map(e)}),O(this,"cacheData",t=>{const{logsStore:e,contactsStore:n}=this.state;let o={};"logs"===t?window.localStorage.logs=JSON.stringify([...e]):window.localStorage.contacts=JSON.stringify([...n]),o=e.size>0?{center:"call",left:"contacts",right:"options"}:{left:"contacts"},u.a.request("backupScreen",o)}),O(this,"updateList",({event:t,name:e})=>{const{logsStore:n,contactsStore:o}=this.state,{data:a={}}=t.detail||{};switch(e){case"telephony-call-ended":this.setState({logsStore:this.processingListData(n.set(a.id,a))},()=>{this.cacheData("logs")}),o.size>0&&!o.has(a.number)&&MatchContact([a.number]).then(t=>{t.size>0&&this.setState({contactsStore:new Map([...o,...t])},()=>{this.cacheData("contacts")})})}}),O(this,"contactChange",t=>{const{contactsStore:e}=this.state;switch(t.reason){case ContactsManager.ChangeReason.REMOVE:t.contacts.length>1?this.setState({contactsStore:new Map},()=>{this.cacheData("contacts")}):(e.forEach((n,o)=>{n.id===t.contacts[0].id&&e.delete(o)}),this.setState({contactsStore:e},()=>{this.cacheData("contacts")}));break;case ContactsManager.ChangeReason.CREATE:case ContactsManager.ChangeReason.UPDATE:this.fetchData()}}),O(this,"fetchData",()=>{let t=[];const e=(new DB).getAllData(),n=(async()=>{const t=new Map,e=await ContactsManager.getAll(y,2e3,!0);let n=[];try{let t=await e.next();for(;t.length;)n=n.concat(t),t=await e.next()}catch(t){}return e.release(),n.forEach(e=>{const{id:n,tel:o=[],email:a=[],photoBlob:s,photoType:i}=e,r=a.length>0?a[0].value:"";o.forEach(o=>{t.set(o.value,{id:n,number:o.value,photoBlob:s&&s.byteLength>0?window.btoa(String.fromCharCode(...s)):null,type:o.atype,name:e.name?e.name:r||o.value,photoType:i})})}),t})();Promise.all([e,n]).then(e=>{const[n,o]=e;let a=new Map;n.forEach(t=>{a.set(t.id,t)}),this.setState({logsStore:this.processingListData(a),contactsStore:o},()=>{this.cacheData("contacts"),this.cacheData("logs")}),a.forEach(e=>{!o.has(e.number)&&e.number.length>=7&&t.push(e.number)}),t.length>0&&o.size>0&&MatchContact([...new Set(t)]).then(t=>{t.size>0&&this.setState({contactsStore:new Map([...o,...t])},()=>{this.cacheData("contacts")})})})}),O(this,"deleteLogs",t=>{const{logsStore:e}=this.state;t.forEach(t=>{e.delete(t)}),this.setState({logsStore:e},()=>{this.cacheData("logs")})}),this.state={logsStore:C,contactsStore:E},t.isSnapshot||(ContactsManager.addEventListener(ContactsManager.EventMap.CONTACT_CHANGE,this.contactChange),window.addEventListener("telephony-call-ended",t=>{this.updateList({event:t,name:"telephony-call-ended"})}))}componentDidMount(){const{isSnapshot:t}=this.props;t||this.fetchData()}componentWillUnmount(){const{isSnapshot:t}=this.props;t||(window.removeEventListener("telephony-call-ended",t=>{this.updateList({event:t,name:"telephony-call-ended"})}),ContactsManager.removeEventListener(ContactsManager.EventMap.CONTACT_CHANGE,this.contactChange))}render(){const{logsStore:e,contactsStore:n}=this.state,o={logsStore:e,contactsStore:n,deleteLogs:this.deleteLogs,...this.props};return a.a.createElement(t,o)}})(class extends a.a.Component{constructor(t){super(t),P(this,"showDialDialog",t=>{const e=t.detail.data;this.setState({openDialog:!0,dialogParams:e})}),P(this,"showDialOptionMenu",t=>{const e=t.detail.data;this.setState({openOptionMenu:!0,optionMenuParams:e})}),P(this,"changeView",t=>{const{currentView:e,params:n}=t;D[e]&&this.setState({currentView:e,params:n})}),P(this,"showDialog",({openDialog:t,options:e})=>{this.setState({openDialog:t,dialogParams:e})}),P(this,"showOptionMenu",({openOptionMenu:t,options:e})=>{this.setState({openOptionMenu:t,optionMenuParams:{options:e}})}),this.state={currentView:"listView",params:{},openDialog:!1,dialogParams:{},openOptionMenu:!1,optionMenuParams:[]},new class{constructor(t){m(this,"getDialingNumberAtPosition",async t=>{const e=await(new DB).getAllData();let n=new Map;if(e&&e.length>0&&(e.forEach(t=>{n.set(t.id,t)}),n=new Map([...n.entries()].sort((t,e)=>t[1].date-e[1].date))),n&&n.size){let e=0;for(let o=n.size-1;o>=0;o--){const a=[...n][o][1];if(a.callType.includes("outgoing")&&(e+=1),e===t)return a.number}}return null}),m(this,"btCommandHandler",t=>{const{command:e}=t.detail.data,o=e.startsWith("ATD");("BLDN"===e||o)&&n.e(5).then(n.bind(null,39)).then(t=>{const n=new t.default;if(o&&">"!==e[3]){const t=e.substring(3);return void n.dialForcely(t)}const a=o?parseInt(e.substring(4),10):1;this.getDialingNumberAtPosition(a).then(t=>{null!==t?n.dialForcely(t):this.showDialog({openDialog:!0,options:{header:"confirmation",content:"no-recent-numbers",type:"alert",noClose:!1,translated:!1}})})})}),window.addEventListener("bluetooth-dialer-command",this.btCommandHandler),this.showDialog=t}}(this.showDialog),window.addEventListener("showDialDialog",this.showDialDialog),window.addEventListener("showDialOptionMenu",this.showDialOptionMenu)}render(){const{currentView:t,params:e,openDialog:n,dialogParams:o,openOptionMenu:s,optionMenuParams:i}=this.state,{deleteLogs:r}=this.props,c={openDialog:n,dialogParams:o,showDialog:this.showDialog},l={openOptionMenu:s,optionMenuParams:i,showOptionMenu:this.showOptionMenu};let u=e;if("listView"===t){const{isSnapshot:t,logsStore:e,contactsStore:n}=this.props;if(u={isSnapshot:t,logsStore:e,contactsStore:n,openOptionMenu:s,showOptionMenu:this.showOptionMenu,deleteLogs:r},t){const t=new Map(JSON.parse(localStorage.logs||"[]")),e=new Map(JSON.parse(localStorage.contacts||"[]"));u.logsStore=new Map([...t.entries()].sort((t,e)=>t[1].date-e[1].date)),u.contactsStore=new Map([...e.entries()])}}return a.a.createElement("div",{id:"app",tabIndex:-1},a.a.createElement(D[t].component,{...u,changeView:this.changeView,showDialog:this.showDialog,openDialog:n}),a.a.createElement(h.a,null),a.a.createElement(S,c),a.a.createElement(g,l),a.a.createElement(p.a,null))}});window.MAX_LIST_LENGTH=100;const T=()=>{const t=r.a.renderToStaticMarkup(a.a.createElement(N,{isSnapshot:!0}));window.domString=t};class N extends a.a.Component{constructor(t){if(super(t),!t.isSnapshot){const t=["settingsService","devicecapabilityService","contactsService","timeService"];window.libSession.initService(t).then(()=>{SettingsObserver.init()}),DeviceCapabilityManager.get("hardware.memory").then(t=>{localStorage.setItem("hardware-memory",t),256===t&&(document.body.classList.add("low-memory-device"),window.MAX_LIST_LENGTH=50)})}}componentDidMount(){const{isSnapshot:t}=this.props;t||(window.performance.mark("fullyLoaded"),n.e(6).then(n.bind(null,41)).then(()=>{}))}render(){const{isSnapshot:t}=this.props;return a.a.createElement(L,{isSnapshot:t})}}window.sdnContacts=new l,window.renderToString=T,window.addEventListener("renderDomToString",()=>{T()}),window.api.l10n.once(()=>{Object(s.render)(a.a.createElement(N,{isSnapshot:!1}),document.getElementById("root"))}),e.default=N}});