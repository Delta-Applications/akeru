const DEL_CHAR="\b",SEND_CHAR="\r\n",EMOTICON_CODE=55296,CR_LF_CODE=8232,SPECIAL_MESSAGE=String.fromCharCode(239)+String.fromCharCode(191)+String.fromCharCode(189),BUBBLE_END_CHAR="\n";function RttView(e){this.call=e.call,this.callId=e.callId,this.name=e.name,this.durationNode=e.durationNode,this.view=null,this.sendIntervalTime=3e3,this.receiveIntervalTime=3300,this.nextMesageId=0,this.appendSentMessage=!0,this.appendReceivedMessage=!0,this.showLastSentMessageTimer=null,this.inputTime=null,this.receiveTime=null,this.backupMsg="",this.showSendkey=!1,this.rttBubbleTimer_support=!1,this.call.onrttmessage=e=>{this.receiveMessage(e.message)},this.addView()}RttView.prototype.addView=function(){this.view=document.getElementById("rtt-view-template").cloneNode(!0),this.view.id="",this.view.setAttribute("call-id",this.callId),this.messageInput=this.view.querySelector(".messages-input"),this.messageInput.addEventListener("keydown",this.handleInput.bind(this)),this.messageInput.placeholder=window.api.l10n.get("message");const e=document.getElementById("call-screen");e.appendChild(this.view);const t=this.view.querySelector(".name"),s=this.view.querySelector(".time");t.textContent=this.name,s.textContent=` (${this.durationNode.textContent})`,setInterval(()=>{s.textContent=` (${this.durationNode.textContent})`},1e3),this.messageInput.oninput=this.onMessageInput.bind(this)},RttView.prototype.show=function(){this.view&&(this.view.classList.add("display"),setTimeout(()=>{this.messageInput.focus()}),this.messageInput.onblur=()=>{this.view.classList.contains("display")&&!CallScreen.isBtMenuDisplayed()&&setTimeout(()=>{this.messageInput.focus()})})},RttView.prototype.hide=function(){this.view.classList.remove("display")},RttView.prototype.remove=function(){this.view.parentNode&&this.view.parentNode.removeChild(this.view),RttCache.clearCache(this.callId)},RttView.prototype.onMessageInput=function(e){if(this.inputTime&&(clearTimeout(this.inputTime),this.inputTime=null),e.isComposing)dump("Delete SendRttMessage DEL_CHAR");else{if(this.rttBubbleTimer_support&&(this.inputTime=setTimeout(()=>{this.resetInput(!0)},this.sendIntervalTime)),this.appendSentMessage){if(dump("RTT append new sent message"),!this.messageInput.value)return;this.appendSentMessage=!1,this.activeSentMessageId=this.appendMessage({direction:"sent",body:this.messageInput.value})}else this.updateMessage(this.activeSentMessageId,this.messageInput.value);this.sendMessage(this.messageInput.value),this.messageInput.value||this.resetInput(!1),this.messageInput.value&&!this.showSendkey&&(dump("rv_onMessageInput, show send RSK"),CallScreenHelper.showRttViewEditOption(),this.showSendkey=!0)}},RttView.prototype.receiveMessage=function(t){dump(`RTT receiveMessage ${t}`);for(let e=0;e<t.length;e++)dump(`RTT receiveMessage transfor: ${t.charCodeAt(e)}`);if(t=(t=(t=t&&t.charCodeAt(0)===CR_LF_CODE?" ":t).replace(/\r/g,"")).replace(SPECIAL_MESSAGE,"")){this.receiveTime&&clearTimeout(this.receiveTime),this.rttBubbleTimer_support&&(dump("RTT receiveMessage,set receive bubble timer"),this.receiveTime=setTimeout(()=>{this.resetReceive()},this.receiveIntervalTime));var e,s=this.sanitizedMessage(t);for(let e=0;e<s.del.length;e++){this.appendReceivedMessage=!1;var i=RttCache.getLastMessage(this.callId,"received");i&&void 0!==i.id&&(this.activeReceivedMessageId=i.id,this.updateMessage(this.activeReceivedMessageId,null,DEL_CHAR))}s.message.length&&(this.appendReceivedMessage?(this.appendReceivedMessage=!1,this.view.classList.contains("display")||(e=window.api.l10n.get("new-message",{name:this.name}),CallScreen.showToast({message:e})),dump("RTT append new received message"),s.message!==BUBBLE_END_CHAR&&(this.activeReceivedMessageId=this.appendMessage({direction:"received",body:s.message}))):this.updateMessage(this.activeReceivedMessageId,null,s.message)),t&&t.slice(-BUBBLE_END_CHAR.length)===BUBBLE_END_CHAR&&(dump("RTT receiveMessage SEND_CHAR,resetReceive"),this.resetReceive())}},RttView.prototype.sendMessage=function(s){if(dump(`RTT sendMessage ${s}`),s!==SEND_CHAR){let e=0,t=s.length;for(e=0;e<s.length;e++)if(s[e]!==this.backupMsg[e]){t=e;break}for(e;e<this.backupMsg.length;e++)dump("RTT send DEL_CHAR"),this.call.sendRttMessage(DEL_CHAR);for(e=t;e<s.length;e++)s.substring(e,e+1).charCodeAt(0)>=EMOTICON_CODE&&e+2<=s.length?(this.call.sendRttMessage(s.substring(e,e+2)),dump(`RTT sendRttMessage ${s.substring(e,e+2)}`),e++):(this.call.sendRttMessage(s.substring(e,e+1)),dump(`RTT sendRttMessage ${s.substring(e,e+1)}`));this.backupMessage(s)}else this.call.sendRttMessage(SEND_CHAR)},RttView.prototype.backupMessage=function(e){this.backupMsg=e,dump(`RTT backupMessage ${this.backupMsg}`)},RttView.prototype.resetInput=function(e){dump("rtt_resetInput message"),RttCache.setMessageColor(this.callId,this.activeSentMessageId,"#0F5EEB","#ffffff"),CallScreenHelper.showRttViewOption(),this.showSendkey=!1,dump("rtt_resetInput, hide send RSK"),e&&(e=this.messageInput.value+BUBBLE_END_CHAR,dump("rtt_resetInput,sendkey, message: "+e),this.updateMessage(this.activeSentMessageId,e),this.sendMessage(SEND_CHAR)),this.appendSentMessage=!0,this.messageInput.value="",this.backupMessage(this.messageInput.value),this.inputTime&&(clearTimeout(this.inputTime),this.inputTime=null)},RttView.prototype.sendRTTmsg=function(){dump("rtt_sendRTTmsg"),this.resetInput(!0)},RttView.prototype.resetReceive=function(){dump("rtt_resetReceive message"),RttCache.setMessageColor(this.callId,this.activeReceivedMessageId,"#e6e6e6","#323232"),this.appendReceivedMessage=!0,this.receiveTime&&(clearTimeout(this.receiveTime),this.receiveTime=null)},RttView.prototype.sanitizedMessage=function(e){let s=e;const i={del:"",message:""};var a=s.split(DEL_CHAR).length-1;if(0==a)i.message=s;else if(a===s.length)i.del=s;else{let t=1;for(let e=1;e<=a;e++){var n=s.indexOf(DEL_CHAR,t);-1!==n&&s[n-1]!==DEL_CHAR?s=s.substring(0,n-1)+s.substring(n+1,s.length):t++}e=s.split(DEL_CHAR).length-1;i.del=s.substring(0,e),i.message=s.substring(e)}return i},RttView.prototype.handleInput=function(e){switch(e.key){case"ArrowUp":window.setTimeout(()=>{const{messageInput:e}=this;var{length:t}=e.value;e.setSelectionRange(t,t)});var t={curRttView:this.view,key:e.key};window.dispatchEvent(new CustomEvent("rttViewChange",{detail:t})),e.stopPropagation(),e.preventDefault();break;case"ArrowDown":t={curRttView:this.view,key:e.key};window.dispatchEvent(new CustomEvent("rttViewChange",{detail:t})),e.stopPropagation(),e.preventDefault();break;case"Backspace":if(this.showLastSentMessageTimer)return;this.showLastSentMessageTimer=setTimeout(()=>{this.showLastSentMessageTimer=null,this.showLastSentMessage()},200);break;case"ArrowLeft":case"ArrowRight":e.stopPropagation(),e.preventDefault()}},RttView.prototype.appendMessage=function(e){let t=null;var s=RttCache.getMessage(this.callId,this.nextMesageId-1);return t=s&&"sent"===s.direction&&!s.body?this.nextMesageId-1:this.nextMesageId++,dump(`RTT appendMessage ${t}`),RttCache.setMessage(this.callId,t,e),t},RttView.prototype.updateMessage=function(e,t,s){dump(`RTT updateMessage ${e}`);const i=RttCache.getMessage(this.callId,e);null!==t?i.body=t:s===DEL_CHAR?(dump("RTT receive DEL_CHAR"),i.body=i.body.substring(0,i.body.length-1)):i.body+=s,RttCache.setMessage(this.callId,e,i)},RttView.prototype.showLastSentMessage=function(){if(!this.messageInput.value){var e=RttCache.getLastMessage(this.callId,"sent");if(e&&void 0!==e.id){this.messageInput.value=e.body,this.activeSentMessageId=e.id,this.appendSentMessage=!1,this.backupMessage(e.body),dump(`RTT last message id for set is ${this.activeSentMessageId}`);const{messageInput:t}=this;var{length:e}=t.value;t.setSelectionRange(e,e)}}},window.RttView=RttView;