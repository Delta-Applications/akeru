!function(e){function t(){this.telephony=navigator.b2g.telephony,this.localPrepared=!1,this.remotePrepared=!1,this.remoteSurface=null,this.setCameraOn(!1),this.setCameraFront(!0),this.callOldState="Voice",this.callConnectingState="",this.userRequestVoice=!1,this.frontSensorAngle=0,this.rearSensorAngle=0,this.frontLandscape=!1,this.rearLandscape=!1,this.start(),this.handleConfirmDlgEvents=this.handleConfirmDlgEvents.bind(this),this.EVENTS.forEach(e=>{this[`${e}`]=this[`${e}`].bind(this)}),this.handleConfirmDlgEvents=this.handleConfirmDlgEvents.bind(this)}t.prototype.EVENTS=["alerting","connected","dialing","disconnected","statechange"],t.prototype.start=function(){DeviceCapabilityManager.get("device.vilte").then(e=>{e&&(this.telephony.addEventListener("callschanged",this.onCallsChanged.bind(this)),this.getSensorAngle())})},t.prototype.getSensorAngle=function(){navigator.b2g.cameras.getCameraSensorAngle("back").then(e=>{((this.rearSensorAngle=e)%180!=0&&-1!==screen.orientation.type.indexOf("portrait")||e%180==0&&-1===screen.orientation.type.indexOf("portrait"))&&(this.rearLandscape=!0)}),navigator.b2g.cameras.getCameraSensorAngle("front").then(e=>{((this.frontSensorAngle=e)%180!=0&&-1!==screen.orientation.type.indexOf("portrait")||e%180==0&&-1===screen.orientation.type.indexOf("portrait"))&&(this.frontLandscape=!0)})},t.prototype.setLocalVideoViewRotation=function(e){const t=document.getElementById("list-call"),a=t.querySelector(".local-video-view");let o="",l=null,i=null;i="front"===e?(o="scale(-1, 1) ",l=this.frontSensorAngle,this.frontLandscape):(l=this.rearSensorAngle,this.rearLandscape),l%180?a.classList.add("rotate"):a.classList.remove("rotate"),i?a.classList.add("landscape"):a.classList.remove("landscape"),a.style.transform=`${o}rotate(${l}deg)`},t.prototype.getElements=function(e){let t=null;if(CallsHandler.activeCall)t=CallsHandler.activeCall.node;else{if(!CallsHandler.incomingCall)return void DUMP("VT_call getElements return null");t=CallsHandler.incomingCall.node}"local"===e?([this.localAnchor]=t.getElementsByClassName("local-video-anchor"),[this.localView]=t.getElementsByClassName("local-video-view")):"remote"===e&&([this.remoteAnchor]=t.getElementsByClassName("remote-video-anchor"),[this.remoteView]=t.getElementsByClassName("remote-video-view"))},t.prototype.isBidirectional=function(e){return"Bidirectional"===e.videoCallState},t.prototype.onCallsChanged=function(){if(!this.telephony.conferenceGroup.calls.length&&1===this.telephony.calls.length){const[t]=this.telephony.calls;t&&(DUMP(`VT_call oncallschanged state is: ${t.videoCallState}`),this.EVENTS.forEach(e=>{t.addEventListener(e,this[`${e}`])}),"dialing"!==t.state&&"alerting"!==t.state||!CallsHandler.isVideoCall()||(this.showLocalAnchor(!0),CallsHandler.enableSpeakerForVT()))}},t.prototype.alerting=function(e){e=e.target;DUMP(`VT_call alerting state is: ${e.videoCallState}, this.localPrepared=${this.localPrepared}`),this.callConnectingState=e.videoCallState},t.prototype.dialing=function(e){e=e.target;DUMP(`VT_call dialing state is: ${e.videoCallState}`),this.callConnectingState=e.videoCallState},t.prototype.connected=function(e){e=e.target;"Bidirectional"===this.callConnectingState&&"Voice"===e.videoCallState&&(e=CallsHandler.isSupportedVT()?"video-call-rejected":"video-call-not-support",CallScreen.showToast({messageL10nId:e})),this.callConnectingState="",CallsHandler.handleCallInfoTimer(!0)},t.prototype.disconnected=function(e){this.releaseCamera(e.target),this.showLocalAnchor(!1),this.hideStreams("remote"),CallsHandler.isShowInfo=!0,this.setCameraFront(!0),this.callOldState="Voice",this.callConnectingState="",this.userRequestVoice=!1,this.remoteSurface=null,CallScreen.closeConfirmDialog();const t=e.target;this.EVENTS.forEach(e=>{t.removeEventListener(e,this[`handle_${e}`])})},t.prototype.statechange=function(e){if(!this.telephony.conferenceGroup.calls.length&&1===this.telephony.calls.length){e=e.target;if(e&&"connected"===e.state&&(e.videoCallState!==this.callOldState||this.isCameraOn())){this.callOldState=e.videoCallState,DUMP(`VT_call _handle_statechange call.videoCallState=${e.videoCallState}`);const t=document.getElementById("list-call");"Bidirectional"===e.videoCallState?(t.querySelector(".local-video-view").classList.remove("full"),this.showLocalAnchor(!0),this.showRemoteAnchor(!0)):"RxEnabled"===e.videoCallState?(this.releaseCamera(e),this.showLocalAnchor(!1),this.showRemoteAnchor(!0)):"TxEnabled"===e.videoCallState?(t.querySelector(".local-video-view").classList.remove("full"),this.showLocalAnchor(!0),this.showRemoteAnchor(!1)):"Voice"===e.videoCallState&&(this.userRequestVoice?this.userRequestVoice=!1:CallScreen.showToast({messageL10nId:"call-downgraded"}),this.isCameraOn()&&(this.releaseCamera(e),t.querySelector(".local-video-view").classList.remove("full"),CallScreenHelper.render()),this.showLocalAnchor(!1),this.showRemoteAnchor(!1)),CallsHandler.isShowInfo||CallsHandler.toggleShowInfo()}}},t.prototype.releaseCamera=function(e){if(e&&this.isCameraOn()){const{videoCallProvider:t}=e;t.setCamera(),this.setCameraOn(!1)}},t.prototype.onsessionmodifyresponse=function(e,t){if(e&&t)if(DUMP(`VT_call call resp.status=${t.status}`),"timed-out"===t.status)CallScreen.closeConfirmDialog();else if("rejected-by-remote"===t.status||"fail"===t.status){if(!CallsHandler.isVideoCall()){"rejected-by-remote"===t.status&&CallScreen.showToast({messageL10nId:"video-call-rejected-timeout"});const a=document.getElementById("list-call");a.querySelector(".local-video-view").classList.remove("full"),this.releaseCamera(e),this.showLocalAnchor(!1),this.hideStreams("remote"),CallScreenHelper.render()}}else"success"===t.status&&CallsHandler.enableSpeakerForVT()},t.prototype.onsessionmodifyrequest=function(o,l){if(o&&l&&"audio-only"!==l.request.state){const{videoCallProvider:i}=o;if(this.telephony.conferenceGroup.calls.length||1!==this.telephony.calls.length)return l.request.state=this.getCallType(o.videoCallState),l.request.quality="default",void i.sendSessionModifyResponse(l.request);let a=o.id.number;window.addEventListener("gaia-confirm-open",this.handleConfirmDlgEvents),Contacts.findByNumber(o.id.number,(e,t)=>{e&&t&&(a=Utils.getPhoneNumberPrimaryInfo(t,e));e={title:{id:"videoCall",args:{}},body:{id:"video-call-from",args:{name:a}},cancel:{name:"Cancel",l10nId:"cancel",priority:1,callback:()=>{l.request.state=this.getCallType(o.videoCallState),l.request.quality="default",i.sendSessionModifyResponse(l.request)}},confirm:{name:"Accept",l10nId:"accept",priority:3,callback:()=>{this.prepareLocalStreams("front").then(e=>{this.localView.mozSrcObject=e,this.localAnchor.hidden=!0}),this.prepareRemoteStreams().then(e=>{this.remoteView.mozSrcObject=e,this.remoteAnchor.hidden=!0}),i.sendSessionModifyResponse(l.request),CallsHandler.enableSpeakerForVT()}}};CallScreen.showConfirmDialog(e)}),TonePlayer.playNotice()}},t.prototype.getCallType=function(e){let t=null;switch(e){case"Bidirectional":t="bidirectional";break;case"TxEnabled":t="tx-enabled";break;case"RxEnabled":t="rx-enabled";break;case"Voice":t="audio-only"}return t},t.prototype.showLocalAnchor=function(e){e?this.localPrepared?this.showStreams("local"):(e=this.isCameraFront()?"front":"rear",this.prepareLocalStreams(e).then(e=>{this.localView.mozSrcObject=e,this.localAnchor.hidden=!0,this.showStreams("local")})):(this.hideStreams("local"),this.localAnchor&&(this.localAnchor.hidden=!0))},t.prototype.showRemoteAnchor=function(e){e?this.remotePrepared?this.showStreams("remote"):this.prepareRemoteStreams().then(e=>{this.remoteView.mozSrcObject=e,this.remoteAnchor.hidden=!0,this.showStreams("remote")}):this.hideStreams("remote")},t.prototype.prepareLocalStreams=function(o){return new Promise((t,e)=>{if(this.localPrepared)return DUMP("VT_call localPrepared"),void e(new Error("localPrepared"));this.localPrepared=!0;var[e]=this.telephony.calls;const{videoCallProvider:a}=e;"front"===o?(a.setCamera("front"),this.setLocalVideoViewRotation("front"),this.setCameraFront(!0)):(a.setCamera("rear"),this.setLocalVideoViewRotation("rear"),this.setCameraFront(!1)),this.setCameraOn(!0),this.getElements("local"),a.getPreviewStream({previewSize:{width:320,height:240}}).then(e=>{DUMP("VT_call local got surface"),t(e)})})},t.prototype.prepareRemoteStreams=function(){return new Promise((t,e)=>{if(this.remotePrepared)return DUMP("VT call remotePrepared"),void e(new Error("remotePrepared"));if(this.remoteSurface)t(this.remoteSurface);else{this.remotePrepared=!0;var[e]=this.telephony.calls;const{videoCallProvider:a}=e;this.getElements("remote"),a.onchangepeerdimensions=e=>{DUMP(`VT_call remoteWidth:${e.width},remoteHeight${e.height}`),e.width>e.height?this.remoteView.classList.add("landscapeView"):this.remoteView.classList.remove("landscapeView")},a.getDisplayStream({previewSize:{width:240,height:320}}).then(e=>{DUMP("VT_call remote got surface"),this.remoteSurface=e,t(e)})}})},t.prototype.showStreams=function(e){if(DUMP(`VT_call showStreams option = ${e}`),"local"===e){if(this.localAnchor&&this.localAnchor.hidden&&this.isCameraOn()){const a=document.getElementById("list-call");a.querySelector(".local-video-anchor").classList.remove("hide-camera");var t=this.telephony.calls[0].state;"alerting"!==t&&"dialing"!==t||a.querySelector(".local-video-view").classList.add("full"),this.localAnchor.hidden=!1,this.localView&&this.localView.play()}}else"remote"===e&&this.remoteAnchor&&this.remoteAnchor.hidden&&(this.remoteAnchor.hidden=!1,this.remoteView&&this.remoteView.play())},t.prototype.hideStreams=function(e){if("local"===e){if(this.localAnchor){if(!this.isCameraOn()){const t=document.getElementById("list-call");t.querySelector(".local-video-anchor").classList.add("hide-camera")}this.localView&&(this.localView.pause(),this.localView.mozSrcObject&&(this.localView.mozSrcObject=null)),this.localPrepared=!1}}else"remote"===e&&this.remoteAnchor&&(this.remoteView&&(this.remoteView.pause(),this.remoteView.mozSrcObject&&(this.remoteView.mozSrcObject=null)),this.remoteAnchor.hidden=!0,this.remotePrepared=!1)},t.prototype.isCameraOn=function(){return DUMP(`VT_call isCameraOn=${this.CameraOn}`),this.CameraOn},t.prototype.setCameraOn=function(e){DUMP(`VT_call setCameraOn=${e}`),this.CameraOn=e},t.prototype.isCameraFront=function(){return DUMP(`VT_call isCameraFront=${this.cameraFront}`),this.cameraFront},t.prototype.setCameraFront=function(e){DUMP(`VT_call setCameraFront=${e}`),this.cameraFront=e},t.prototype.handleConfirmDlgEvents=function(e){switch(e.type){case"gaia-confirm-close":window.removeEventListener("gaia-confirm-close",this.handleConfirmDlgEvents),CallScreen.unlockScreenWake();break;case"gaia-confirm-open":window.removeEventListener("gaia-confirm-open",this.handleConfirmDlgEvents),window.addEventListener("gaia-confirm-close",this.handleConfirmDlgEvents),CallScreen.lockScreenWake()}},t.prototype.requestVoice=function(){this.userRequestVoice=!0},e.VT=new t}(window);