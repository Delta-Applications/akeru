function HandledCall(e){if(this.photo=null,this.leftGroup=!1,this.call=e,this.allowedConnected=!0,this.info="",this.blobURL=null,this.iccMessageBlobURL=null,this.outgoing=!1,this._=window.api.l10n.get,this.rttViewAdded=!1,this.rttMode="off",this.record={number:this.call.id.number,name:""},e.addEventListener("statechange",this),e.ongroupchange=()=>{this.call.group?(this.item=ConferenceGroupHandler.addToGroupDetails(this.info),this.item.endCall=()=>{this.call.hangUp()},this.item.separateCall=()=>{window.navigator.b2g.telephony.conferenceGroup.remove(this.call)},CallScreen.removeCall(this.node),this.leftGroup=!1):this.wasUnmerged()?(ConferenceGroupHandler.removeFromGroupDetails(this.item),CallScreen.insertCall(this.node),this.leftGroup=!1):(ConferenceGroupHandler.removeFromGroupDetails(this.item),this.leftGroup=!this.item.dataset.groupHangup)},CallScreen.supportVT()){const{videoCallProvider:i}=this.call;i.onsessionmodifyresponse=e=>{VT.onsessionmodifyresponse(this.call,e)},i.onsessionmodifyrequest=e=>{VT.onsessionmodifyrequest(this.call,e)}}this.call.onrttmodifyresponse=e=>{Rtt.onrttmodifyresponse(this.call,e)},this.call.onrttmodifyrequest=e=>{Rtt.onrttmodifyrequest(this.call,e)},this.initialState=this.call.state,this.cachedInfo="",this.cachedAdditionalTel="",this.cachedAdditionalTelType="",this.removed=!1,this.wasConnected=!1,this.node=document.getElementById("handled-call-template").cloneNode(!0),this.node.id="list-call",this.node.classList.add("handled-call"),this.node.hidden=!1,this.durationNode=this.node.querySelector(".duration"),this.durationChildNode=this.node.querySelector(".duration span"),this.numberNode=this.node.querySelector(".numberWrapper .number bdi"),this.hdNode=this.node.querySelector(".hd-icon"),this.outerNode=this.node.querySelector(".numberWrapper .number"),this.photoItem=this.node.querySelector(".photo-icon"),this.dialNumberNode=document.querySelector("#dialing-number bdi"),this.dialNumberOuterNode=document.getElementById("dialing-number"),this.additionalTelNode=this.node.querySelector(".additionalContactInfo .tel"),this.additionalTelTypeNode=this.node.querySelector(".additionalContactInfo .tel-type"),this.wifiCallQuality=this.node.querySelector(".quality-content"),this.stirContainer=this.node.querySelector(".stir-container"),this.stirChecked=this.node.querySelector(".additionalContactInfo .stir-checked"),this.updateCallNumber(),this.updateHdIcon(),this.updateRttMode();let t=this._("connecting");"incoming"===this.call.state&&(t=CallsHandler.isVideoCall()?this._("vt-incoming-call"):this._("kai-incoming-call"),this.call.verStatus&&dump("[---CALLSCREEN---]the call verStatus is:",this.call.verStatus),"pass"===this.call.verStatus&&this.showStirIndicator(!0)),this.durationChildNode.textContent=t,this.updateDirection(),this.updateRttMode(),"connected"!==this.initialState&&"held"!==this.initialState||this.connected(),"held"===this.initialState&&(this.node.classList.add("held"),this.held()),!this.call.emergency||"dialing"!==this.call.state&&"alerting"!==this.call.state&&"connected"!==this.call.state||AML.sendAMLSms(this.call.serviceId,this.call.id.number)}HandledCall.prototype.wasUnmerged=function(){return!this.node.dataset.groupHangup&&"disconnecting"!==this.call.state&&"disconnected"!==this.call.state},HandledCall.prototype.allowConnected=function(){this.allowedConnected||(this.allowedConnected=!0,this.connected())},HandledCall.prototype.handleEvent=function(e){switch(CallScreenHelper.render(),"bad"===this.call.vowifiQuality&&CallScreen.remindBadWfc(),this.updateHdIcon(),this.updateRttMode(),dump("calls_handled_call HandledCall.prototype.handleEvent call.state:"+e.call.state),e.call.state){case"connected":DialerHelper.isDialerHelperShown()||DtmfHelper.enableDtmf(),this.allowedConnected&&(this.connected(),dump("HandledCall.prototype.handleEvent, rttViewAdded = "+this.rttViewAdded+" rttMode = "+e.call.rttMode),this.rttViewAdded&&"full"===e.call.rttMode&&CallScreen.showRttView()),CallRecording.autoCallRec(),dump("connected");break;case"disconnected":this.node.querySelector(".callended").classList.remove("hidden"),this.disconnected(),this.showDisconnectedReason(e.call.disconnectedReason),dump("disconnected");break;case"held":Rtt.isRttViewShown()&&(dump("calls_handled_call HandledCall.prototype.handleEvent Hide RTT view"),Rtt.hideRttView()),this.node.classList.add("held"),this.held()}},HandledCall.prototype.showDisconnectedReason=function(e){switch(dump("CS showDisconnectedReason:"+e),e){case"CallRejected":CallScreen.showToast({messageL10nId:"barred-error"});break;case"FDNBlocked":var t=this._("fdnBlocked",{number:this.call.id.number});CallScreen.showToast({message:t,latency:5e3});break;case"SipForbidden":CallScreen.handleCallError("SipForbidden",this.call.id.number);break;case"SipBusy":dump("CS showDisconnectedReason is SipBusy"),TonePlayer.playSequence([[480,620,500],[0,0,500],[480,620,500],[0,0,500],[480,620,500],[0,0,500]])}},HandledCall.prototype.updateHdIcon=function(){const e=this.node.querySelector(".infoContainer");"Normal"===this.call.voiceQuality?e.setAttribute("hdicon-display","hide"):e.setAttribute("hdicon-display","show"),this.hdNode.classList.toggle("hide","Normal"===this.call.voiceQuality)},HandledCall.prototype.updateCallNumber=function(){var{number:e}=this.call.id;const t=this.numberNode;if(dump("callscreen updateCallNumber"),this.call.secondId)return t.textContent=this._("switch-calls"),this.cachedInfo=this._("switch-calls"),this.cachedAdditionalTel="",this.cachedAdditionalTelType="",this.replaceAdditionalContactInfo("",""),this.numberNode.style.fontSize="",this.changeCssStyle(),void dump("callscreen updateCallNumber 1"+t.textContent);if(!e)return this.info=this._("unknown"),t.textContent=this.info,this.cachedInfo=this.info,this.changeCssStyle(),void dump("callscreen updateCallNumber 2"+t.textContent);if(this.call.emergency)return this.node.classList.add("emergency"),this.photoItem.setAttribute("data-icon","call-emergency-32"),this.photoItem.setAttribute("dir","ltr"),t.textContent=e,this.cachedInfo=e,this.replaceAdditionalContactInfo(this._("emergencyNumber"),""),this.cachedAdditionalTel=this._("emergencyNumber"),this.cachedAdditionalTelType="",this.changeCssStyle(),void dump("callscreen updateCallNumber 3"+t.textContent);if(Voicemail.check(e,this.call.serviceId))this.node.classList.add("voice-mail"),this.photoItem.setAttribute("data-icon","voicemail-32"),this.photoItem.setAttribute("dir","ltr"),t.textContent=this._("voiceMail"),this.cachedInfo=this._("voiceMail"),this.info=this._("voiceMail"),this.record={number:e,name:this.info},this.changeCssStyle(),dump("callscreen updateCallNumber 4"+t.textContent);else{const i=SdnContacts.get()[this.call.serviceId];if(i&&i.get(e))return this.info=i.get(e),this.cachedInfo=this.info,t.textContent=this.info,this.replaceAdditionalContactInfo(e,""),this.formatPhoneNumber("end"),this.record={number:e,name:this.info},this.changeCssStyle(),void dump("callscreen updateCallNumber 5"+t.textContent);this.photoItem.setAttribute("dir","auto"),"connected"!==this.call.state&&this.lookupContact(void 0),Contacts.findByNumber(e,this.lookupContact.bind(this)),this.checkICCMessage()}dump("callscreen updateCallNumber 6"+t.textContent),this.changeCssStyle()},HandledCall.prototype.changeCssStyle=function(){var e=this.numberNode.offsetWidth,t=this.numberNode.parentNode.offsetWidth;dump("callscreen add marquee boxSize "+t+" textSize "+e),t<e&&(this.numberNode.parentNode.style.width=e+"px",this.numberNode.parentNode.classList.add("animationMarquee"))},HandledCall.prototype.checkICCMessage=function(){SettingsObserver.getValue("icc.callmessage").then(e=>{this.iccCallMessage=e,this.iccCallMessage&&("string"==typeof this.iccCallMessage?(this.replacePhoneNumber(this.iccCallMessage,"end"),this.cachedInfo=this.iccCallMessage):(this.iccCallMessage.blob&&(this.iccMessageBlobURL=URL.createObjectURL(this.iccCallMessage.blob),this.numberNode.style.backgroundImage=`url(${this.iccMessageBlobURL})`,this.numberNode.style.backgroundRepeat="no-repeat"),this.iccCallMessage.callMessage&&(this.replacePhoneNumber(this.iccCallMessage.callMessage,"end"),this.cachedInfo=this.iccCallMessage.callMessage),this.iccCallMessage.blob&&!this.iccCallMessage.callMessage&&(this.numberNode.style.color="white")),SettingsObserver.setValue([{name:"screen.brightness",value:null}]),dump("callscreen checkICCMessage"+this.numberNode.textContent),this.changeCssStyle())})},HandledCall.prototype.lookupContact=function(i,n){if(!this.iccCallMessage){var{number:s}=this.call.id;const l=this.numberNode;let e=s,t=!1;if(i&&(i.name?(e=i.name,t=!0):i.email&&i.email.value&&(e=i.email.value,t=!0)),CallsHandler.setCNAPText(this.call,this.additionalTelNode,this.numberNode)&&void 0!==i&&!t)return this.info=this.numberNode.textContent,this.record={number:s,name:this.info},this.cachedInfo=this.numberNode.textContent,this.node.classList.add("additionalInfo"),void this.changeCssStyle();i?(e?(l.textContent=e,this.cachedInfo=e):(this.cachedInfo=this._("unknown"),l.textContent=this.cachedInfo),this.info=this.cachedInfo,this.cachedAdditionalTel=n.value,this.cachedAdditionalTelType=Utils.getPhoneNumberAdditionalInfo(n),this.replaceAdditionalContactInfo(this.cachedAdditionalTel,this.cachedAdditionalTelType),this.formatPhoneNumber("end"),this.record={number:s,name:this.info},this.changeCssStyle(),256!==CallScreen.memOnDevice()&&(i=Contacts.getPhoto(i),this.photo?CallScreen.updateCallsDisplay():i&&(this.photo=i,this.blobURL&&(URL.revokeObjectURL(this.blobURL),this.blobURL=null),PhotoResize.resize(i,this.photoItem).then(e=>{this.blobURL=URL.createObjectURL(e),this.photoItem.style.backgroundImage=`url(${this.blobURL})`,this.photoItem.setAttribute("data-icon","")}),CallScreen.updateCallsDisplay()))):(this.info=s,this.cachedInfo=s,l.textContent=this.cachedInfo,this.record={number:s,name:""},this.cachedAdditionalTel=this._("unknown"),this.cachedAdditionalTelType="",this.replaceAdditionalContactInfo(this.cachedAdditionalTel,this.cachedAdditionalTelType),this.formatPhoneNumber("end"),this.changeCssStyle())}},HandledCall.prototype.replaceAdditionalContactInfo=function(e,t){!e&&!t||""===e.trim()&&""===t.trim()?(this.additionalTelNode.textContent="",this.additionalTelTypeNode.textContent="",this.node.classList.remove("additionalInfo")):(e===this._("emergencyNumber")?this.additionalTelNode.textContent=e:this.additionalTelNode.textContent=e.replace(/\s/gu,""),this.additionalTelTypeNode.textContent=t,this.node.classList.add("additionalInfo"))},HandledCall.prototype.formatPhoneNumber=function(t){if(!this.removed)if(this.call.group)this.dialNumberNode.style="";else{let e=CallScreen.getScenario();e===FontSizeManager.CALL_WAITING&&"incoming"===this.call.state&&CallScreen.incomingContainer.classList.contains("displayed")&&(e=FontSizeManager.SECOND_INCOMING_CALL),FontSizeManager.adaptToSpace({scenario:e,view:this.dialNumberOuterNode,forceMaxFontSize:!1,ellipsisSide:t}),this.node.classList.contains("additionalInfo")?FontSizeManager.ensureFixedBaseline(e,this.dialNumberNode):FontSizeManager.resetFixedBaseline(this.dialNumberNode)}},HandledCall.prototype.replacePhoneNumber=function(e,t){this.numberNode.textContent=e,dump("callscreen replacePhoneNumber "+e),e.length?this.numberNode.parentNode.style.display="block":this.numberNode.parentNode.style.display="none",this.formatPhoneNumber(t),this.changeCssStyle()},HandledCall.prototype.updateDirection=function(){const{classList:e}=this.node;"incoming"===this.initialState?(e.add("incoming"),this.node.setAttribute("aria-label",this._("incoming"))):(this.outgoing=!0,e.add("outgoing"),e.contains("connected")||e.add("connecting"),this.node.setAttribute("aria-label",this._("outgoing"))),"connected"===this.call.state&&e.add("ongoing");var{call:t}=this,t=CallScreen.getSimNum(t);const i=this.node.querySelector(".status-icon");""===t?delete i.dataset.index:i.dataset.index=t,CallsHandler.isVideoCall()?e.add("video-call"):e.remove("video-call")},HandledCall.prototype.updateRttMode=function(){this.node.classList.toggle("rtt-mode","full"===this.call.rttMode),"full"!==this.call.rttMode||"connected"!==this.call.state||this.rttViewAdded||(Rtt.addRttView(this.call,this.cachedInfo,this.durationChildNode),this.rttViewAdded=!0),this.rttMode!==this.call.rttMode&&(this.rttMode=this.call.rttMode,!this.rttMode&&this.call.emergency&&CallScreen.showConfirmDialog({title:{id:"rtt",args:{}},body:{id:"rtt-emegency-downgrade"},accept:{name:"ok",l10nId:"ok",priority:2}}))},HandledCall.prototype.remove=function(){if(this.removed=!0,this.call.removeEventListener("statechange",this),this.photo=null,CallScreen.supportVT()){const{videoCallProvider:n}=this.call;n.onsessionmodifyresponse=null,n.onsessionmodifyrequest=null}this.blobURL&&(URL.revokeObjectURL(this.blobURL),this.blobURL=null),this.iccMessageBlobURL&&(URL.revokeObjectURL(this.iccMessageBlobURL),this.iccMessageBlobURL=null);var e=ConferenceGroupUI.isGroupDetailsShown()?ConferenceGroupHandler.currentDuration:this.durationNode.dataset.duration,t=e||"";this.node.classList.add("ended"),CallScreen.stopTicker(this.durationNode),document.body.classList.contains("single-line")&&(this.durationNode.classList.remove("isTimer"),""===t?this.durationChildNode.textContent=this._("callEnded"):Utils.prettyDuration(this.durationChildNode,+e,"callEndedDuration"));let i=CallsHandler.isAnyOpenCalls?CallScreen.callEndPromptTime:CallScreen.callNodeHideTime;CallsHandler.isInConferenceCall(this.call.id.number)&&(i=0),setTimeout(()=>{CallScreen.removeCall(this.node),this.node=null},i)},HandledCall.prototype.connected=function(){this.show(),this.node.classList.remove("held"),this.node.classList.remove("connecting"),this.node.classList.add("connected"),this.durationNode.classList.remove("isHeld"),this.showStirIndicator(!1),this.updateDirection(),CallScreen.rendVoWifiQuality(this.durationNode.parentNode,!0),CallScreen.createTicker(this.durationNode);var{duration:e}=this.durationNode.dataset;e&&document.body.classList.contains("single-line")&&Utils.prettyDuration(this.durationChildNode,+e),this.updateCallNumber(),this.wasConnected=!0},HandledCall.prototype.held=function(){this.durationNode.classList.add("isHeld");var{duration:e}=this.durationNode.dataset;e&&document.body.classList.contains("single-line")&&Utils.prettyDuration(this.durationChildNode,+e,"callHeldDuration"),CallScreen.rendVoWifiQuality(this.durationNode.parentNode,!1)},HandledCall.prototype.disconnected=function(){this.leftGroup&&(CallScreen.showToast({messageL10nId:"call-left-conference-toast",title:this.cachedInfo.toString()}),this.leftGroup=!1),this.wasConnected&&TonePlayer.playSequence([[480,620,250]]),this.wasConnected=!1,this.remove(),this.showRecIndicator(!1),this.showStirIndicator(!1),this.rttViewAdded&&Rtt.removeRttView(this.call)},HandledCall.prototype.show=function(){this.node&&(this.node.hidden=!1),CallScreen.updateCallsDisplay()},HandledCall.prototype.hide=function(){this.node&&(this.node.hidden=!0),CallScreen.updateCallsDisplay()},HandledCall.prototype.showRecIndicator=function(e){CallScreen.showRecIndicator(this.node,e)},HandledCall.prototype.showStirIndicator=function(e){this.stirContainer.classList.toggle("hide",!e),this.stirChecked.classList.toggle("hide",!e)},HandledCall.prototype.getStartTime=function(){return this.durationNode.dataset.startTime},HandledCall.prototype.getRecord=function(){return this.record},window.HandledCall=HandledCall;