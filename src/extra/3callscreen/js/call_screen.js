!function(e){const s={screenWakeLock:null,screenWakeLockCount:0,hasVolumeKey:!0,hasEndCallKey:!0,hasCameraKey:!1,vilteCapability:!1,hardwareMem:null,isAdjustingVolume:!1,volumeTimer:null,activity:null,wfcAlertTone:null,wfcDialogTime:0,dialog:null,checkdialog:null,_:window.api.l10n.get,arrowLeftKeyDown:!1,minWfcRemindInterval:1e4,qwertyKeyMapping:{w:"1",e:"2",r:"3",s:"4",d:"5",f:"6",z:"7",x:"8",c:"9",",":"0",o:"+",a:"*",q:"#"},lastInputTime:null,callEndPromptTime:1e3,callNodeHideTime:1100,body:document.body,screen:document.getElementById("call-screen"),calls:document.getElementById("calls"),blobURL:null,contactBackground:document.getElementById("contact-background"),bluetoothMenu:document.getElementById("bluetooth-menu"),switchToDeviceButton:document.getElementById("btmenu-btdevice"),switchToReceiverButton:document.getElementById("btmenu-receiver"),switchToSpeakerButton:document.getElementById("btmenu-speaker"),replyMenu:document.getElementById("reply-menu"),addCallMenu:document.getElementById("add-call-menu"),incomingContainer:document.getElementById("incoming-container"),incomingInfo:document.getElementById("incoming-info"),incomingNumber:document.getElementById("incoming-number"),incomingNumberAdditionalTel:document.getElementById("incoming-number-additional-info-tel"),incomingNumberAdditionalTelType:document.getElementById("incoming-number-additional-info-tel-type"),incomingHdIcon:document.getElementById("incoming-container").querySelector(".hd-icon"),incomingStirChecked:document.getElementById("incoming-container").querySelector(".stir-checked"),dialNumberOuterNode:document.getElementById("dialing-info"),dialNumberNode:document.querySelector("#dialing-number bdi"),translateKey(e){return this.qwertyKeyMapping[e]||e},updateCallScreenMode(e){this.calls.setAttribute("show-mode",e)},updateCallsDisplay(){CallScreenHelper.render();var e=this.calls.querySelectorAll("section:not([hidden])").length-1;this.body.classList.toggle("single-line",e<=1),this.calls.classList.toggle("big-duration",e<=1)},updateHeldDisplay(){const e=this.calls.querySelector(".isHeld");if(e){var t=this.calls.getAttribute("show-mode"),{duration:l}=e.dataset;const i=e.querySelector("span");"max-mode"===t?Utils.prettyDuration(i,+l,"callHeldDuration"):i.textContent=this._("hold")}},updateCallsMuteState(){this.calls.classList.toggle("mute",CallsHandler.isMute)},hideDtmfNumber(){"block"===this.dialNumberOuterNode.style.display&&(this.dialNumberNode.textContent="",DtmfHelper.dtmfNumber="",this.dialNumberOuterNode.style.display=""),CallScreenHelper.render()},showDtmfNumber(e){CallsHandler.canShowDtmfScreen?e.length?(this.dialNumberNode.textContent=e,this.dialNumberOuterNode.style.display="block",CallScreenHelper.showDtmfScreenOption(),FontSizeManager.adaptToSpace({scenario:FontSizeManager.SINGLE_CALL,view:this.dialNumberNode,forceMaxFontSize:!1,ellipsisSide:"begin"})):this.hideDtmfNumber():DtmfHelper.dtmfNumber=""},isDtmfNumberShown(){return""!==DtmfHelper.dtmfNumber},keydownHandler(e){if(!Rtt.isRttViewShown())switch(this.translateKey(e.key)){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":CallsHandler.isShowInfo||(CallsHandler.toggleShowInfo(),CallsHandler.handleCallInfoTimer(!0),e.preventDefault(),e.stopPropagation());case"#":case"*":OptionHelper.softkeyPanel&&OptionHelper.softkeyPanel.menuVisible&&OptionHelper.softkeyPanel.hideMenu();break;case"Call":{const t=document.getElementById("calls");CallsHandler.getCall("incoming")?CallsHandler.answer():"list-mode"!==t.getAttribute("show-mode")||DialerHelper.isDialerHelperShown()||CallsHandler.toggleCalls();break}case"EndCall":s.bluetoothMenu.classList.contains("display")&&s.toggleBluetoothMenu(!1),s.isDtmfNumberShown()&&s.hideDtmfNumber(),e.preventDefault(),e.stopPropagation(),CallsHandler.end();break;case"BrowserBack":case"Backspace":if(s.bluetoothMenu.classList.contains("display"))s.toggleBluetoothMenu(!1);else if(this.replyMenu.classList.contains("display"))s.toggleReplyMenu(!1);else if(this.addCallMenu.classList.contains("display"))s.toggleAddCallMenu(!1);else if(ConferenceGroupUI.isGroupDetailsShown())ConferenceGroupUI.hideGroupDetails();else if(!NavigationMap.menuIsActive&&!s.isAdjustingVolume){if(s.hasEndCallKey&&DialerHelper.isDialerHelperShown())return;s.isDtmfNumberShown()&&s.hideDtmfNumber(),s.hasEndCallKey||CallsHandler.end()}e.preventDefault(),e.stopPropagation();break;case"ArrowUp":{const l=document.querySelector("#option-menu");l&&!l.classList.contains("visible")&&(e.preventDefault(),e.stopPropagation()),s.requestVolume("up");break}case"ArrowDown":{const i=document.querySelector("#option-menu");i&&!i.classList.contains("visible")&&(e.preventDefault(),e.stopPropagation()),s.requestVolume("down");break}case"ArrowRight":DialerHelper.isDialerHelperShown()||"inCallTwoLinesParams"!==OptionHelper.getLastParamName()&&"inCallEndAndAnswerParams"!==OptionHelper.getLastParamName()||(DialerHelper.showDialerHelper(),CallScreenHelper.showDialerHelperCommandModeOption());break;case"ArrowLeft":DialerHelper.isDialerHelperShown()||this.arrowLeftKeyDown||(this.arrowLeftKeyDown=!0,this.hasCameraKey||CallRecording.manualCallRec());break;case"Camera":CallRecording.manualCallRec();break;case"HeadsetHook":CallsHandler.getCall("incoming")?CallsHandler.answer():CallsHandler.end();break;case"AudioVolumeUp":case"AudioVolumeDown":this.getNowTime()-this.lastInputTime<500&&CallsHandler.getCall("incoming")&&CallsHandler.end(),this.lastInputTime=this.getNowTime()}},getNowTime(){return new Date},keyupHandler(e){switch(e.key){case"Camera":e.preventDefault();break;case"ArrowLeft":this.arrowLeftKeyDown=!1}},keypressHandler(e){"Enter"===e.key&&e.preventDefault()},init(){if(window.addEventListener("keydown",this.keydownHandler.bind(this),!0),window.addEventListener("keyup",this.keyupHandler.bind(this)),window.addEventListener("keypress",this.keypressHandler),DeviceCapabilityManager.get("device.key.volume").then(e=>{this.hasVolumeKey=!!e}),DeviceCapabilityManager.get("device.key.endcall").then(e=>{this.hasEndCallKey=!!e}),DeviceCapabilityManager.get("device.key.camera").then(e=>{this.hasCameraKey=!!e}),DeviceCapabilityManager.get("device.vilte").then(e=>{this.vilteCapability=e}),DeviceCapabilityManager.get("hardware.memory").then(e=>{this.hardwareMem=e}),this.switchToDeviceButton.click=()=>{this.switchToDefaultOut(!1),this.showToast({messageL10nId:"switch-to-device-toast"})},this.switchToReceiverButton.click=()=>{CallsHandler.enableSpeaker=!1,this.switchToReceiver(),this.showToast({messageL10nId:"switch-to-handset-toast"})},this.switchToSpeakerButton.click=()=>{CallsHandler.enableSpeaker=!0,this.switchToSpeaker(),this.showToast({messageL10nId:"switch-to-speaker-toast"})},this.isMultiSIM()){var t=navigator.b2g.mobileConnections;for(let e=0;e<t.length;e++){const l=t[e];l&&l.imsHandler&&l.imsHandler.addEventListener("capabilitychange",this.updateCapability.bind(this))}}},showToast(e){Toaster.showToast(e)},insertCall(e){var t;"undefined"!=typeof CallScreenHelper&&(CallScreenHelper.render(),t=document.getElementById("handled-call-template"),this.calls.insertBefore(e,t),this.updateCallsDisplay()),this.updateCapability()},removeCall(e){CallScreenHelper.render(),e.parentNode&&(e.parentNode.removeChild(e),this.updateCallsDisplay())},launchMore(){const e=new WebActivity("pick",{type:["webcontacts/tel","calllog/tel"]});this.activity=e,e.start().then(e=>{e&&e.tel&&e.tel[0]&&e.tel[0].value?(CallsHandler.dial(e.tel[0].value),DialerHelper.hideDialerHelper()):DialerHelper.focus(),this.activity=null,CallsHandler.enableScreenDimFeature(!0)},()=>{this.activity=null,CallsHandler.enableScreenDimFeature(!0),DialerHelper.focus()}),CallsHandler.enableScreenDimFeature(!1)},cancelActivity(){this.activity&&(this.activity.cancel(),this.activity=null)},launchMessages(){if(dump("call_screen launchMessages "),LockScreen.isScreenLocked())return dump("call_screen isScreenLocked: true"),void this.showToast({messageL10nId:"oemLockscreenLaunchMessagesError"});const e=new WebActivity("latest-message");e.start(),this.activity=e},toggleBluetoothMenu(e){if("boolean"==typeof e?this.bluetoothMenu.classList.toggle("display",e):this.bluetoothMenu.classList.toggle("display"),this.bluetoothMenu.classList.contains("display")){CallScreenHelper.showMenuDialogOptions();let e=0;CallsHandler.isBtConnected?this.switchToDeviceButton.classList.toggle("selected",!0):!1===window.navigator.b2g.telephony.speakerEnabled?(this.switchToReceiverButton.classList.toggle("selected",!0),e=1):!0===window.navigator.b2g.telephony.speakerEnabled&&(this.switchToSpeakerButton.classList.toggle("selected",!0),e=2),NavigationManager.reset("#bluetooth-menu .option-item",e)}else{const t=document.getElementById("group-call-details"),l=document.getElementById("dialer-helper");t&&t.classList.contains("display")||l&&l.classList.contains("display")||this.activity||(document.activeElement.classList.contains("option-item")&&document.activeElement.blur(),Rtt.isRttViewShown()?this.showRttView():CallScreenHelper.render(),this.switchToDeviceButton.classList.toggle("selected",!1),this.switchToReceiverButton.classList.toggle("selected",!1),this.switchToSpeakerButton.classList.toggle("selected",!1))}},toggleReplyMenu(e){this.replyMenu.classList.toggle("display",e),e?(CallScreenHelper.showMenuDialogOptions(),NavigationManager.reset("#reply-menu .option-item",0)):(document.activeElement.classList.contains("option-item")&&document.activeElement.blur(),CallScreenHelper.render())},replyItemSelected(){var e=this.replyMenu.querySelector(".focus");if(e){const{number:t}=CallsHandler.incomingCall.call.id;e.id&&"reply-custom"===e.id?setTimeout(()=>{const e=new WebActivity("new",{type:"websms/sms",number:t,from:"callscreen"});e.start()},this.callEndPromptTime):CallsHandler.replyMessage(e.textContent),CallsHandler.end()}},toggleAddCallMenu:function(e){this.addCallMenu.classList.toggle("display",e),e?(CallScreenHelper.showAddCallDialogOptions(),NavigationManager.reset("#add-call-menu .option-item",0)):(document.activeElement.classList.contains("option-item")&&document.activeElement.blur(),CallScreenHelper.render())},addCallItemSelected:function(){var e=this.addCallMenu.querySelector(".focus");e&&(this.toggleAddCallMenu(!1),e.id&&"rtt-call"===e.id?(localStorage.setItem("make_rtt_call",!0),dump("call I am rtt-call!1!!!!")):(localStorage.setItem("make_rtt_call",!1),dump("call I am voicecall!!!!!")),LockScreen.isScreenLocked()?LockScreen.showLockScreen(!0):this.placeNewCall())},isBtMenuDisplayed(){return this.bluetoothMenu.classList.contains("display")},switchToSpeaker(){CallsHandler.switchToSpeaker(),this.toggleBluetoothMenu(!1)},switchToReceiver(){CallsHandler.switchToReceiver(),this.toggleBluetoothMenu(!1)},switchToDefaultOut(e){CallsHandler.switchToDefaultOut(e),this.toggleBluetoothMenu(!1)},setBTReceiverIcon(e){OptionHelper.getLastParamName()&&(OptionHelper.swapParams(OptionHelper.getLastParamName()),e||this.toggleBluetoothMenu(!1))},placeNewCall(){DialerHelper.showDialerHelper(),CallScreenHelper.showDialerHelperOption()},showIncoming(){this.body.classList.remove("showKeypad"),this.incomingContainer.classList.add("displayed");const t=document.querySelectorAll(".handled-call");for(let e=0;e<t.length;e++)t[e].classList.add("fadeout");CallScreenHelper.render(),this.lockScreenWake()},hideIncoming(){this.incomingContainer.classList.remove("displayed");const t=document.querySelectorAll(".handled-call");for(let e=0;e<t.length;e++)t[e].classList.remove("fadeout");CallScreenHelper.render(),this.unlockScreenWake()},incomingEnded(){this.incomingInfo.classList.add("ended"),this.incomingNumberAdditionalTelType.textContent="",this.incomingNumberAdditionalTel.textContent=this._("callEnded"),setTimeout(()=>{this.hideIncoming()},this.callEndPromptTime)},handleCallWaitingScreen(){let e=!1;this.incomingContainer.classList.contains("displayed")&&"list-mode"===this.calls.getAttribute("show-mode")&&(e=!0),s.showListModeCallWaiting(e)},showListModeCallWaiting(e){e?this.screen.classList.add("list-mode-call-waiting"):this.screen.classList.remove("list-mode-call-waiting")},lockScreenWake(){this.screenWakeLockCount++,this.screenWakeLock||(this.screenWakeLock=navigator.b2g.requestWakeLock("screen"))},unlockScreenWake(){this.screenWakeLockCount&&this.screenWakeLockCount--,this.screenWakeLock&&!this.screenWakeLockCount&&(this.screenWakeLock.unlock(),this.screenWakeLock=null)},rendVoWifiQuality(e,t){const l=e.querySelector(".wifi-call-quality-container");var{active:i}=CallScreenHelper.telephony;let a=i&&i.vowifiQuality;if(void 0===a&&(a=i&&i.calls&&i.calls[0]&&i.calls[0].vowifiQuality),t&&a&&"none"!==a){e.classList.add("wifi-call");const s=l.querySelector(".quality-content"),n=l.querySelector(".quality-dot");s.setAttribute("data-l10n-id",`wifi-call-quality-${a}`),n.setAttribute("data-quality",a),l.classList.remove("hide")}else l.classList.add("hide"),e.classList.remove("wifi-call")},showRecIndicator(e,t){const l=e.querySelectorAll(".call-recording-container");let i=0;if(t)for(e.classList.add("show-rec"),i=0;i<l.length;i++)l[i].classList.remove("hide");else for(e.classList.remove("show-rec"),i=0;i<l.length;i++)l[i].classList.add("hide")},createTicker(t,l){const i=t.querySelector("span");if(t.dataset.tickerId)return!1;t.classList.add("isTimer"),void 0===l&&(l=Date.now()),t.dataset.startTime=l;let a=1e3*Math.round((Date.now()-l)/1e3);Utils.prettyDuration(i,a);var e=setInterval(()=>{a=1e3*Math.round((Date.now()-l)/1e3),t.dataset.duration=a,t.classList.contains("isHeld")?1===this.getNodeNum()?Utils.prettyDuration(i,a,"callHeldDuration"):i.textContent=this._("hold"):Utils.prettyDuration(i,a);var e=t.parentNode;s.rendVoWifiQuality(e,void 0!==a)},1e3,Date.now());return t.dataset.tickerId=e,!0},stopTicker(e){e.classList.remove("isTimer"),clearInterval(e.dataset.tickerId),delete e.dataset.tickerId,delete e.dataset.startTime,delete e.dataset.duration},requestVolume(e){if(s.isVolumeRequestNeeded(e)&&AudioVolumeManager){switch(e){case"up":AudioVolumeManager.requestVolumeUp();break;case"down":AudioVolumeManager.requestVolumeDown();break;case"show":AudioVolumeManager.requestVolumeShow();break;default:return}this.isAdjustingVolume=!0,clearTimeout(this.volumeTimer),this.volumeTimer=setTimeout(()=>{this.isAdjustingVolume=!1},2e3)}},isVolumeRequestNeeded(e){return!(this.hasVolumeKey||s.bluetoothMenu.classList.contains("display")||s.replyMenu.classList.contains("display")||ConferenceGroupUI.isGroupDetailsShown()||NavigationMap.menuIsActive&&"show"!==e||this.isConfirmDialogShown()||1===CallsHandler.openLines()&&CallsHandler.getCall("incoming"))},showMainCallscreen(){DialerHelper.isDialerHelperShown()&&DialerHelper.hideDialerHelper(),LockScreen.isLockScreenShown()&&LockScreen.showLockScreen(!1),this.isConfirmDialogShown()&&(this.closeConfirmDialog(),this.wfcDialogTime=new Date),this.isDtmfNumberShown()&&this.hideDtmfNumber(),OptionHelper.softkeyPanel&&OptionHelper.softkeyPanel.menuVisible&&OptionHelper.softkeyPanel.hideMenu(),this.bluetoothMenu.classList.contains("display")&&this.toggleBluetoothMenu(!1),this.replyMenu.classList.contains("display")&&this.toggleReplyMenu(!1),this.addCallMenu.classList.contains("display")&&this.toggleAddCallMenu(!1),ConferenceGroupUI.isGroupDetailsShown()&&ConferenceGroupUI.hideGroupDetails(),this.cancelActivity(),Rtt.hideRttView()},isEndCallKeyExisted(){return this.hasEndCallKey},supportVT(){return this.vilteCapability},memOnDevice(){return this.hardwareMem},remindBadWfc(){var e;this.wfcAlertTone||(this.wfcAlertTone=!0,TonePlayer.playSequence([[480,620,250]])),this.isConfirmDialogShown()||new Date-this.wfcDialogTime>=this.minWfcRemindInterval&&(e=`${this._("wifi-calling-1")} ${this._("wifi-calling-2")}`,this.showConfirmDialog({title:{id:"wifi-calling",args:{}},body:{text:e},accept:{name:"ok",l10nId:"ok",priority:2,callback(){s.wfcDialogTime=new Date}}}))},showConfirmDialog(e){this.closeConfirmDialog(),this.activity&&DialerHelper.isDialerHelperShown()&&DialerHelper.hideDialerHelper(),LazyLoader.load(["http://shared.localhost/js/helper/dialog/confirm_dialog_helper.js"],()=>{this.dialog=new ConfirmDialogHelper(e),this.dialog.show(document.getElementById("vt-confirmation-dialog"))})},closeConfirmDialog(){this.dialog&&this.dialog.close(),this.dialog=null},isConfirmDialogShown(){return!(!this.dialog||!this.dialog.isShown)},showCheckDialog:function(e){dump("call_screen:showCheckDialog"),this.closeCheckDialog(),this._activity&&DialerHelper.isDialerHelperShown()&&DialerHelper.hideDialerHelper(),LazyLoader.load(["js/check_dialog_helper.js"],()=>{this.checkdialog=new CheckDialogHelper(e),this.checkdialog.show(document.getElementById("rttmerge-check-dialog"))})},closeCheckDialog:function(){this.isCheckDialogShown()&&(dump("call_screen:closeCheckDialog, checkdialog is not null"),this.checkdialog.close()),this.checkdialog=null},isCheckDialogShown:function(){return this.checkdialog&&this.checkdialog.isShown},resetWfcRemind(){this.wfcAlertTone=!1,this.wfcDialogTime=0},getScenario(){let e=null;return e=this.body.classList.contains("single-line")?FontSizeManager.SINGLE_CALL:FontSizeManager.CALL_WAITING,e},handleCallError(e,t){let l="",i="";dump("call_screen:handleCallError, errorName: "+e),i="BadNumber"===e?(l="invalidNumberToDialTitle","invalidNumberToDialMessage"):"FDNBlocked"===e||"FdnCheckFailure"===e?(l="fdnIsActiveTitle","fdnIsActiveMessage"):"SipForbidden"===e?(l="CallFailed","call-server-error-vzw"):"CallFailed";t={title:{id:l,args:{}},body:{id:i,args:{number:t}},accept:{name:"ok",l10nId:"ok",priority:2,callback(){s.wfcDialogTime=new Date}}};this.showConfirmDialog(t)},showRttView(){Rtt.showRttView(),CallScreenHelper.showRttViewOption()},isMultiSIM(){return!!(navigator.b2g.iccManager&&1<navigator.b2g.iccManager.iccIds.length)},getSimNum(e){let t="";return e&&void 0!==e.serviceId&&this.isMultiSIM()&&(t=`-sim${parseInt(e.serviceId,10)+1}`),t},updateCapability(){if(this.isMultiSIM()){let t="";var{imsHandler:e}=navigator.b2g.mobileConnections[CallsHandler.serviceId];e&&("voice-over-wifi"!==e.capability&&"video-over-wifi"!==e.capability||e.unregisteredReason?"voice-over-cellular"!==e.capability&&"video-over-cellular"!==e.capability||e.unregisteredReason||(t="volte"):t="vowifi"),t=t&&`call-${t}-sim${parseInt(CallsHandler.serviceId,10)+1}`;var l=document.querySelectorAll(".status-icon");for(let e=0;e<l.length;e++){const i=l[e];t?i.dataset.ims=t:(i.classList.remove("ims"),delete i.dataset.ims)}}},getNodeNum(){return"max-mode"===this.calls.getAttribute("show-mode")?1:document.querySelectorAll(".handled-call:not([hidden])").length+!document.getElementById("group-call").hidden}};e.CallScreen=s}(window);