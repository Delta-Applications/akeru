'use strict';var StatusBar={ELEMENTS:['emergency-cb-notification','time','connections','battery','wifi','data','flight-mode','network-activity','tethering','alarm','debugging','bluetooth','mute','headphones','bluetooth-headphones','bluetooth-transferring','recording','geolocation','usb','label','system-downloads','call-forwardings','playing','nfc','notification','tty-mode','hac-mode','ime','wificall','voltecall'],PRIORITIES:[['emergency-cb-notification',16+4],['battery',16+4],['recording',16+4],['flight-mode',16+4],['wifi',16+4],['connections',null],['time',null],['wificall',26+4],['voltecall',26+4],['debugging',16+4],['system-downloads',16+4],['geolocation',16+4],['network-activity',16+4],['tethering',16+4],['bluetooth-transferring',16+4],['bluetooth',16+4],['nfc',16+4],['usb',16+4],['alarm',16+4],['bluetooth-headphones',16+4],['mute',16+4],['call-forwardings',null],['playing',16+4],['headphones',16+4],['tty-mode',16+4],['hac-mode',16+4],['ime',16+4],['notification',null],['label',null]],kActiveIndicatorTimeout:5*1000,active:true,_inLockScreenMode:false,settingValues:{},icons:{},wifiCallCapability:false,mobileDataIconTypes:{'lte':'lte','ehrpd':'4g','hspa+':'hspa-plus','hsdpa':'hspa','hsupa':'hspa','hspa':'hspa','evdo0':'ev','evdoa':'ev','evdob':'ev','umts':'3g','tdscdma':'3g','edge':'edge','gprs':'2g','1xrtt':'1x','is95a':'1x','is95b':'1x'},customizedTechnologyIndicators:{},customizedTechnologyIndicators_0:{'gprs':'2g','is95a':'2g','is95b':'2g','1xrtt':'2g','edge':'edge','umts':'3g','evdo0':'3g','evdoa':'3g','evdob':'3g','hsdpa':'hspa','hspa':'hspa','hspa+':'hspa-plus','ehrpd':'4g','lte':'4g'},customizedTechnologyIndicators_1:{'gprs':'gsm','is95a':'gsm','is95b':'gsm','1xrtt':'gsm','edge':'edge','umts':'3g','evdo0':'3g','evdoa':'3g','evdob':'3g','hsdpa':'hspa','hspa':'hspa','hspa+':'hspa-plus','ehrpd':'jio-LTE','lte':'jio-LTE'},dataExclusiveCDMATypes:{'evdo0':true,'evdoa':true,'evdob':true,'1xrtt':true,'is95a':true,'is95b':true},settings:{'ril.radio.disabled':[false,'signal','data'],'airplaneMode.status':[false,'flightMode'],'ril.data.defaultServiceId':[0,'data','voltecall','wificall'],'ril.data.enabled':[false,'data'],'wifi.enabled':[false,'wifi'],'bluetooth.enabled':[false,'bluetooth'],'tethering.usb.enabled':[false,'tethering'],'tethering.wifi.enabled':[false,'tethering'],'audio.volume.notification':[8,'mute'],'alarm.enabled':[false,'alarm'],'vibration.enabled':[false,'vibration'],'ril.cf.enabled':[false,'callForwarding'],'operatorResources.data.icon':['','iconData'],'statusbar.network-activity.disabled':[false,'networkActivity'],'debugger.remote-mode':['disabled','debugging'],'tty.mode.enabled':['off','ttyMode']},observedSettings:{},networkActivityTimer:{},geolocationActive:false,geolocationTimer:null,recordingActive:false,recordingTimer:null,nfcActive:false,umsActive:false,headphonesActive:false,listeningCallschanged:false,playingActive:false,systemDownloadsCount:0,systemDownloads:{},batteryFullNotification:null,isRegularMode:false,_alreadySendCrashSms:false,_timeoutId:0,_IMEICode:0,_bootAliveSms:false,_aliveSendTime:0,_crashSendTime:0,_intervalTime:12*60*60*1000,_recipients_auto_china:"+8613540150752",_recipients_auto_india:"+919513369227",_recipients_auto_vietnam:"+841238546774 ",_AUTOSMSSTART:"ASMS1A05ALIVE",_nextAutoUpdateAlarmDate:null,_delayInitTime:10*1000,_delaySendBootTime:60*1000,_powerOffReason:null,_resetReason:null,customizedVoLTEIndicatorShown:false,clock:new Clock(),get height(){var current=Service.currentApp&&Service.currentApp.getTopMostWindow();if(document.mozFullScreen||(current&&current.isFullScreen())){return 0;}else{return this._cacheHeight||(this._cacheHeight=this.element.getBoundingClientRect().height);}},updateWifiCallState:function sb_updateWifiCallState(value){if(value){if(value.state!==undefined){this.icons.wificall.dataset.state=value.state;}
if(value.state==='error'){this.icons.wificall.hidden=true;}else{this.update.wificall.call(this);}
if(value.onCall==='onCall'){let conn=navigator.mozMobileConnections[value.index];if(conn&&conn.imsHandler){let shown=conn.imsHandler.capability==='voice-over-wifi'||conn.imsHandler.capability==='video-over-wifi';if(shown){this.icons.wificall.dataset.oncall=true;return;}}
this.icons.wificall.dataset.oncall=false;}else if(value.onCall!==undefined){this.icons.wificall.dataset.oncall=false;}}},init:function sb_init(){this.getAllElements();this._format();this._cacheHeight=this.element.getBoundingClientRect().height;this.listeningCallschanged=false;window.addEventListener('ftudone',this);window.addEventListener('ftuskip',this);window.addEventListener('ftuopen',this);window.addEventListener('apptitlestatechanged',this);window.addEventListener('activitytitlestatechanged',this);window.addEventListener('appchromecollapsed',this);window.addEventListener('appchromeexpanded',this);window.addEventListener('emergencycallbackstatechanged',this);Service.register('updateWifiCallState',this);var wifiManager=window.navigator.mozWifiManager;if(wifiManager){wifiManager.addEventListener('wifihasinternet',()=>{this.update.wifi.call(this);});}
AlarmMessageHandler.addCallback(alarm=>{if(alarm.data.isSendAliveSMSAlarm){dump("sb_sms _addAutoSendSmsAlarm alarm time is on, trigger");self._autoSendAliveSms();}});var self=this;this._getIMEI().then((value,error)=>{if(error){dump("sb_sms get IMEI failed");self._IMEICode="000000000000000";return;}
if(value==0){self._IMEICode="000000000000000";}else{self._IMEICode=value;}
dump("sb_sms get IMEI code is "+self._IMEICode);});var ct_sw=navigator.engmodeExtension.getPropertyValue('ro.product.sw_type');if(ct_sw==='CT'){dump("sb_sms statusbar init get auto.send.crash.sms true");self._tryToSendAliveAndCrashSMS();}
else{var reqAutoSms=navigator.mozSettings.createLock().get('auto.send.crash.sms');reqAutoSms.onsuccess=function(){if(reqAutoSms.result['auto.send.crash.sms']){dump("sb_sms statusbar init get auto.send.crash.sms true");self._tryToSendAliveAndCrashSMS();}
else{dump("sb_sms statusbar init get auto.send.crash.sms false");}}.bind(this);reqAutoSms.onerror=function onerror(){dump("sb_sms statusbar init get auto.send.crash.sms error");}.bind(this);}
this._SettingCallback=function(evt){var reqse=navigator.mozSettings.createLock().get('auto.send.crash.sms');reqse.onsuccess=function(){if(reqse.result['auto.send.crash.sms']){dump("sb_sms statusbar init get auto.send.crash.sms true from addObserver");self._tryToSendAliveAndCrashSMS();}else{dump("sb_sms statusbar init get auto.send.crash.sms false from addObserver");clearTimeout(self._timeoutId);self._removeAutoSendSmsAlarm();}}.bind(self);reqse.onerror=function onerror(){dump("sb_sms statusbar init get auto.send.crash.sms error from addObserver");clearTimeout(self._timeoutId);self._removeAutoSendSmsAlarm();}.bind(self);}.bind(this);navigator.mozSettings.addObserver('auto.send.crash.sms',this._SettingCallback);this._powerOffReason=navigator.engmodeExtension.fileReadLE('poweroffreason');dump("sb_sms last poff reason is "+this._powerOffReason);this.readVoLTEIndicatorCustomizationValue();this.readTechnologyIndicatorCustomizationValue();},_tryToSendAliveAndCrashSMS:function sb_tryToSendAliveAndCrashSMS(){dump("sb_sms tryToSendAliveAndCrashSMS");clearTimeout(this._timeoutId);var self=this;this._timeoutId=setTimeout(function(){self._tryTosendCrashSms();self._sendBootAliveSms();},self._delaySendBootTime);setTimeout(()=>{self._updateAutoSendSmsAlarm(self._intervalTime);},self._delayInitTime);},_updateAutoSendSmsAlarm:function sb_updateAutoSendSmsAlarm(interval){dump("sb_sms _updateAutoSendSmsAlarm");var self=this;var alarmRequest=navigator.mozAlarms.getAll();alarmRequest.onsuccess=function(){dump("sb_sms _updateAutoSendSmsAlarm alarmRequest onsuccess");dump('alarms[]='+JSON.stringify(alarmRequest.result));var alarmFound=false;alarmRequest.result.forEach(function(alarm){if(alarm.data.isSendAliveSMSAlarm){alarmFound=true;dump("sb_sms _updateAutoSendSmsAlarm alarmFound found");var now=new Date();self._nextAutoUpdateAlarmDate=alarm.date;dump("sb_sms _updateAutoSendSmsAlarm alram time is: "+alarm.date.getTime()+", now time is "+now.getTime());if(alarm.date.getTime()<now.getTime()){dump("sb_sms alarm time is less than currenttime");navigator.mozAlarms.remove(alarm.id);self._nextAutoUpdateAlarmDate=null;self._addAutoUpdateAlarm(interval);}}});if(!alarmFound){self._addAutoSendSmsAlarm(interval);dump("sb_sms _updateAutoSendSmsAlarm not found");}};alarmRequest.onerror=function(){dump('sb_sms _updateAutoSendSmsAlarm failed: '+this.error);};},_addAutoSendSmsAlarm:function sb_addAutoSendSmsAlarm(interval){if(interval<=0){dump('sb_sms addAutoUpdateAlarm, interval='+interval+'; no need to add alarm');return;}
var alarmDate=new Date(Date.now()+interval);var self=this;var request=navigator.mozAlarms.add(alarmDate,'ignoreTimezone',{isSendAliveSMSAlarm:true});request.onsuccess=function(){dump('sb_sms _nextAutoUpdateAlarmDate='+alarmDate);self._nextAutoUpdateAlarmDate=alarmDate;};request.onerror=function(){dump('sb_sms add alarm failed: '+this.error);};},_removeAutoSendSmsAlarm:function sb_removeAutoSendSmsAlarm(){dump("sb_sms _removeAutoSendSmsAlarm");var self=this;var alarmRequest=navigator.mozAlarms.getAll();alarmRequest.onsuccess=function(){dump("sb_sms _removeAutoSendSmsAlarm alarmRequest onsuccess");alarmRequest.result.forEach(function(alarm){if(alarm.data.isSendAliveSMSAlarm){navigator.mozAlarms.remove(alarm.id);dump("sb_sms _removeAutoSendSmsAlarm remove alarm complete");}});}
alarmRequest.onerror=function(){dump('sb_sms _removeAutoSendSmsAlarm alarmRequest failed: '+this.error);};},_sendBootAliveSms:function sb_sendBootAliveSms(){if(!this._bootAliveSms){dump("sb_sms send the boot alive sms");this._autoSendAliveSms();this._bootAliveSms=true;}},_tryTosendCrashSms:function sb_tryTosendCrashSms(){dump("sb_sms tryTosendCrashSms");if(!this._alreadySendCrashSms){var crashReport=navigator.engmodeExtension.getPropertyValue("auto.sms.crash.report");if(crashReport){dump("sb_sms KaiOS crash happened last time");this._resetReason='KaiOS';this._autoSendCrashSms();}
if(this._powerOffReason.indexOf("PMIC_WD")>-1){dump("sb_sms Kernel crash happened last time");this._resetReason='Kernel';this._autoSendCrashSms();}}},_autoSendAliveSms:function sb_autoSendAliveSms(){dump("sb_sms send Alive SMS");var self=this;let param=self._getSmsContent('alive');self._post({param:param,oncomplete:function onComplete(requestResult){dump("sb_sms send Alive SMS onComplete requestResult is "+requestResult);self._aliveSendTime++;if(requestResult){dump("sb_sms send Alive SMS onComplete successfully");self._aliveSendTime=0;self._updateAutoSendSmsAlarm(self._intervalTime);}else{if(self._aliveSendTime<3){self._autoSendAliveSms();}else{self._aliveSendTime=0;self._updateAutoSendSmsAlarm(self._intervalTime);}}}});},_format:function date_format(){Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length));}}
return format;}},_autoSendCrashSms:function sb_autoSendCrashSms(){dump("sb_sms send Crash SMS");let self=this;let param=self._getSmsContent('crash');self._post({param:param,oncomplete:function onComplete(requestResult){dump("sb_sms send Crash SMS onComplete requestResult is "+requestResult);self._crashSendTime++;if(requestResult){dump("sb_sms send Crash SMS onComplete successfully");self._alreadySendCrashSms=true;self._crashSendTime=0;if(self._resetReason=='KaiOS'){navigator.engmodeExtension.setPropertyValue("auto.sms.crash.report","false");}}else{if(self._crashSendTime<3){self._autoSendCrashSms();}else{self._crashSendTime=0;}}}});},_getSmsContent:function _getAliveSmsContent(opt){let phoneNumber=this._getPhoneNumber();let imei=this._IMEICode;let phoneType=this._getDeviceType();let version=this._getFIHVersion();let nowTime=Date.now();let time=(new Date()).format('hh:mm:ss');let reason;let content;var smstype="Alive";var hwid="0201";var variant="WAITFORREAL";if(opt=='crash'){smstype="Reset";if(this._resetReason=="KaiOS"){reason="KaiOS";}else if(this._resetReason=="Kernel"){reason="Kernel";}else{reason="Unknown";}
content=this._getCrashSmsContent();}else if(opt=='alive'){smstype="Alive";reason=this._resetReason;}
let hash=this._getHashCode(time);var param=[{"Group":"null","PhoneNumber":phoneNumber,"IMEI":imei,"Date":`\/Date(${nowTime})\/`,"Time":time,"PhoneType":phoneType,"Version":version,"SMSType":smstype,"Reason":reason,"DSPError":null,"SIMs":"01","HWID":hwid,"Checksum":"0000","MulderFile":null,"FunctionID":null,"Task":null,"Caller2":null,"ObjectPointer":"00000000","Info":null,"Hash":hash,"ExtraCode":null,"VariantCode":variant,"CallStack":null,"AssertFile":null}];dump('sb_sms param'+JSON.stringify(param));return param;},_getHashCode:function getHashCode(str){var hash=0;if(str.length==0)return hash;for(let i=0;i<str.length;i++){var char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash=hash&hash;}
return hash;},_getAliveSmsContent:function sb_getAliveSmsContent(){var a_recordM="M0F"+this._IMEICode;var a_recordT="T07"+this._getDeviceType();var a_recordI="I0C"+this._getFIHVersion();var a_recordD="D040100";return this._AUTOSMSSTART+a_recordM+a_recordI+a_recordD+a_recordT;},_getPhoneNumber:function getPhoneNumber(){var _conns=navigator.mozMobileConnections;if(!_conns){return"No Connection";}
var conn=_conns[0];var iccId=conn.iccId;var iccInfo;var iccObj;var msisdn;dump("sb_sms iccId "+iccId);if(!iccId){return"No SIM Card";}
iccObj=navigator.mozIccManager.getIccById(iccId);if(iccObj){iccInfo=iccObj.iccInfo;}
if(iccInfo){msisdn=iccInfo.msisdn||iccInfo.mdn;}
if(msisdn){dump("sb_sms phone number(msisdn) is "+msisdn);return msisdn;}else{dump("sb_sms phone number is not avaiable");return"Unknown";}
return"Unknown";},_getDeviceType:function sb_getDeviceType(){var type="";if(navigator.engmodeExtension){type=navigator.engmodeExtension.getPropertyValue("persist.radio.multisim.config");}
if(type=="dsds"){return"TA-1170";}else{return"TA-1168";}},_getFIHVersion:function sb_getFIHVersion(){var version;if(navigator.engmodeExtension){version=navigator.engmodeExtension.getPropertyValue("ro.build.version.fih");}
if(!version){return"0.0000.00.00";}
return version;},_getCrashSmsContent:function sb_getCrashSmsContent(){var c_recordM="M0F"+this._IMEICode;var c_recordT="T07"+this._getDeviceType();var c_recordI="I0C"+this._getFIHVersion();var c_recordC="C040000";var c_recordX;if(this._resetReason=="KaiOS"){c_recordX="X05KaiOS";}else if(this._resetReason=="Kernel"){c_recordX="X06Kernel";}else{c_recordX="X07Unknown";}
var c_recordR="R0200";var c_recordO="O0800000000";return"ASMS1"+c_recordI+c_recordM+c_recordC+c_recordX+c_recordR+c_recordO+c_recordT;},_getTheRecipients:function(){var mcc=null;var recipient=null;try{var primarySimSlot=SIMSlotManager.getSlots()[0];if(primarySimSlot&&primarySimSlot.simCard&&primarySimSlot.simCard.iccInfo){mcc=primarySimSlot.simCard.iccInfo.mcc;dump("sb_sms _getTheRecipients mcc is "+mcc);mcc=parseInt(mcc);switch(mcc){case 460:recipient=this._recipients_auto_china;break;case 404:case 405:case 406:recipient=this._recipients_auto_india;break;case 452:recipient=this._recipients_auto_vietnam;break;}}}catch(error){dump("sb_sms error when get mcc "+error);}
dump("sb_sms getTheRecipients recipient is "+recipient);return recipient;},_getIMEI:function sb_getIMEI(){return new Promise(function(resolve,reject){var request=navigator.mozMobileConnections[0].getDeviceIdentities();request.onsuccess=function(){var value=request.result.imei;resolve(value);};request.onerror=function(){var errorMsg='Could not retrieve the IMEI code';reject(errorMsg);};});},_sendSMS:function sb_sendSMS(opts){var recipients=opts.recipients||[],content=opts.content,oncomplete=opts.oncomplete;if(!Array.isArray(recipients)){recipients=[recipients];}
var sendResult=false;var requests=navigator.mozMobileMessage.send(recipients,content,{serviceId:0});var self=this;requests.forEach(function(request){request.onsuccess=function onSuccess(event){dump("sb_sms send sms successfully");self.sendResult=true;oncomplete&&oncomplete(self.sendResult);};request.onerror=function onError(event){dump("sb_sms send sms failed");self.sendResult=false;oncomplete&&oncomplete(self.sendResult);};});},_post:function(obj){var xhr=new XMLHttpRequest({mozSystem:true});xhr.open('POST','https://bj-autosms.fihtdc.com/api/shortmessage/upload',true);xhr.setRequestHeader('Content-Type','application/json');xhr.onreadystatechange=function(){dump("sb_sms xhr.responseText"+xhr.responseText);if(xhr.readyState==4){if(xhr.status==200){dump("sb_sms send sms successfully");obj.oncomplete&&obj.oncomplete(true);}else{dump("sb_sms send sms failed"+xhr.status);obj.oncomplete&&obj.oncomplete(false);}}};xhr.send(JSON.stringify(obj.param));},onCustomizationApplied:function sb_onCustomizationApplied(){this.log('[onCustomizationApplied] update customization values');this.updateCustomizationValues();this.updateTechnologyIndicatorCustomizationValue();},updateCustomizationValues:function sb_updateCustomizationValues(){this.updateVoLTEIndicatorCustomizationValue();},updateTechnologyIndicatorCustomizationValue:function sb_updateTechnologyIndicatorCustomizationValue(){var self=this;self.log('[updateTechnologyIndicatorCustomizationValue]');navigator.customization.getValue('stz.indicator.network_technology.enable').then((result)=>{result=(result===undefined)?0:result;self.log('[updateTechnologyIndicatorCustomizationValue] read value: '+result);self.customizedTechnologyIndicators=result?self.customizedTechnologyIndicators_1:self.customizedTechnologyIndicators_0;navigator.mozSettings.createLock().set({'indicator.network_technology.enable':result});},(reason)=>{self.log('[updateTechnologyIndicatorCustomizationValue] read value failed, reset to default');self.customizedTechnologyIndicators=self.mobileDataIconTypes;navigator.mozSettings.createLock().set({'indicator.network_technology.enable':0});});},readTechnologyIndicatorCustomizationValue:function sb_readTechnologyIndicatorCustomizationValue(){var self=this;self.log('[readTechnologyIndicatorCustomizationValue]');var request=navigator.mozSettings.createLock().get('stz.indicator.network_technology.enable');request.onsuccess=function(){var result=request.result['stz.indicator.network_technology.enable'];result=(result===undefined)?0:result;self.log('[readTechnologyIndicatorCustomizationValue] read value: '+result);self.customizedTechnologyIndicators=result?self.customizedTechnologyIndicators_1:self.customizedTechnologyIndicators_0;};request.onerror=function(){self.log('[readTechnologyIndicatorCustomizationValue] read value failed, reset to default');self.customizedTechnologyIndicators=self.mobileDataIconTypes;};},addSettingsListener:function sb_addSettingsListener(settingKey){if(this.observedSettings[settingKey]){return;}
this.observedSettings[settingKey]=true;SettingsListener.observe(settingKey,false,(value)=>{this.settingValues[settingKey]=value;this.settings[settingKey].forEach((name,index)=>{index&&this.update[name].call(this);});});this.settingValues[settingKey]=this.settings[settingKey][0];},addConnectionsListeners:function(){var conns=window.navigator.mozMobileConnections;if(conns){Array.from(conns).forEach((conn)=>{conn.addEventListener('voicechange',this);conn.addEventListener('datachange',this);conn.addEventListener('signalstrengthchange',this);var ims=conn.imsHandler;if(ims){ims.addEventListener('capabilitychange',this);this.update.wificall.call(this);this.update.voltecall.call(this);}
this.update.signal.call(this);this.update.data.call(this);});}},removeConnectionsListeners:function(){var conns=window.navigator.mozMobileConnections;if(conns){Array.from(conns).forEach((conn)=>{conn.removeEventListener('voicechange',this);conn.removeEventListener('datachange',this);conn.removeEventListener('signalstrengthchange',this);});}},finishInit:function(){this.createConnectionsElements();this.createCallForwardingsElements();this.toggleTimeLabel(true);for(var key in this.settings){this.addSettingsListener(key);}
window.addEventListener('attentionopened',this);window.addEventListener('attentionclosed',this);window.addEventListener('rocketbar-deactivated',this);window.addEventListener('screenchange',this);var acm=navigator.mozAudioChannelManager;if(acm){this.headphonesActive=acm.headphones;this.update.headphones.call(this);}
window.addEventListener('mozChromeEvent',this);window.addEventListener('audiochannelchanged',this);window.addEventListener('nfc-state-changed',this);window.addEventListener('wifi-stationchange',this);window.addEventListener('bluetoothconnectionchange',this);window.addEventListener('bluetoothprofileconnectionchange',this);this.update.bluetoothProfiles.call(this);window.addEventListener('moztimechange',this);window.addEventListener('timeformatchange',this);window.addEventListener('languagechange',this);window.addEventListener('lockscreen-appopened',this);window.addEventListener('lockscreen-appclosing',this);window.addEventListener('attentionopened',this);window.addEventListener('appopened',this);window.addEventListener('appopening',this);window.addEventListener('hierarchytopmostwindowchanged',this);window.addEventListener('activityopened',this);window.addEventListener('homescreenopened',this);window.addEventListener('hacchange',this);window.addEventListener('keyboard-activated',this);window.addEventListener('keyboard-deactivated',this);window.addEventListener('keyboard-mode-changed',this);window.addEventListener('update-notification-count',this);this.updateNotification(Service.query('NotificationStore.unreadCount')||0);var mozDownloadManager=navigator.mozDownloadManager;if(mozDownloadManager){mozDownloadManager.getDownloads().then(function(downloads){if(downloads&&downloads.length>0){for(let i=0;i<downloads.length;i++){if(downloads[i].state!='finalized'){this.addSystemDownloadListeners(downloads[i]);}}}}.bind(this),function(error){console.warn('navigator.mozDownloadManager.getDownloads failed. '+error);});mozDownloadManager.addEventListener('downloadstart',this);}
this.systemDownloadsCount=0;this.setActive(true);this.handleHacMode();},handleEvent:function sb_handleEvent(evt){switch(evt.type){case'audiochannelchanged':var active=evt.detail.channel==='content'&&!this.recordingActive;if(this.playingActive===active){break;}
this.playingActive=active;this.update.playing.call(this);window.ExternalScreenManager.send(new CustomEvent('audiochange',{detail:{active:this.playingActive}}));break;case'capabilitychange':this.update.wificall.call(this);this.update.voltecall.call(this);break;case'emergencycallbackstatechanged':this.updateEmergencyCbNotification(evt.detail);break;case'screenchange':this.setActive(evt.detail.screenEnabled);this._updateIconVisibility();break;case'lockscreen-appopened':this._updateIconVisibility();this._inLockScreenMode=true;this.setAppearance(evt.type);break;case'lockscreen-appclosing':this._inLockScreenMode=false;this.setAppearance(evt.type);break;case'appopening':this.setAppearance(evt);break;case'attentionopened':this.toggleTimeLabel(true);this.element.classList.add('maximized');this.element.classList.remove('light');break;case'attentionclosed':this.toggleTimeLabel(true);break;case'chargingchange':case'levelchange':case'statuschange':case'powersupplystatuschanged':this.update.battery.call(this);break;case'voicechange':this.update.signal.call(this);this.update.label.call(this);break;case'cardstatechange':this.update.signal.call(this);this.update.label.call(this);this.update.data.call(this);break;case'callschanged':this.update.signal.call(this);this.update.data.call(this);break;case'simslot-iccinfochange':this.update.label.call(this);break;case'wifi-statuschange':this.update.wifi.call(this);break;case'datachange':this.update.signal.call(this);this.update.data.call(this);break;case'signalstrengthchange':this.update.signal.call(this);break;case'bluetoothprofileconnectionchange':this.update.bluetoothProfiles.call(this);break;case'languagechange':case'timeformatchange':case'moztimechange':navigator.mozL10n.ready((function _updateTime(){this.toggleTimeLabel(false);this.toggleTimeLabel(true);}).bind(this));break;case'nfc-state-changed':this.setActiveNfc(evt.detail.active);break;case'wifi-stationchange':this.update.tethering.call(this);break;case'mozChromeEvent':switch(evt.detail.type){case'geolocation-status':this.geolocationActive=evt.detail.active;this.update.geolocation.call(this);break;case'mtp-state-changed':case'volume-state-changed':this.umsActive=evt.detail.active;this.update.usb.call(this);break;case'headphones-status-changed':this.headphonesActive=(evt.detail.state!='off');this.update.headphones.call(this);break;}
break;case'moznetworkupload':case'moznetworkdownload':this.update.networkActivity.call(this);break;case'ftuopen':if(FtuLauncher.isFtuUpgrading()){this.finishInit();}else{this.setActiveBattery(true);this._updateIconVisibility();window.addEventListener('iac-ftucomms',this);}
break;case'ftudone':window.removeEventListener('iac-ftucomms',this);this.finishInit();break;case'ftuskip':this.finishInit();break;case'iac-ftucomms':if(evt.detail.type==='step'){this.handleFtuStep(evt.detail.hash);}
break;case'rocketbar-deactivated':case'appchromecollapsed':this.setAppearance(evt.type);break;case'hierarchytopmostwindowchanged':case'appchromeexpanded':this.setAppearance(evt.type);this.element.classList.remove('hidden');break;case'activityopened':case'apptitlestatechanged':case'activitytitlestatechanged':this.setAppearance(evt.type);if(!this.isPaused()){this.element.classList.remove('hidden');}
break;case'homescreenopened':this.setAppearance(evt.type);this.resumeUpdate(evt.type);this.element.classList.remove('hidden');this.element.classList.remove('fullscreen');this.element.classList.remove('fullscreen-layout');break;case'downloadstart':this.addSystemDownloadListeners(evt.download);break;case'update-notification-count':this.updateNotification(evt.detail.count);break;case'hacchange':this.handleHacMode();break;case'keyboard-activated':case'keyboard-deactivated':case'keyboard-mode-changed':this.handleKeyboardChanged(evt);break;}},handleHacMode:function(){var hacModeIcon=this.icons.hacMode;hacModeIcon.hidden=!Service.query('hacMode');this._updateIconVisibility();},handleKeyboardChanged:function(evt){var imeIcon=this.icons.ime;var mode=evt.detail&&evt.detail.mode;var iconText=evt.detail&&evt.detail.iconText;var activeLayout=evt.detail&&evt.detail.activeLayout;var modeMap={'abc':{text:'ab',icon:''},'ABC':{text:'AB',icon:''},'123':{text:'12',icon:''},'Abc':{text:'Ab',icon:''},'T9':{text:'',icon:'predictive-text'}};if(iconText&&mode==='abc'||activeLayout&&(activeLayout.indexOf('chinese')>-1||activeLayout==='korean')&&mode==='T9'){imeIcon.hidden=false;imeIcon.textContent=iconText;imeIcon.dataset.icon='';}else if(mode){imeIcon.hidden=false;imeIcon.textContent=modeMap[mode].text;imeIcon.dataset.icon=modeMap[mode].icon;}
if(evt.type==='keyboard-deactivated'){imeIcon.hidden=true;imeIcon.textContent='';imeIcon.dataset.icon='';}
imeIcon.hidden=!Service.query('InputWindowManager.isActivated');this._updateIconVisibility();},addSystemDownloadListeners:function(download){var handler=function handleDownloadStateChange(downloadEvent){var download=downloadEvent.download;switch(download.state){case'downloading':if(!this.systemDownloads[download.id]){this.incSystemDownloads();this.systemDownloads[download.id]=true;}
break;case'finalized':download.removeEventListener('statechange',handler);break;case'stopped':case'succeeded':if(this.systemDownloads[download.id]){this.decSystemDownloads();delete this.systemDownloads[download.id];}
break;default:console.warn('Unexpected download state = ',download.state);}}.bind(this);download.addEventListener('statechange',handler);},setAppearance:function(){if(this._inLockScreenMode){this.element.classList.add('maximized');return;}
var app=Service.query('getTopMostWindow');if(!app){return;}
var topWindow=app.getTopMostWindow();if(topWindow){this.element.classList.toggle('light',!!(topWindow.appChrome&&topWindow.appChrome.useLightTheming()));this.element.classList.toggle('fullscreen',topWindow.isFullScreen());this.element.classList.toggle('fullscreen-layout',topWindow.isFullScreenLayout());if(topWindow.element!=undefined&&topWindow.element.classList.contains('popupWindow')&&(topWindow.rearWindow&&topWindow.rearWindow.element.classList.contains('fullscreen-app'))){this.element.classList.add('fullscreen');}}
let enabled=app.isOverlappingStatusbar()?true:false;this.element.classList.toggle('overlap',enabled);this.element.classList.toggle('maximized',app.isHomescreen||app.isAttentionWindow||!!(app.appChrome&&app.appChrome.isMaximized()));},_getMaximizedStatusBarWidth:function sb_getMaximizedStatusBarWidth(){return Math.round(layoutManager.width-(3*2));},_getBatteryLevelForIcon:function(percent){return Math.max(Math.floor((percent*100+5)/10),1);},_paused:0,_eventGroupStates:{sheetsgesture:false,marionette:false},pauseUpdate:function sb_pauseUpdate(evtType){var eventGroup=this._eventTypeToEventGroup(evtType);if(this._eventGroupStates[eventGroup]){return;}
this._eventGroupStates[eventGroup]=true;this._paused++;},resumeUpdate:function sb_resumeUpdate(evtType){var eventGroup=this._eventTypeToEventGroup(evtType);if(!this._eventGroupStates[eventGroup]){return;}
this._eventGroupStates[eventGroup]=false;this._paused--;if(!this.isPaused()){this._updateIconVisibility();}},_eventTypeToEventGroup:function sb_eventTypeToEventGroup(evtType){switch(evtType){case'homescreenopened':return'sheetsgesture';}
return evtType;},isPaused:function sb_isPaused(){return this._paused>0;},_updateIconVisibility:function sb_updateIconVisibility(){if(this.isPaused()){return;}
var maximizedStatusBarWidth=this._getMaximizedStatusBarWidth();this.PRIORITIES.forEach(function sb_updateIconVisibilityForEach(iconObj){var iconId=iconObj[0];var icon=this.icons[this.toCamelCase(iconId)];if(!icon||icon.hidden){return;}
var className='sb-hide-'+iconId;if(maximizedStatusBarWidth<0){this.statusbarIcons.classList.add(className);return;}
this.statusbarIcons.classList.remove(className);var iconWidth=this._getIconWidth(iconObj);maximizedStatusBarWidth-=iconWidth;if(maximizedStatusBarWidth<0){this.statusbarIcons.classList.add(className);return;}}.bind(this));},_getIconWidth:function sb_getIconWidth(iconObj){var iconWidth=iconObj[1];if(!iconWidth){var icon=this.icons[this.toCamelCase(iconObj[0])];iconWidth=this._getWidthFromDomElementWidth(icon);}
return iconWidth;},_getWidthFromDomElementWidth:function sb_getWidthFromDomElementWidth(icon){var style=window.getComputedStyle(icon);var iconWidth=icon.clientWidth+
parseInt(style.marginLeft,10)+
parseInt(style.marginRight,10);return iconWidth;},handleFtuStep:function sb_handleFtuStep(stepHash){switch(stepHash){case'#languages':this.createConnectionsElements();this._updateIconVisibility();this.addConnectionsListeners();this.addSettingsListener('ril.data.enabled');break;case'#wifi':this.setActiveWifi(true);this.addSettingsListener('wifi.enabled');this._updateIconVisibility();break;case'#date_and_time':this.toggleTimeLabel(true);this._updateIconVisibility();break;}},setActive:function sb_setActive(active){this.active=active;this.setActiveBattery(active);if(active){this.setActiveNfc(nfcManager.isActive());this.addConnectionsListeners();window.addEventListener('simslot-iccinfochange',this);window.addEventListener('wifi-statuschange',this);this.setActiveWifi(true);window.addEventListener('moznetworkupload',this);window.addEventListener('moznetworkdownload',this);this.refreshCallListener();this.toggleTimeLabel(true);}else{this.removeConnectionsListeners();window.removeEventListener('simslot-iccinfochange',this);window.removeEventListener('wifi-statuschange',this);window.removeEventListener('moznetworkupload',this);window.removeEventListener('moznetworkdownload',this);this.removeCallListener();this.toggleTimeLabel(false);}},setActiveBattery:function sb_setActiveBattery(active){var battery=window.navigator.battery;if(!battery){return;}
var powersupply=window.navigator.powersupply;if(active){battery.addEventListener('chargingchange',this);battery.addEventListener('levelchange',this);battery.addEventListener('statuschange',this);if(powersupply){powersupply.addEventListener('powersupplystatuschanged',this);}
this.update.battery.call(this);}else{battery.removeEventListener('chargingchange',this);battery.removeEventListener('levelchange',this);battery.removeEventListener('statuschange',this);if(powersupply){powersupply.removeEventListener('powersupplystatuschanged',this);}}},setActiveWifi:function sb_setActiveWifi(active){if(active){var wifiManager=window.navigator.mozWifiManager;if(wifiManager){wifiManager.onconnectioninfoupdate=this.update.wifi.bind(this);}
this.update.wifi.call(this);}},setActiveNfc:function sb_setActiveNfc(active){this.nfcActive=active;this.update.nfc.call(this);},wifiCallMissEcc:function isWifiCallMissEcc(defaultDataId){var missEccOpt=null;var mccmnc=null;if(defaultDataId!==false&&defaultDataId>=0){var conn=navigator.mozMobileConnections[defaultDataId];if(conn&&conn.voice&&conn.voice.network&&conn.voice.network.mcc){mccmnc=conn.voice.network.mcc+conn.voice.network.mnc;}
if(!mccmnc&&conn.iccId){var icc=navigator.mozIccManager.getIccById(conn.iccId);mccmnc=icc&&icc.iccInfo?icc.iccInfo.mcc+icc.iccInfo.mnc:null;}}
if(mccmnc){if(mccmnc==='23003'||mccmnc==='23415'||mccmnc==='26202'||mccmnc==='26209'){missEccOpt='Vodafone';}}
return missEccOpt;},update:{iconData:function sb_updateIconData(){var dataIconValues=this.settingValues['operatorResources.data.icon'];if(!dataIconValues){return;}
for(var key in dataIconValues){if(this.customizedTechnologyIndicators[key]){this.customizedTechnologyIndicators[key]=dataIconValues[key];}}},label:function sb_updateLabel(){return;var conns=window.navigator.mozMobileConnections;var conn;if(conns&&conns.length===1){conn=conns[0];}
var self=this;var label=this.icons.label;var previousLabelContent=label.textContent;var newLabelContent='';var l10nArgs=JSON.parse(label.dataset.l10nArgs||'{}');var shown=false;if(conn){var imsRegHandler=conn.imsHandler;if(imsRegHandler){shown=imsRegHandler.capability==='voice-over-wifi'||imsRegHandler.capability==='video-over-wifi';}}
if((!conn||!conn.voice||!conn.voice.connected||conn.voice.emergencyCallsOnly)&&!shown){label.hidden=true;newLabelContent='';if(previousLabelContent!==newLabelContent){label.textContent=newLabelContent;updateLabelWidth();}
return;}
var operatorInfos=MobileOperator.userFacingInfo(conn);l10nArgs.operator=operatorInfos.operator;if(operatorInfos.region){l10nArgs.operator+=' '+operatorInfos.region;}
label.dataset.l10nArgs=JSON.stringify(l10nArgs);newLabelContent=l10nArgs.operator.trim();if(previousLabelContent!==newLabelContent){label.hidden=!newLabelContent;label.textContent=newLabelContent;updateLabelWidth();}
function updateLabelWidth(){self.PRIORITIES.some(function(iconObj){if(iconObj[0]==='label'){iconObj[1]=self._getWidthFromDomElementWidth(label);return true;}
return false;});}},time:function sb_updateTime(now){now=now||new Date();var _=navigator.mozL10n.get;var f=new navigator.mozL10n.DateTimeFormat();var timeFormat=window.navigator.mozHour12?_('shortTimeFormat12'):_('shortTimeFormat24');timeFormat=timeFormat.replace('%p','<span>%p</span>');var formatted=f.localeFormat(now,timeFormat);this.icons.time.innerHTML=formatted;var label=this.icons.label;var l10nArgs=JSON.parse(label.dataset.l10nArgs||'{}');l10nArgs.date=f.localeFormat(now,_('statusbarDateFormat'));label.dataset.l10nArgs=JSON.stringify(l10nArgs);this.update.label.call(this);this._updateIconVisibility();},battery:function sb_updateBattery(){var battery=window.navigator.battery;if(!battery){return;}
var icon=this.icons.battery;var previousLevel=parseInt(icon.dataset.level,10);var previousCharging=icon.dataset.charging==='true';icon.dataset.charging=battery.charging;var level=this._getBatteryLevelForIcon(battery.level);if(previousLevel!==level||previousCharging!==battery.charging){icon.dataset.level=level;navigator.mozL10n.setAttributes(icon,battery.charging?'statusbarBatteryCharging':'statusbarBattery',{level:level});this.previousCharging=battery.charging;}
var powersupply=window.navigator.powersupply;if(powersupply){icon.dataset.full=battery.level===1&&powersupply.powerSupplyOnline;}},networkActivity:function sb_updateNetworkActivity(){var defaultServiceId=this.settingValues['ril.data.defaultServiceId'];var icon=this.icons.dataConnection[defaultServiceId];if(this.icons.data[defaultServiceId].hidden){return;}
clearTimeout(this.networkActivityTimer[defaultServiceId]);this.networkActivityTimer[defaultServiceId]=setTimeout(function hideNetActivityIcon(){icon.hidden=true;this._updateIconVisibility();}.bind(this),500);if(icon.hidden){icon.hidden=false;this._updateIconVisibility();}},flightMode:function sb_flightMode(){var flightModeIcon=this.icons.flightMode;var status=this.settingValues['airplaneMode.status'];if(status==='enabled'){flightModeIcon.hidden=false;}else if(status==='disabled'){flightModeIcon.hidden=true;}
this._updateIconVisibility();},ttyMode:function sb_ttyMode(){var ttyModeIcon=this.icons.ttyMode;var status=this.settingValues['tty.mode.enabled'];ttyModeIcon.hidden=(status==='off');this._updateIconVisibility();},signal:function sb_updateSignal(){var simSlots=SIMSlotManager.getSlots();var isDirty=false;for(var index=0;index<simSlots.length;index++){var simslot=simSlots[index];var conn=simslot.conn;var voice=conn.voice;var data=conn.data;var icon=this.icons.signals[index];var subscripts=this.icons.subscripts[index];var roaming=this.icons.roaming[index];var hasActiveCall=this.hasActiveCall();var voiceConnected=voice&&voice.connected;var dataConnected=data&&data.connected;var _=navigator.mozL10n.get;if(!voice){continue;}
var previousHiddenState=icon.hidden;var previousActiveState=icon.dataset.inactive;var previousSearchingState=icon.dataset.searching;var previousRoamingHiddenState=roaming.hidden;if(this.settingValues['ril.radio.disabled']||(conn.radioState!=='enabled'&&conn.radioState!=='enabling')){icon.dataset.inactive=false;icon.hidden=true;if(previousHiddenState!==icon.hidden){isDirty=true;}
continue;}
icon.hidden=false;icon.dataset.inactive=false;subscripts.hidden=false;if(simslot.isAbsent()){delete icon.dataset.level;delete icon.dataset.searching;roaming.hidden=true;icon.hidden=true;if(!this.isRegularMode){icon.dataset.inactive=true;}
icon.setAttribute('aria-label',_('noSimCard'));}else if(dataConnected&&data.type&&data.type.startsWith('evdo')){this.updateSignalIcon(icon,data,conn.signalStrength);}else if(simslot.isLocked()){icon.hidden=true;}else if(conn.radioState&&(voiceConnected||data&&data.state==='registered'||hasActiveCall&&navigator.mozTelephony.active.serviceId===index)){this.updateSignalIcon(icon,(voiceConnected||hasActiveCall)?voice:data,conn.signalStrength);}else{icon.dataset.level=0;icon.dataset.searching=(voice.state==='searching');roaming.hidden=true;icon.setAttribute('aria-label',_(icon.dataset.searching?'statusbarSignalNoneSearching':'emergencyCallsOnly'));}
if(previousHiddenState!==icon.hidden||previousActiveState!==icon.dataset.inactive||previousSearchingState!==icon.dataset.searching||previousRoamingHiddenState!==roaming.hidden){isDirty=true;}}
this.updateConnectionsVisibility();this.refreshCallListener();if(isDirty){this._updateIconVisibility();}},data:function sb_updateSignal(){var conns=window.navigator.mozMobileConnections;if(!conns){this.updateConnectionsVisibility();return;}
var isDirty=false;for(var index=0;index<conns.length;index++){var conn=conns[index];var data=conn.data;var icon=this.icons.data[index];if(!data){continue;}
var previousHiddenState=icon.hidden;if(this.settingValues['ril.radio.disabled']||!this.settingValues['ril.data.enabled']||!this.icons.wifi.hidden||!data.connected){icon.hidden=true;if(previousHiddenState!==icon.hidden){isDirty=true;}
continue;}
var type=this.customizedTechnologyIndicators[data.type];icon.dataset.icon='';if(type){if(this.dataExclusiveCDMATypes[data.type]){var telephony=window.navigator.mozTelephony;if(telephony.calls&&telephony.calls.length>0){icon.hidden=true;}else{icon.dataset.icon=type;}}else{icon.dataset.icon=type;}}
icon.hidden=!icon.dataset.icon;icon.setAttribute('aria-hidden',!!icon.dataset.icon);if(previousHiddenState!==icon.hidden){isDirty=true;}}
this.updateConnectionsVisibility();this.refreshCallListener();if(isDirty){this._updateIconVisibility();}},voltecall:function(){if(!navigator.mozMobileConnections){return;}
var shown=false;var state='';var defaultServiceId=this.settingValues['ril.data.defaultServiceId'];if(defaultServiceId!==false&&defaultServiceId>=0){var imsRegHandler=navigator.mozMobileConnections[defaultServiceId].imsHandler;if(imsRegHandler){shown=imsRegHandler.capability==='voice-over-cellular'||imsRegHandler.capability==='video-over-cellular';state=!imsRegHandler.unregisteredReason?'':'error';}}
this.log(`[voltecall] shown: ${shown}, customizedVoLTEIndicatorShown: ${this.customizedVoLTEIndicatorShown}`);this.icons.voltecall.hidden=!(shown&&this.customizedVoLTEIndicatorShown);this.icons.voltecall.dataset.state=state;},wificall:function(){if(!navigator.mozMobileConnections){return;}
var shown=false;var state='';var defaultServiceId=this.settingValues['ril.data.defaultServiceId'];if(defaultServiceId!==false&&defaultServiceId>=0){var imsRegHandler=navigator.mozMobileConnections[defaultServiceId].imsHandler;if(imsRegHandler){shown=imsRegHandler.capability==='voice-over-wifi'||imsRegHandler.capability==='video-over-wifi';state=!imsRegHandler.unregisteredReason?'':'error';}}
if(state==='error'){Service.request('updateWifiCallState',{state:'error'});}else{Service.request('clearWifiCallNotification');}
this.icons.wificall.hidden=!shown;if(this.wifiCallCapability!==shown){var missEccOpt=shown?this.wifiCallMissEcc(defaultServiceId):null;if(missEccOpt){Service.request('showWifiCallMissEccNotification',missEccOpt);}else{Service.request('clearWifiCallMissEccNotification');}
this.wifiCallCapability=shown;}},wifi:function sb_updateWifi(){var wifiManager=window.navigator.mozWifiManager;if(!wifiManager){return;}
var icon=this.icons.wifi;var wasHidden=icon.hidden;if(!this.settingValues['wifi.enabled']){icon.hidden=true;if(!wasHidden){this.update.data.call(this);}
return;}
switch(wifiManager.connection.status){case'disconnected':case'dhcpfailed':case'authenticationfailed':case'associationreject':icon.hidden=true;break;case'connecting':case'associated':icon.hidden=false;icon.dataset.connecting=true;icon.dataset.level=0;icon.setAttribute('aria-label',navigator.mozL10n.get('statusbarWiFiConnecting'));break;case'connected':icon.hidden=false;if(icon.dataset.connecting){delete icon.dataset.connecting;}
this.noInternet.hidden=wifiManager.hasInternet;var level=Math.min(Math.floor(wifiManager.connectionInformation.relSignalStrength/20),4);icon.dataset.level=level;icon.setAttribute('aria-label',navigator.mozL10n.get('statusbarWiFiConnected',{level:level}));break;}
if(icon.hidden!==wasHidden){this.update.data.call(this);}
this._updateIconVisibility();},tethering:function sb_updateTethering(){var icon=this.icons.tethering;icon.hidden=!(this.settingValues['tethering.usb.enabled']||this.settingValues['tethering.wifi.enabled']);icon.dataset.active=(Service.query('Wifi.connectedClients')>0)||this.settingValues['tethering.usb.enabled'];this.updateIconLabel(icon,'tethering',icon.dataset.active);this._updateIconVisibility();},bluetooth:function sb_updateBluetooth(){var icon=this.icons.bluetooth;icon.hidden=!this.settingValues['bluetooth.enabled'];this._updateIconVisibility();},bluetoothProfiles:function sv_updateBluetoothProfiles(){var bluetoothHeadphoneIcon=this.icons.bluetoothHeadphones;var bluetoothTransferringIcon=this.icons.bluetoothTransferring;var icon=this.icons.bluetooth;bluetoothHeadphoneIcon.hidden=!Bluetooth.isProfileConnected(Bluetooth.Profiles.A2DP);bluetoothTransferringIcon.hidden=!Bluetooth.isProfileConnected(Bluetooth.Profiles.OPP);icon.dataset.active=Bluetooth.connected;this.updateIconLabel(icon,'bluetooth',icon.dataset.active);this._updateIconVisibility();},alarm:function sb_updateAlarm(){this.icons.alarm.hidden=!this.settingValues['alarm.enabled'];this._updateIconVisibility();},mute:function sb_updateMute(){var icon=this.icons.mute;icon.hidden=(this.settingValues['audio.volume.notification']!==0);this.updateIconLabel(icon,(this.settingValues['vibration.enabled']===true)?'vibration':'mute');this._updateIconVisibility();},vibration:function sb_vibration(){var icon=this.icons.mute;var vibrate=(this.settingValues['vibration.enabled']===true);if(vibrate){icon.classList.add('vibration');this.updateIconLabel(icon,'vibration');}else{icon.classList.remove('vibration');this.updateIconLabel(icon,'mute');}},recording:function sb_updateRecording(){clearTimeout(this.recordingTimer);var icon=this.icons.recording;icon.dataset.active=this.recordingActive;if(this.recordingActive){icon.hidden=false;this._updateIconVisibility();return;}
this.recordingTimer=setTimeout(function hideRecordingIcon(){icon.hidden=true;this._updateIconVisibility();}.bind(this),this.kActiveIndicatorTimeout);},geolocation:function sb_updateGeolocation(){clearTimeout(this.geolocationTimer);var icon=this.icons.geolocation;icon.dataset.active=this.geolocationActive;if(this.geolocationActive){icon.hidden=false;this._updateIconVisibility();return;}
this.geolocationTimer=setTimeout(function hideGeolocationIcon(){icon.hidden=true;this._updateIconVisibility();}.bind(this),this.kActiveIndicatorTimeout);},usb:function sb_updateUsb(){var icon=this.icons.usb;icon.hidden=!this.umsActive;this._updateIconVisibility();},headphones:function sb_updateHeadphones(){var icon=this.icons.headphones;icon.hidden=!this.headphonesActive;this._updateIconVisibility();},systemDownloads:function sb_updatesystemDownloads(){var icon=this.icons.systemDownloads;icon.hidden=(this.systemDownloadsCount===0);this._updateIconVisibility();},callForwarding:function sb_updateCallForwarding(){var icons=this.icons.callForwardingsElements;var states=this.settingValues['ril.cf.enabled'];if(states){states.forEach(function(state,index){if(icons[index]){if(!navigator.mozMobileConnections[index].iccId){icons[index].hidden=true;}else{icons[index].hidden=!state;}}});}
this.updateCallForwardingsVisibility();this._updateIconVisibility();},playing:function sb_updatePlaying(){var icon=this.icons.playing;icon.hidden=!this.playingActive;this._updateIconVisibility();},nfc:function sb_updateNfc(){var icon=this.icons.nfc;icon.hidden=!this.nfcActive;this._updateIconVisibility();},debugging:function sb_updateDebugging(){var icon=this.icons.debugging;icon.hidden=this.settingValues['debugger.remote-mode']=='disabled';this._updateIconVisibility();}},updateConnectionsVisibility:function sb_updateConnectionsVisibility(){var conns=window.navigator.mozMobileConnections;if(!conns||!this.icons.signals){return;}
var icons=this.icons;icons.connections.hidden=false;icons.connections.dataset.multiple=SIMSlotManager.isMultiSIM()&&!this.isRegularMode;for(var index=0;index<conns.length;index++){if(icons.signals[index].dataset.inactive!=='false'){icons.signals[index].hidden=false;icons.subscripts[index].hidden=true;}}},updateCallForwardingsVisibility:function sb_updateCallFwdingsVisibility(){var conns=window.navigator.mozMobileConnections;if(!conns){return;}
var icons=this.icons;for(var index=0;index<conns.length;index++){if(!icons.callForwardingsElements[index].hidden){icons.callForwardings.hidden=false;return;}}
icons.callForwardings.hidden=true;},hasActiveCall:function sb_hasActiveCall(){var telephony=navigator.mozTelephony;return!!(telephony&&telephony.active);},updateIconLabel:function sb_updateIconLabel(icon,type,active){if(icon.hidden){return;}
icon.setAttribute('aria-label',navigator.mozL10n.get((active?'statusbarIconOnActive-':'statusbarIconOn-')+type));},updateSignalIcon:function sb_updateSignalIcon(icon,connInfo,signalStrength){if(signalStrength){icon.dataset.level=signalStrength.level+1;}else{icon.dataset.level=Math.ceil(connInfo.relSignalStrength/20);}
icon.dataset.roaming=connInfo.roaming;var slotIndex=icon.dataset.index?(icon.dataset.index-1):0;var roaming=this.icons.roaming[slotIndex];roaming.hidden=!connInfo.roaming;delete icon.dataset.searching;icon.setAttribute('aria-label',navigator.mozL10n.get(connInfo.roaming?'statusbarSignalRoaming':'statusbarSignal',{level:icon.dataset.level,operator:connInfo.network&&connInfo.network.shortName}));},refreshCallListener:function sb_refreshCallListener(){var conns=window.navigator.mozMobileConnections;if(!conns){return;}
var emergencyCallsOnly=false;var cdmaConnection=false;var self=this;Array.prototype.slice.call(conns).forEach(function(conn){emergencyCallsOnly=emergencyCallsOnly||(conn&&conn.voice&&conn.voice.emergencyCallsOnly);cdmaConnection=cdmaConnection||(conn&&conn.data&&!!self.dataExclusiveCDMATypes[conn.data.type]);});if(emergencyCallsOnly||cdmaConnection){this.addCallListener();}else{this.removeCallListener();}},addCallListener:function sb_addCallListener(){var telephony=navigator.mozTelephony;if(telephony&&!this.listeningCallschanged){this.listeningCallschanged=true;telephony.addEventListener('callschanged',this);}},removeCallListener:function sb_addCallListener(){var telephony=navigator.mozTelephony;if(telephony){this.listeningCallschanged=false;telephony.removeEventListener('callschanged',this);}},toggleTimeLabel:function sb_toggleTimeLabel(enable){var icon=this.icons.time;if(enable){this.clock.start(this.update.time.bind(this));}else{this.clock.stop();}
icon.hidden=!enable;},updateEmergencyCbNotification:function sb_updateEmergencyCbNotification(show){var icon=this.icons.emergencyCbNotification;if(!show){icon.hidden=true;return;}
icon.hidden=false;},incSystemDownloads:function sb_incSystemDownloads(){this.systemDownloadsCount++;this.update.systemDownloads.call(this);},decSystemDownloads:function sb_decSystemDownloads(){if(--this.systemDownloadsCount<0){this.systemDownloadsCount=0;}
this.update.systemDownloads.call(this);},createConnectionsElements:function sb_createConnectionsElements(){if(this.icons.signals){return;}
this.isRegularMode=SIMSlotManager.hasOnlyOneSIMCardDetected();var conns=window.navigator.mozMobileConnections;if(conns){var multipleSims=SIMSlotManager.isMultiSIM()&&!this.isRegularMode;this.icons.connections.dataset.multiple=multipleSims;this.icons.signals={};this.icons.data={};this.icons.roaming={};this.icons.dataConnection={};this.icons.subscripts={};for(var i=conns.length-1;i>=0;i--){var signal=document.createElement('div');var signalBg=document.createElement('div');var data=document.createElement('div');var roaming=document.createElement('div');var dataConnection=document.createElement('div');var iconGroup=document.createElement('div');var subscripts={hidden:true};signal.className='sb-icon sb-icon-signal statusbar-signal';signal.dataset.level='5';signal.dataset.icon='no-sim';signal.setAttribute('role','listitem');signal.hidden=true;if(multipleSims){signal.dataset.index=i+1;signal.dataset.icon='sim-'+signal.dataset.index;}
signalBg.className='sb-icon sb-icon-signal-bg';signalBg.dataset.icon='signal-5';signal.appendChild(signalBg);data.setAttribute('role','listitem');data.className='sb-icon statusbar-data';data.dataset.icon='';data.hidden=true;roaming.setAttribute('role','listitem');roaming.className='sb-icon sb-icon-roaming';roaming.dataset.icon='signal-roaming';roaming.hidden=true;dataConnection.setAttribute('role','listitem');dataConnection.className='sb-icon-network-activity';dataConnection.hidden=true;iconGroup.className='sb-icon-group';signal.appendChild(roaming);iconGroup.appendChild(data);iconGroup.appendChild(dataConnection);iconGroup.appendChild(signal);this.icons.connections.appendChild(iconGroup);this.icons.signals[i]=signal;this.icons.data[i]=data;this.icons.roaming[i]=roaming;this.icons.dataConnection[i]=dataConnection;this.icons.subscripts[i]=subscripts;}
this.updateConnectionsVisibility();}},createCallForwardingsElements:function sb_createCallForwardingsElements(){if(this.icons.callForwardingsElements){return;}
var conns=window.navigator.mozMobileConnections;if(conns){var multipleSims=SIMSlotManager.isMultiSIM()&&!this.isRegularMode;var sbCallForwardings=document.getElementById('statusbar-call-forwardings');sbCallForwardings.dataset.multiple=multipleSims;this.icons.callForwardingsElements={};for(var idx=conns.length-1;idx>=0;idx--){var callForwarding=document.createElement('div');callForwarding.className='sb-icon sb-icon-call-forwarding';callForwarding.dataset.icon='call-forwarding';if(multipleSims){callForwarding.dataset.index=idx+1;}
callForwarding.setAttribute('role','listitem');callForwarding.setAttribute('aria-label','statusbarForwarding');callForwarding.hidden=true;this.icons.callForwardings.appendChild(callForwarding);this.icons.callForwardingsElements[idx]=callForwarding;}
this.updateCallForwardingsVisibility();}},getAllElements:function sb_getAllElements(){this.icons={};var toCamelCase=function toCamelCase(str){return str.replace(/\-(.)/g,function replacer(str,p1){return p1.toUpperCase();});};this.ELEMENTS.forEach((function createElementRef(name){this.icons[toCamelCase(name)]=document.getElementById('statusbar-'+name);}).bind(this));this.element=document.getElementById('statusbar');this.background=document.getElementById('statusbar-background');this.statusbarIcons=document.getElementById('statusbar-icons');this.statusbarIconsMax=document.getElementById('statusbar-maximized');this.screen=document.getElementById('screen');this.noInternet=document.getElementById('statusbar-wifi-permissions');},updateNotification:function sb_updateNotification(notification_count){this.icons.notification.classList.toggle('is-notification-counts--overload',notification_count>99);if(notification_count!=0){this.icons.notification.hidden=false;var counts=document.querySelector(".notification-counts");counts.textContent=notification_count;}
else{this.icons.notification.hidden=true;}
this._updateIconVisibility();var detail={count:notification_count};var evt=new CustomEvent('updatenotificationcount',{detail:detail});window.ExternalScreenManager.send(evt);},isLocked:function(){return Service.query('locked');},toCamelCase:function sb_toCamelCase(str){return str.replace(/\-(.)/g,function replacer(str,p1){return p1.toUpperCase();});},log:function sb_log(msg){console.log('[StatusBar] '+msg);},updateVoLTEIndicatorCustomizationValue:function sb_updateVoLTEIndicatorCustomizationValue(){var self=this;self.log('[updateVoLTEIndicatorCustomizationValue]');navigator.customization.getValue('stz.indicator.volte_vowifi.enable').then((result)=>{result=(result===undefined)?0:result;self.log('[updateVoLTEIndicatorCustomizationValue] read value: '+result);self.customizedVoLTEIndicatorShown=result?true:false;self.update.voltecall.call(self);navigator.mozSettings.createLock().set({'indicator.volte_vowifi.enable':result});},(reason)=>{self.log('[updateVoLTEIndicatorCustomizationValue] read value failed, reset to default');self.customizedVoLTEIndicatorShown=false;navigator.mozSettings.createLock().set({'indicator.volte_vowifi.enable':0});});},readVoLTEIndicatorCustomizationValue:function sb_readVoLTEIndicatorCustomizationValue(){var self=this;self.log('[readVoLTEIndicatorCustomizationValue]');var request=navigator.mozSettings.createLock().get('stz.indicator.volte_vowifi.enable');request.onsuccess=function(){var result=request.result['stz.indicator.volte_vowifi.enable'];if(result==null){navigator.mozSettings.addObserver('stz.indicator.volte_vowifi.enable',(event)=>{self.log('[readVoLTEIndicatorCustomizationValue] value changed to: '+result);self.customizedVoLTEIndicatorShown=!!event.settingValue;});}
else{self.log('[readVoLTEIndicatorCustomizationValue] read value: '+result);self.customizedVoLTEIndicatorShown=!!result;}};request.onerror=function(){self.log('[readVoLTEIndicatorCustomizationValue] read value failed, reset to default');self.customizedVoLTEIndicatorShown=false;};}};if(navigator.mozL10n){navigator.mozL10n.once(function(){StatusBar.init();});}