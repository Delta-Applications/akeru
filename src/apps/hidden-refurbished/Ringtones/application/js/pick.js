'use strict';let tonePlayer=new TonePlayer();function PickerToneList(...args){ToneList.apply(this,args);}
PickerToneList.prototype=Object.create(ToneList.prototype);PickerToneList.prototype.constructor=PickerToneList;PickerToneList.prototype.makeItem=(tone)=>{let item=ToneList.prototype.makeItem.call(this,tone);let input=item.querySelector('input');input.checked=(tone.id===PickAtivity.currentToneID);if(item){item.addEventListener('focus',()=>{tonePlayer.setTone(tone);});};return item;};navigator.mozSetMessageHandler('activity',(activity)=>{if(PickAtivity.initialized){return;};PickAtivity.initialized=true;PickAtivity.activity=activity;PickAtivity.toneTypes=activity.source.data.type;PickAtivity.allowNone=activity.source.data.allowNone;PickAtivity.currentToneID=activity.source.data.currentToneID;document.body.classList.toggle('large-text',navigator.largeTextEnabled);PickAtivity.filterToneType();PickAtivity.eventListener();PickAtivity.getToneFiles();PickAtivity.setHeaderTitle();PickAtivity.lazyLoadSoftkeyFiles();PickAtivity.lazyLoadFiles();});let PickAtivity={initialized:false,toneTypes:null,toneType:null,allowNone:null,currentToneID:null,builtTones:null,builtRingTones:null,builtAlertTones:null,customTones:null,customRingTones:null,customAlertTones:null,activity:null,filterToneType:function(){let allToneTypes=window.builtInRingtones.toneTypes;if(!Array.isArray(this.toneTypes)){this.toneTypes=[this.toneTypes];}
this.toneTypes=this.toneTypes.filter(function(x){return allToneTypes.indexOf(x)!==-1;});this.toneType=this.toneTypes[0];},getToneFiles:function(){this.builtTones=window.builtInRingtones.getBuiltFiles(this.toneType);this.customTones=window.customRingtones.getCustomFiles(this.toneType);},setHeaderTitle:function(){let headerTitle=document.getElementById('header-title');let headerTitleL10nId='section-header-title-'+this.toneType;headerTitle.setAttribute('data-l10n-id',headerTitleL10nId);},lazyLoadSoftkeyFiles:function(){let lazyFiles=["shared/style/softkey.css","shared/js/softkey_panel.js",];LazyLoader.load(lazyFiles,()=>{this.createOptions();});},lazyLoadFiles:function(){let lazyFiles=["shared/style/status.css","shared/style/switches.css","shared/style/lists.css","shared/style/navigation.css","shared/style/option_menu.css","shared/elements/gaia-icons/gaia-icons.css","shared/elements/gaia-theme/gaia-font.css","shared/elements/config.js","shared/js/component_utils.js","shared/js/device_storage/enumerate_all.js","shared/js/option_menu.js"];LazyLoader.load(lazyFiles,()=>{this.createList();});},createList:function(){navigator.mozL10n.once(()=>{let listParent=document.getElementById('list-parent');let builtInList=new PickerToneList('section-title-builtin-'+this.toneType,listParent);let customList=new PickerToneList('section-title-custom-'+this.toneType,listParent);let promises=[];promises.push(window.builtInRingtones.list(this.builtTones,this.toneType,builtInList));promises.push(window.customRingtones.list(this.customTones,this.toneType,customList));Promise.all(promises).then(()=>{if(this.allowNone){builtInList.add(new NullRingtone());};if(this.toneType==='alerttone'){document.getElementById('subheader').hidden=true;}
document.querySelector('body').dataset.ready=true;window.dispatchEvent(new Event('listReady'));});});},eventListener:function(){window.addEventListener('keydown',(e)=>{if(e.key==='Backspace'){tonePlayer.stop();this.activity.postError('cancelled');e.preventDefault();};});window.addEventListener('visibilitychange',()=>{if((!document.hidden)&&(!document.querySelector('.group-menu'))){let evt=new CustomEvent('listReady',{detail:{restoreFocus:true,ringtoneVisibilityChange:true}});window.dispatchEvent(evt);};});window.addEventListener('largetextenabledchanged',()=>{document.body.classList.toggle('large-text',navigator.largeTextEnabled);});},saveTone:function(){let selectedTone=tonePlayer.currentTone;tonePlayer.stop();tonePlayer.isValid((valid)=>{if(!valid){this.activity.postError('cancelled');}
selectedTone.getBlob().then((blob)=>{this.activity.postResult({name:selectedTone.name,filename:selectedTone.filename,l10nID:selectedTone.l10nID,id:selectedTone.id,blob:blob});});});},createOptions:function(){let params={menuClassName:'menu-button',header:{l10nId:'message'},items:[{name:'Cancel',l10nId:'cancel',priority:1,method:()=>{tonePlayer.stop();this.activity.postError('cancelled');}},{name:'Select',l10nId:'select',priority:2,method:this.saveTone.bind(this)}]};let option=new SoftkeyPanel(params);option.show();}};