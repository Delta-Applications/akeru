define(["require","modules/mvvm/observable_array"],function(e){var t=new WeakMap,n=e("modules/mvvm/observable_array"),r=function(e,r,i){function o(e){var t=d.get(e);if(t&&"object"==typeof t){var n=d.get(t);n&&(n.forEach(function(e){t.unobserve(e)}),d.delete(t),d.delete(e))}}function a(e,t){var n=d.get(e)||[];d.has(e)&&(n=d.get(e)),n=Object.keys(t).map(function(n){return e.observe(n,t[n]),t[n](),t[n]}),d.set(e,n)}var s=null,l=e,u=i,c=!0,d=new WeakMap,f={observeAndCall:a},h=function(e){if(c){var t=e.data;switch(e.type){case"insert":p(t.index,t.items);break;case"remove":m(t.index,t.count);break;case"replace":v(t.index,t.newValue);break;case"reset":g(t.items||[])}}},p=function(e,t){if(!(t.length<=0))for(var n=l.children[e],r=t.length-1;r>=0;r--){var i=u(t[r],void 0,f);d.set(i,t[r]),l.insertBefore(i,n),n=i}},m=function(e,t){if(0!==t)if(t>=l.childElementCount)for(;l.firstElementChild;)o(l.firstElementChild),l.removeChild(l.firstElementChild);else for(var n=l.children[e],r=0;t>r&&n;r++){var i=n.nextElementSibling;o(n),l.removeChild(n),n=i}},v=function(e,t){var n=l.children[e];if(n){o(n);var r=u(t,n,f);d.set(n,t),r!==n&&(l.insertBefore(r,n),l.removeChild(n))}},g=function(e){var t=e.length,n=l.childElementCount;if(0===t)m(0,n);else if(n>=t)e.forEach(function(e,t){v(t,e)}),m(t,n-t);else{var r=e.slice(0,n),i=e.slice(n);r.forEach(function(e,t){v(t,e)}),p(n,i)}},y=function(){c&&g(s.array)},b={set:function(e){return s&&s.unobserve(h),e?(Array.isArray(e)&&(e=n(e)),s=e,s.observe("insert",h),s.observe("remove",h),s.observe("replace",h),s.observe("reset",h),this.enabled&&g(s.array),void 0):(s&&(m(0,s.length),s=null),void 0)},destroy:function(){s&&s.unobserve(h),m(0,s.length),t.delete(l),l=null,s=null,u=null,c=!1},get element(){return l},set enabled(e){c!==e&&(c=e,y())},get enabled(){return c}};return t.has(l)&&t.get(l).destroy(),t.set(l,b),l.innerHTML="",b.set(r),b};return r});