
navigator.mozL10n.once(function(){function e(e){l.checked=e}function t(){if(o.enabled){var e=o.getDefaultAdapter();e.onsuccess=function(){return a=e.result,null==a?(r.createLock().set({"bluetooth.enabled":!1}),void 0):(a.ondevicefound=f.onDeviceFound,d.initWithAdapter(),f.initWithAdapter(),void 0)},e.onerror=function(){r.createLock().set({"bluetooth.enabled":!1})}}}var n={HFP:4382,A2DP:4365},i=navigator.mozL10n.get;navigator.mozL10n;var r=navigator.mozSettings,o=navigator.mozBluetooth,a=null;const s="bluetooth.device.connected";var c=20;if(r&&o){var u=document.getElementById("settings-back");u.onclick=function(){window.close()};var l=document.querySelector("#bluetooth-status input");l.onchange=function(){var e=r.createLock().set({"bluetooth.enabled":this.checked});this.disabled=!0,e.onerror=function(){l.disabled=!1}};var d=function(){function e(e){var t=a.setName(e);t.onsuccess=function(){w=l.textContent=a.name}}function t(e){if(f.hidden=!e,e){u.hidden=!1;var t=r.createLock().get("bluetooth.visible");t.onsuccess=function(){var e=t.result["bluetooth.visible"];"undefined"==typeof e&&(e=!0),s(e)},t.onerror=function(){d.checked=!0}}else u.hidden=!0,p.disabled=!0,y&&(clearTimeout(y),y=null)}function n(){d.checked=a.discoverable,s(d.checked),setTimeout(function(){w=l.textContent=a.name,p.disabled=!1},1e3)}function s(e){o.enabled&&a&&(r.createLock().set({"bluetooth.visible":e}),a.setDiscoverable(e),e?y||(y=setTimeout(function(){s(!1)},b)):y&&(clearTimeout(y),y=null),d.checked=e)}var u=document.getElementById("device-visible"),l=document.getElementById("bluetooth-device-name"),d=document.querySelector("#device-visible input"),f=document.getElementById("bluetooth-rename"),p=document.getElementById("rename-device"),h=document.getElementById("update-device-name"),v=document.getElementById("update-device-name-input"),m=document.getElementById("update-device-name-cancel"),g=document.getElementById("update-device-name-confirm"),y=null,b=12e4,w="";return d.onchange=function(){s(this.checked)},p.onclick=function(){""===w&&(w=l.textContent=a.name),v.value=w,h.hidden=!1,v.focus();var e=v.value.length;v.setSelectionRange(0,e)},m.onclick=function(e){e&&e.preventDefault(),h.hidden=!0},g.onclick=function(t){t&&t.preventDefault();var n=v.value;if(n=n.replace(/^\s+|\s+$/g,""),n.length>c){var s=window.confirm(i("bluetooth-name-maxlength-alert",{length:c}));return s||(h.hidden=!0),void 0}if(n===w||!o.enabled||!a)return h.hidden=!0,void 0;if(""!==n)e(n);else{var u=r.createLock().get("deviceinfo.product_model");u.onsuccess=function(){var t=u.result["deviceinfo.product_model"];e(t)}}h.hidden=!0},{update:t,initWithAdapter:n}}(),f=function(){function e(e,t){var n=document.createElement("span");""!==e.name?n.textContent=e.name:n.setAttribute("data-l10n-id","unnamed-device");var i=document.createElement("small");t&&i.setAttribute("data-l10n-id",t);var r=document.createElement("a");r.appendChild(n),r.appendChild(i);var o=document.createElement("li");return o.classList.add("bluetooth-device"),o.classList.add("bluetooth-type-"+e.icon),o.appendChild(r),o}function t(e){x.hidden=!e,e?(L.hidden=!0,_.show(!0),E.hidden=!1,document.addEventListener("visibilitychange",b)):(_.show(!1),P.show(!1),L.hidden=!1,E.hidden=!0,T.close(),C=null,A=null,S=null,clearTimeout(O),O=null,document.removeEventListener("visibilitychange",b))}function c(){a.onpairedstatuschanged=function(e){dispatchEvent(new CustomEvent("bluetooth-pairedstatuschanged")),p(e.status,"Authentication Failed")},a.ondiscoverystatechanged=function(e){e.discovering?(k.disabled=!0,E.hidden=!1):(k.disabled=!1,E.hidden=!0,clearTimeout(O),O=null)},a.onhfpstatuschanged=function(e){g(e.address,e.status,n.HFP)},a.ona2dpstatuschanged=function(e){g(e.address,e.status,n.A2DP)},l(function(){for(var e in P.index){var t=P.index[e];if(Object.keys(t.connectedProfiles).length>0)return}u()}),y()}function u(){var e=r.createLock().get(s);e.onsuccess=function(){var t=e.result[s];if(t&&P.index[t]){var n=P.index[t].device;m(n)}}}function l(t){if(o.enabled&&a){var n=a.getPairedDevices();n.onsuccess=function(){var i=n.result.slice(),r=i.length;if(0==r)return P.show(!1),void 0;P.clear(),i.sort(function(e,t){return e.name>t.name});for(var o=0;r>o;o++)!function(t){var n=e(t,"");if(n.onclick=function(){T.show(t)},P.list.appendChild(n),P.index[t.address]={device:t,item:n,connectedProfiles:{}},t.address===A&&"audio-card"===t.icon){var i=n.querySelector("small");i.setAttribute("data-l10n-id","device-status-connecting"),setTimeout(function(){m(t)},5e3)}}(i[o]);d(function(e){e.length>0&&e.forEach(function(e){var t=e.device,n=e.connectedProfiles;for(var i in n)g(t.address,!0,i)}),P.show(!0),t&&t()})}}}function d(e){if(e){if(!a)return e([]),void 0;var t=function(e,t){if(t){var n=a.getConnectedDevices(e);n.onsuccess=function(){t(n.result||[])},n.onerror=function(){t(null)}}},i={},r=function(e,t){t&&t.forEach(function(t){var n=i[t.address];n?n.connectedProfiles[e]=!0:(n={device:t,connectedProfiles:{}},n.connectedProfiles[e]=!0),i[t.address]=n})};t(n.HFP,function(o){r(n.HFP,o),t(n.A2DP,function(t){r(n.A2DP,t);var o=[];for(var a in i){var s=i[a];o.push(s)}e(o)})})}}function f(t){var n=t.device,i=_.index[n.address]||P.index[n.address];if(i){var r=i.item;if(n.name&&r){var o=r.querySelector("a > span");o&&(o.removeAttribute("data-l10n-id"),o.textContent=n.name)}}else{var s=e(n,"device-status-tap-connect");s.onclick=function(){if(!C){var e=s.querySelector("small");e.setAttribute("data-l10n-id","device-status-pairing"),this.setAttribute("aria-disabled",!0),w();var t=a.pair(n.address);C=n.address,t.onerror=function(){p(!1,t.error.name)}}},_.list.appendChild(s),_.index[n.address]={device:n,item:s,connectedProfiles:{}}}}function p(e,t){if(!C)return l(),void 0;var n=C;if(C=null,e){if(_.index[n]){_.index[n].device;var r=_.index[n].item;_.list.removeChild(r),delete _.index[n],A=n}}else{var o=i("error-pair-title");if("Repeated Attempts"===t?o=o+"\n"+i("error-pair-toofast"):"Authentication Failed"===t&&(o=o+"\n"+i("error-pair-pincode")),window.alert(o),_.index[n]){var r=_.index[n].item,a=r.querySelector("small");r.removeAttribute("aria-disabled"),a.setAttribute("data-l10n-id","device-status-tap-connect")}}l()}function h(e){if(e.address===S){var t=i("unpair-title")+"\n"+i("unpair-msg");if(!window.confirm(t))return;S=null}var n=a.unpair(e.address);n.onerror=function(){p(!0,null)}}function v(e,t){if(!o.enabled||!a||e.address!==S)return t&&t(),void 0;var n=a.disconnect(e);n.onsuccess=n.onerror=function(){t&&t()}}function m(e){if(!o.enabled||!a||"audio-card"!==e.icon||e.address===S)return A=null,void 0;var t=function(){var t=function(){A&&(A=null)},n=function(){if(A){var e=P.index[A].item.querySelector("small");e.removeAttribute("data-l10n-id"),e.textContent="",A=null,window.alert(i("error-connect-msg"))}};w();var r=a.connect(e);if(r.onsuccess=t,r.onerror=n,A=e.address,P.index[A]){var o=P.index[A].item.querySelector("small");o.setAttribute("data-l10n-id","device-status-connecting")}};S&&P.index[S]?v(P.index[S].device,t):t()}function g(e,t,i){var o=P.index[e];if(o){o.connectedProfiles[i]=t;var a=!1;if(t)a=!0;else for(var i in o.connectedProfiles)a=a||o.connectedProfiles[i];a?(S=e,r.createLock().set({"bluetooth.device.connected":S})):S===e&&(S=null,r.createLock().set({"bluetooth.device.connected":null}));var s="",c=o.connectedProfiles[n.HFP],u=o.connectedProfiles[n.A2DP];s=c&&u?"device-status-connected-phone-media":c?"device-status-connected-phone":u?"device-status-connected-media":null;var l=P.index[e].item.querySelector("small");s?l.setAttribute("data-l10n-id",s):(l.removeAttribute("data-l10n-id"),l.textContent="")}}function y(){if(o.enabled&&a&&!O&&!document.hidden){var e=a.startDiscovery();e.onsuccess=function(){O||(O=setTimeout(w,I))},e.onerror=function(){console.error("Can not discover nearby device")}}}function b(){document.hidden&&w()}function w(){if(o.enabled&&a&&O){var e=a.stopDiscovery();e.onerror=function(){console.error("Can not stop discover nearby device")},clearTimeout(O),O=null}}var x=document.getElementById("bluetooth-search"),k=document.getElementById("search-device"),E=document.getElementById("bluetooth-searching"),L=document.getElementById("bluetooth-enable-msg"),C=null,A=null,S=null,I=6e4,O=null,P={title:document.getElementById("bluetooth-paired-title"),list:document.getElementById("bluetooth-paired-devices"),index:[],clear:function(){for(;this.list.hasChildNodes();)this.list.removeChild(this.list.lastChild);this.index=[]},show:function(e){e||this.clear(),this.title.hidden=!e,this.list.hidden=!e}},_={title:document.getElementById("bluetooth-found-title"),list:document.getElementById("bluetooth-devices"),index:[],clear:function(){for(;this.list.hasChildNodes();)this.list.removeChild(this.list.lastChild);this.index=[]},show:function(e){e||this.clear(),this.title.hidden=!e,this.list.hidden=!e}},T={menu:document.getElementById("paired-device-option"),connectOpt:document.getElementById("connect-option"),disconnectOpt:document.getElementById("disconnect-option"),unpairOpt:document.getElementById("unpair-option"),confirmDlg:document.getElementById("unpair-device"),unpairCancel:document.getElementById("unpair-device-cancel"),confirmOpt:document.getElementById("confirm-option"),showActions:function(){var e=this;S&&this.device.address===S?(this.connectOpt.style.display="none",this.disconnectOpt.style.display="block",this.disconnectOpt.onclick=function(){v(e.device)}):(this.connectOpt.style.display="block",this.disconnectOpt.style.display="none",this.connectOpt.onclick=function(){m(e.device)}),this.unpairOpt.onclick=function(){h(e.device)},this.menu.onsubmit=function(){return e.close()},this.menu.hidden=!1},showConfirm:function(){var e=this;this.unpairCancel.onclick=function(){return e.close()},this.confirmOpt.onclick=function(){return h(e.device),e.close()},this.confirmDlg.hidden=!1},show:function(e){this.device=e,this["audio-card"===this.device.icon?"showActions":"showConfirm"]()},close:function(){return this.menu.hidden=!0,this.confirmDlg.hidden=!0,!1}};return k.onclick=function(){t(!0),_.clear(),y()},{update:t,initWithAdapter:c,startDiscovery:y,onDeviceFound:f}}(),p=!1;r.addObserver("bluetooth.enabled",function(t){var n=t.settingValue;p!=n&&(l.disabled=!0,p=n,e(n),f.update(n),d.update(n),n||(a=null))});var h=r.createLock().get("bluetooth.enabled");h.onsuccess=function(){p=h.result["bluetooth.enabled"],p&&t(),e(p),f.update(p),d.update(p)},o.addEventListener("adapteradded",function(){l.disabled=!1,t(),dispatchEvent(new CustomEvent("bluetooth-adapter-added"))}),o.addEventListener("disabled",function(){l.disabled=!1,a=null,dispatchEvent(new CustomEvent("bluetooth-disabled"))})}});