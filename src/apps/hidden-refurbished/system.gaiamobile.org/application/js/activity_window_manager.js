'use strict';(function(exports){function ActivityWindowManager(){}
ActivityWindowManager.prototype={_activities:[],start:function acwm_start(){if(this._started){return;}
this._started=true;this.activityPool=new Map();window.addEventListener('activityopened',this);window.addEventListener('popupopened',this);window.addEventListener('appopened',this);window.addEventListener('activityrequesting',this);window.addEventListener('activitycreated',this);window.addEventListener('activityterminated',this);},stop:function acwm_stop(){if(!this._started){return;}
this._started=false;this.activityPool=null;window.removeEventListener('activityopened',this);window.removeEventListener('popupopened',this);window.removeEventListener('appopened',this);window.removeEventListener('activityrequesting',this);window.removeEventListener('activitycreated',this);window.removeEventListener('activityterminated',this);},activityPool:null,handleEvent:function acwm_handleEvent(evt){switch(evt.type){case'popupopened':case'activityopened':case'appopened':var app=evt.detail;var parent=app.callerWindow||app.bottomWindow||app.previousWindow;if(parent&&this.activityPool.has(parent.instanceID)){this.activityPool.set(app.instanceID,true);}
break;case'popupterminated':case'appterminated':this.activityPool.delete(app.instanceID);break;case'activityrequesting':var caller=Service.currentApp.getTopMostWindow();if(!this.activityPool.size){this.activityPool.set(caller.instanceID,true);}else{if(!this.activityPool.has(caller.instanceID)){this._activities.forEach(function iterator(activity,index){if(!activity.getBottomMostWindow().isActive()||!activity.isActive()){activity.kill();}},this);this.activityPool.clear();this.activityPool.set(caller.instanceID,true);}}
break;case'activityterminated':var parentAppPageURL=null;this._activities.some(function iterator(activity,index){if(activity.instanceID===evt.detail.instanceID){if(typeof activity.parentAppPageURL==='string'){parentAppPageURL=activity.parentAppPageURL;}
if(typeof activity.opener_zIndexToRestore!=='undefined'){var openerApp=window.appWindowManager.getApp(activity.opener_origin,activity.opener_manifestURL);if(openerApp!==null){openerApp.element.style.zIndex=activity.opener_zIndexToRestore;}}
this._activities.splice(index,1);return true;}},this);this.activityPool.delete(evt.detail.instanceID);if(!this._activities.length){if(parentAppPageURL!==null){Service.request('getActiveWindowByPageUrl',parentAppPageURL).then(function(initiator){if(initiator!==null){initiator.focus();}});}}
break;case'activitycreated':this._activities.push(evt.detail);break;}}};exports.ActivityWindowManager=ActivityWindowManager;}(window));