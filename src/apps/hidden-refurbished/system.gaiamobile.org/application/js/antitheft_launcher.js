'use strict';const FMD_MAX_REGISTRATION_RETRIES=5;const FMD_ENABLE_FAILURE_NOTIFICATION_TAG='antitheft.enable-failed';var FMDOpenSettings=function(){var activity=new MozActivity({name:'anti-theft',data:{}});activity.onerror=function(e){DUMP('There was a problem opening antitheft: '+e);};};function FMDNotifications(){}
FMDNotifications.prototype={handleSystemMessageNotification:function(message){console.log("call antitheft :"+message);FMDOpenSettings();this.closeSystemMessageNotification(message);},closeSystemMessageNotification:function(msg){Notification.get({tag:msg.tag}).then(notifs=>{notifs.forEach(notif=>{if(notif.tag){if(notif.tag===msg.tag){notif.close&&notif.close();}}else{if(notif.body===msg.body){notif.close&&notif.close();}}});});},};var FMDNotificationsHandler=new FMDNotifications();var FMDManager={isAntitheftLoggedIn:false,antitheft_registeredHelper:SettingsHelper('antitheft.registered'),antitheft_registered:false,antitheft_enabledHelper:SettingsHelper('antitheft.enabled'),antitheft_enabled:false,push_url:'https://api.kaiostech.com/v3.0',app_id:'kNpFU6NavpPh4e5qnlFz',api_push:'/pushsubs/apps/',publicKey:base64UrlToUint8Array('BJpjnIyVeRwf4tiHA5GeM-j1IqR7NN8kbqdQPaRD6QWezxvXJwicLRIYNU48JDJt8aH_28RvjUTtXRRqfL0GSZM'),init:function fmd_init(){this.antitheft_registeredHelper.get((isRegistered)=>{this.antitheft_registered=!!isRegistered;});this.antitheft_enabledHelper.get((enabled)=>{this.antitheft_enabled=!!enabled;});SettingsHelper('antitheft.apiServerUrl').get((value)=>{this.push_url=value;});window.navigator.mozId.watch({wantIssuer:'kaios-accounts',onready:(e)=>{},onlogin:(e)=>{Antitheft_Requester.setHawk(e);this.isAntitheftLoggedIn=true;AntitheftAlarmManager.appendAlarms();},onlogout:(e)=>{AntitheftAlarmManager.removeAlarms();},onerror:(e)=>{}});Service.request('handleSystemMessageNotification','antitheft',FMDNotificationsHandler);navigator.mozSettings.addObserver('antitheft.enabled',(event)=>{this.antitheft_enabled=event.settingValue==true?true:false;wakeUpAntitheft(IAC_API_WAKEUP_REASON_ENABLED_CHANGED);if(event.settingValue&&this.isAntitheftLoggedIn){console.log('antitheft antitheft.enabled then subscribe Push');this.subscribePush();}else if(!event.settingValue&&this.isAntitheftLoggedIn&&this.antitheft_registered){this.unsubscribe();}});navigator.mozSettings.addObserver('ril.data.enabled',(event)=>{if(event.settingValue&&this.antitheft_enabled&&this.isAntitheftLoggedIn){console.log('antitheft ril.data.enabled then subscribe Push');this.subscribePush();wakeUpAntitheft(IAC_API_WAKEUP_REASON_ENABLED_CHANGED);}});navigator.mozSettings.addObserver('geolocation.enabled',(event)=>{wakeUpAntitheft(IAC_API_WAKEUP_REASON_STALE_REGISTRATION);});navigator.mozSettings.addObserver('lockscreen.remote-lock',(event)=>{console.log('lockscreen.remote-lock value is '+event.settingValue[0]+' '+event.settingValue[1]);if(event.settingValue[0]===''&&event.settingValue[1]===''){SettingsHelper('lockscreen.lock-message').set('');console.log('Reporting lockscreen unlocked status');wakeUpAntitheft(IAC_API_WAKEUP_REASON_LOCKSCREEN_CLOSED);}});window.addEventListener('mozFxAccountsUnsolChromeEvent',(event)=>{if(!event||!event.detail){return;}
var eventName=event.detail.eventName;console.log('antitheft received '+eventName+' FxA event in the System app');if(eventName==='onlogin'||eventName==='onverified'){wakeUpAntitheft(IAC_API_WAKEUP_REASON_LOGIN);this.isAntitheftLoggedIn=true;}else if(eventName==='onlogout'){wakeUpAntitheft(IAC_API_WAKEUP_REASON_LOGOUT);this.isAntitheftLoggedIn=false;this.unsubscribe();}});navigator.serviceWorker.addEventListener('message',this.swMessageHandler.bind(this));},swMessageHandler:function fmd_swMessageHandler(event){var message=event.data;var reason=message.reason;switch(reason){case'executecommand':console.log('antitheft '+message.command);var command;try{command=JSON.parse(message.command.replace(/[\b\f\n\r\t]/g,''));}catch(e){command={};}
if(command&&command.e){this.removeSubscription().then(()=>{wakeUpAntitheft(IAC_API_WAKEUP_REASON_PROCESS_COMMAND,command);},()=>{wakeUpAntitheft(IAC_API_WAKEUP_REASON_PROCESS_COMMAND,command);});}else{wakeUpAntitheft(IAC_API_WAKEUP_REASON_PROCESS_COMMAND,command);}
break;case'pushsubscriptionchange':if(this.antitheft_enabled&&this.isAntitheftLoggedIn){console.log('pushsubscriptionchange getAndSendSubscription');this.getAndSendSubscription();}
break;default:console.log('antitheft Unknown message from sw '+JSON.stringify(message));}},resetAntitheftStatus:function fmd_resetAntitheftStatus(){this.antitheft_registeredHelper.set(false);this.antitheft_registered=false;this.antitheft_enabledHelper.set(false);this.antitheft_enabled=false;},getAndSendSubscription:function fmd_getAndSendSubscription(){if('serviceWorker'in navigator){this.subscribe().then((subscription)=>{if(subscription){console.log('antitheft in getAndSendSubscription',JSON.stringify(subscription));this.sendSubscription(subscription).then((result)=>{console.log('antitheft subscription sent to server, result is '+JSON.stringify(result));this.antitheft_registeredHelper.set(true);this.antitheft_registered=true;},(error)=>{this.resetAntitheftStatus();console.log('antitheft Sending subscription Error is '+error);});}else{this.resetAntitheftStatus();console.log('antitheft Need to subscribe');}}).catch((e)=>{this.resetAntitheftStatus();console.log('antitheft get subscription fail');});}},subscribePush:function fmd_subscribePush(){if('serviceWorker'in navigator){navigator.serviceWorker.register('./service-worker.js').then((registration)=>{console.log('antitheft service worker registered');this.getAndSendSubscription();});}else{console.log('antitheft Service workers aren\'t supported');}},subscribe:function fmd_subscribe(){return navigator.serviceWorker.ready.then((registration)=>{return registration.pushManager.subscribe({applicationServerKey:this.publicKey,});});},unsubscribe:function fmd_unsubscribe(){this.resetAntitheftStatus();navigator.serviceWorker.ready.then((registration)=>{return registration.pushManager.getSubscription();}).then((subscription)=>{return subscription&&subscription.unsubscribe().then(()=>{console.log('antitheft Unsubscribed',subscription.endpoint);});});this.removeSubscription().then(r=>{console.log('antitheft Push subscription removed');});},removeSubscription:function fmd_removeSubscription(){return new Promise((resolve,reject)=>{var opts={url:this.push_url+this.api_push+this.app_id,method:'DELETE'};console.log('antitheft deleting push from server');Antitheft_Requester.makeRequest(opts).then((result)=>{resolve(result);},(error)=>{console.log('antitheft deleting error '+JSON.stringify(error));reject(error);});});},sendSubscription:function fmd_sendSubscription(subscription){return new Promise((resolve,reject)=>{var format_sub={};format_sub.push_type=5000;format_sub.push_subsc=window.btoa(JSON.stringify(subscription));console.log('antitheft btoa subscription is '+JSON.stringify(format_sub));var opts={url:this.push_url+this.api_push+this.app_id,method:'POST',params:JSON.stringify(format_sub)};Antitheft_Requester.makeRequest(opts).then((result)=>{resolve(result);},(error)=>{console.log('antitheft makeRequest error '+JSON.stringify(error));reject(error);});});}};function uint8ArrayToBase64Url(uint8Array,start,end){start=start||0;end=end||uint8Array.byteLength;const base64=self.btoa(String.fromCharCode.apply(null,uint8Array.subarray(start,end)));return base64.replace(/\=/g,'').replace(/\+/g,'-').replace(/\//g,'_');}
function base64UrlToUint8Array(base64UrlData){const padding='='.repeat((4-base64UrlData.length%4)%4);const base64=(base64UrlData+padding).replace(/\-/g,'+').replace(/_/g,'/');const rawData=self.atob(base64);const buffer=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;++i){buffer[i]=rawData.charCodeAt(i);}
return buffer;}
if(typeof window!=='undefined'&&window){window.uint8ArrayToBase64Url=uint8ArrayToBase64Url;window.base64UrlToUint8Array=base64UrlToUint8Array;}
window.addEventListener('load',function fmdlauncher_load(){window.removeEventListener('load',fmdlauncher_load);FMDManager.init();});