'use strict';(function(exports){var InputLayouts=function(keyboardManager,TYPE_GROUP_MAPPING){this._keyboardManager=keyboardManager;this._groupToTypeTable={};this.layouts={};this._layoutToGroupMapping={};this._enabledApps=null;Object.keys(TYPE_GROUP_MAPPING).forEach(function(type){var group=TYPE_GROUP_MAPPING[type];this._groupToTypeTable[group]=this._groupToTypeTable[group]||[];this._groupToTypeTable[group].push(type);},this);this._currentActiveLayouts={};this._promise=null;};InputLayouts.prototype.start=function il_start(){this._getSettings();};InputLayouts.prototype.stop=function il_stop(){this._promise=null;};InputLayouts.prototype.SETTINGS_KEY_CURRENT_ACTIVE='keyboard.current-active-layouts';InputLayouts.prototype._transformLayout=function il_transformLayout(layout){var transformedLayout={id:layout.layoutId,origin:layout.app.origin,manifestURL:layout.app.manifestURL,path:layout.inputManifest.launch_path};var getName=function(){return this.name;};Object.defineProperties(transformedLayout,{name:{get:getName.bind(layout.inputManifest),enumerable:true},appName:{get:getName.bind(layout.manifest),enumerable:true}});return transformedLayout;};InputLayouts.prototype._insertLayouts=function il_insertLayouts(appLayouts){appLayouts.forEach(function(layout){this._enabledApps.add(layout.app.manifestURL);layout.inputManifest.types.filter(KeyboardHelper.isKeyboardType).forEach(function(group){this.layouts[group]=this.layouts[group]||[];this.layouts[group].push(this._transformLayout(layout));},this);},this);};InputLayouts.prototype._insertFallbackLayouts=function il_insertFallbackLayouts(){Object.keys(KeyboardHelper.fallbackLayouts).filter(grp=>!(grp in this.layouts)).forEach(function(group){var layout=KeyboardHelper.fallbackLayouts[group];this._enabledApps.add(layout.app.manifestURL);this.layouts[group]=[this._transformLayout(layout)];},this);};InputLayouts.prototype._emitLayoutsCount=function il_emitLayoutsCount(){var countLayouts={};Object.keys(this.layouts).forEach(function(group){var types=this._groupToTypeTable[group];types.forEach(function(type){countLayouts[type]=this.layouts[group].length;},this);},this);var event=document.createEvent('CustomEvent');event.initCustomEvent('mozContentEvent',true,true,{type:'inputmethod-update-layouts',layouts:countLayouts});window.dispatchEvent(event);};InputLayouts.prototype._generateToGroupMapping=function il_generateToGroupMapping(){Object.keys(this.layouts).forEach(group=>{this.layouts[group].forEach((layout,index)=>{var key=layout.manifestURL+'/'+layout.id;this._layoutToGroupMapping[key]=this._layoutToGroupMapping[key]||[];this._layoutToGroupMapping[key].push({group:group,index:index});});});};InputLayouts.prototype.processLayouts=function il_processLayouts(appLayouts){this.layouts={};this._enabledApps=new Set();this._insertLayouts(appLayouts);this._insertFallbackLayouts();this._generateToGroupMapping();for(var group in this.layouts){this.layouts[group]._activeLayoutIdx=undefined;}
this._emitLayoutsCount();return this._enabledApps;};InputLayouts.prototype._getSettings=function il_getSettings(){if(!navigator.mozSettings){throw'InputLayouts: No mozSettings?';}
if(!this._promise){this._promise=navigator.mozSettings.createLock().get(this.SETTINGS_KEY_CURRENT_ACTIVE).then(result=>{var value=result[this.SETTINGS_KEY_CURRENT_ACTIVE];if(value){this._currentActiveLayouts=value;}
return this._currentActiveLayouts;}).catch(e=>{this._promise=null;throw e;});}
return this._promise;};InputLayouts.prototype.getGroupCurrentActiveLayoutIndexAsync=function il_getGroupCurrentActiveLayoutIndexAsync(group){return this._getSettings().then(currentActiveLayouts=>{var currentActiveLayout=currentActiveLayouts[group];var currentActiveLayoutIdx;if(currentActiveLayout&&this.layouts[group]){this.layouts[group].every((layout,index)=>{if(layout.manifestURL===currentActiveLayout.manifestURL&&layout.id===currentActiveLayout.id){currentActiveLayoutIdx=index;return false;}
return true;});}
return currentActiveLayoutIdx;});};InputLayouts.prototype.saveGroupsCurrentActiveLayout=function il_saveGroupsCurrentActiveLayout(layout){var supportedGroups=[];this._layoutToGroupMapping[layout.manifestURL+'/'+layout.id].forEach(groupInfo=>{this.layouts[groupInfo.group]._activeLayoutIdx=groupInfo.index;supportedGroups.push(groupInfo.group);});supportedGroups.forEach(group=>{var curr=this._currentActiveLayouts[group];if(curr&&curr.id===layout.id&&curr.manifestURL===layout.manifestURL){return;}
this._currentActiveLayouts[group]={id:layout.id,manifestURL:layout.manifestURL};});var toSet={};toSet[this.SETTINGS_KEY_CURRENT_ACTIVE]=this._currentActiveLayouts;var req=navigator.mozSettings.createLock().set(toSet);req.onerror=()=>console.error('Error while seaving currentActiveLayout',req.error);};exports.InputLayouts=InputLayouts;})(window);