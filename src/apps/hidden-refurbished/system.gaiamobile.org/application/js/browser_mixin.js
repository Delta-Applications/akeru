'use strict';(function(window){window.BrowserMixin={reload:function bm_reload(){if(this.browser.element){this.browser.element.reload();}},NEXTPAINT_TIMEOUT:500,waitForNextPaint:function bm_waitForNextPaint(callback){if(!this.browser||!this.browser.element){if(callback){callback();}
return;}
var iframe=this.browser.element;var nextPaintTimer;var self=this;var onNextPaint=function aw_onNextPaint(){self.debug(' nextpainted.');iframe.removeNextPaintListener(onNextPaint);clearTimeout(nextPaintTimer);callback();};nextPaintTimer=setTimeout(function ifNextPaintIsTooLate(){self.debug(' nextpaint is timeouted.');iframe.removeNextPaintListener(onNextPaint);callback();},this.NEXTPAINT_TIMEOUT);iframe.addNextPaintListener(onNextPaint);},setNFCFocus:function(enable){if(!this.browser||!this.browser.element||this._nfcActive===enable||(this.CLASS_NAME!=='AppWindow'&&this.CLASS_NAME!=='ActivityWindow'&&this.CLASS_NAME!=='PopupWindow')&&this.CLASS_NAME!=='HomescreenWindow'){return;}
this.debug(this.name+':'+this.instanceID+' is setting nfc active to: '+enable);try{this._nfcActive=enable;this.browser.element.setNFCFocus(enable);}catch(err){this.debug('set nfc active is not implemented');}},setSpatialNavigation:function(enabled){this.debug('setSpatialNavigation(): enabled = '+enabled);if(enabled!==getBrowserProperty(this.browser.element,'spatialNavigationEnabled')){this.debug('setSpatialNavigation(): set spatial navigation cursor '+'to: '+enabled+' on '+this.instanceID);setBrowserProperty(this.browser.element,'spatialNavigationEnabled',enabled);}},setScrollNavigation:function(enabled){this.debug('setScrollNavigation(): enabled = '+enabled);if(getBrowserProperty(this.browser.element,'spatialNavigationEnabled')&&(enabled!==getBrowserProperty(this.browser.element,'touchPanningSimulationEnabled'))){console.log('setScrollNavigation(): set scroll navigation '+'to: '+enabled+' on '+this.instanceID);setBrowserProperty(this.browser.element,'touchPanningSimulationEnabled',enabled);this.publish('scrollerModeChanged');}},getScreenshot:function bm_getScreenshot(callback,width,height,timeout,ignoreFront){if(!this.browser||!this.browser.element){if(callback){callback();}
return;}
var self=this;var invoked=false;var timer;ignoreFront=(typeof ignoreFront==='undefined')?false:ignoreFront;if(!ignoreFront&&this.frontWindow){this.frontWindow.getScreenshot(callback,width,height,timeout);return;}
if(timeout){timer=window.setTimeout(function(){if(invoked){return;}
self.debug('getScreenshot timeout!');invoked=true;callback();},timeout);}
var type=this.isHomescreen?'image/png':'image/jpeg';var req=this.iframe.getScreenshot(width||this.width||layoutManager.width,height||this.height||layoutManager.height,type);var success=function(result){if(!width){self._screenshotBlob=result;}
self.debug('getScreenshot succeed!');if(invoked){return;}
self.debug('get screenshot success!!!!');invoked=true;if(timer){window.clearTimeout(timer);}
if(callback){callback(result);}};var error=function(){self.debug('getScreenshot failed!');if(invoked){return;}
invoked=true;if(timer){window.clearTimeout(timer);}
if(callback){callback();}};if(req.then){req.then(success,error);}else{req.onsuccess=function(evt){success(evt.target.result);};req.onerror=error;}},getActiveElement:function bm_getActiveElement(){return document.activeElement;},focus:function bm_focus(){this.debug('focusing');var topWindow=this.getTopMostWindow();if(topWindow.browser==undefined){return;}
if(topWindow._permissionDialog&&topWindow._permissionDialog.isActive()){setBrowserProperty(topWindow.browser.element,'canTakeFocus',false);topWindow._permissionDialog.focus();}else if(topWindow.activityMenu&&topWindow.activityMenu.isShown()){setBrowserProperty(topWindow.browser.element,'canTakeFocus',false);topWindow.activityMenu.focus();}else if(topWindow._modalDialog&&topWindow._modalDialog.isActive()){setBrowserProperty(topWindow.browser.element,'canTakeFocus',false);topWindow._modalDialog.focus();}else if(topWindow.authDialog&&topWindow.authDialog.isShown()){setBrowserProperty(topWindow.browser.element,'canTakeFocus',false);topWindow.authDialog.focus();}else if(topWindow._optionMenu&&topWindow._optionMenu.isActive()){setBrowserProperty(topWindow.browser.element,'canTakeFocus',false);topWindow._optionMenu.focus();topWindow._setVisibleForScreenReader(false);}else if(topWindow.browser&&topWindow.browser.element&&topWindow.getActiveElement()!==topWindow.browser.element){topWindow.setVisible(true);setBrowserProperty(topWindow.browser.element,'canTakeFocus',true);topWindow.browser.element.focus();topWindow._setVisibleForScreenReader(true);}else{setBrowserProperty(topWindow.browser.element,'canTakeFocus',true);}},blur:function bm_blur(){if(this.browser.element){this.browser.element.blur();}},back:function bm_back(){if(this.browser.element){this.browser.element.goBack();}},forward:function bm_forward(){if(this.browser.element){this.browser.element.goForward();}},stop:function bm_stop(){if(this.browser.element){this.browser.element.stop();}},_setVisible:function bm__setVisible(visible){if(this.browser&&this.browser.element&&'setVisible'in this.browser.element){this.debug('setVisible on browser element:'+visible);this.browser.element.setVisible(visible);}},_setActive:function bm__setActive(active){if(this.browser&&this.browser.element&&'setActive'in this.browser.element){this.debug('setActive on browser element:'+active);this.browser.element.setActive(active);var topMostUI=Service.query('getTopMostUI');}},zoom:function bm_zoomFont(zoomValue){var ifZoom=this.browser.element&&'zoom'in this.browser.element;if(ifZoom){console.log('browser_mixin zoomValue = ',zoomValue);this.browser.element.zoom(zoomValue);}},_setVisibleForScreenReader:function bm__setVisibleForScreenReader(visible){this.debug('_setVisibleForScreenReader(): visible = '+visible);if(this.browser&&this.browser.element){this.debug('aria-hidden on browser element:'+!visible);this.browser.element.setAttribute('aria-hidden',!visible);this.toggleSpatialNavigation();}},canGoBack:function bm_cangoback(callback){var self=this;if(this.browser.element){var r=this.browser.element.getCanGoBack();var success=function(result){self._backable=result;if(callback){callback(result);}};var error=function(){if(callback){callback();}};if(r.then){r.then(success,error);}else{r.onsuccess=function(evt){success(evt.target.result);};r.onerror=error;}}else{if(callback){callback();}}},canGoForward:function bm_cangoforward(callback){var self=this;if(this.browser.element){var r=this.browser.element.getCanGoForward();var success=function(result){self._forwardable=result;if(callback){callback(result);}};var error=function(){if(callback){callback();}};if(r.then){r.then(success,error);}else{r.onsuccess=function(evt){success(evt.target.result);};r.onerror=error;}}else{if(callback)
callback();}},isOOP:function bm_isOOP(){return(this.browser_config&&this.browser_config.oop);}};AppWindow.addMixin(BrowserMixin);}(this));