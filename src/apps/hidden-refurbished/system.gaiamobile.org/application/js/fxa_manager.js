'use strict';var FxAccountsManager={DEBUG:false,_isConfigToPhoneMethod:false,_debug:function(msg){if(this.DEBUG){console.log(msg);}},init:function fxa_mgmt_init(){window.addEventListener('iac-fxa-mgmt',this.onPortMessage);window.addEventListener('mozFxAccountsUnsolChromeEvent',this);window.addEventListener('otpReceived',this.onOTPReceived.bind(this));this.initDefaultVerificationMethod();this.initRefreshCheckPassWordTime();},initRefreshCheckPassWordTime:function(){var _retryInterval={6:1*60*1000,7:5*60*1000,8:15*60*1000,9:60*60*1000,10:4*60*60*1000};var setCheckPwdTime=function(){window.asyncStorage.getItem('checkpassword.retrycount',count=>{this._debug('checkpassword.retrycount is '+count);if(count>=6){if(count>=10){count=10;}
var interval=_retryInterval[count];var enableTime=(new Date()).getTime()+interval;this._debug('Next password retry should be later than '+enableTime);window.asyncStorage.setItem('checkpassword.enabletime',enableTime);}})};this._debug('initRefreshChkPwd when moztimechange');window.addEventListener('moztimechange',setCheckPwdTime.bind(this));},initDefaultVerificationMethod:function(){var key='account.verification.phone.enabled';var getRequest=navigator.mozSettings.createLock().get(key);getRequest.onsuccess=()=>{this._debug('--> onsuccess(): getRequest.result[key] = '+
getRequest.result[key]);if(getRequest.result[key]===true){this._isConfigToPhoneMethod=true;}};getRequest.onerror=()=>{this._debug('--> onerror(): get config failed');};},sendPortMessage:function fxa_mgmt_sendPortMessage(message){var port=IACHandler.getPort('fxa-mgmt');if(port){port.postMessage(message);}},onOTPReceived:function(event){this._debug('--> onOTPReceived(): event = '+event);FxAccountsUI.fillInOTP(event.detail);},onPortMessage:function fxa_mgmt_onPortMessage(event){if(!event||!event.detail){console.error('Wrong event');return;}
var self=FxAccountsManager;self._debug('--> onPortMessage(): event.detail.name = '+
event.detail.name);var methodName=event.detail.name;self._debug('--> methodName = '+methodName);switch(methodName){case'getAccounts':case'logout':(function(methodName){LazyLoader.load('js/fxa_client.js',function(){FxAccountsClient[methodName](function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});});})(methodName);break;case'resendVerificationEmail':(function(methodName){var email=event.detail.email;if(!email){self.sendPortMessage({methodName:methodName,error:'NO_VALID_EMAIL'});return;}
LazyLoader.load('js/fxa_client.js',function(){FxAccountsClient[methodName](email,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});});})(methodName);break;case'signIn':(function(methodName){var email=event.detail.email;var password=event.detail.password;if(!email){self.sendPortMessage({methodName:methodName,error:'NO_VALID_EMAIL'});return;}
LazyLoader.load('js/fxa_client.js',function(){FxAccountsClient[methodName](email,password,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});});})(methodName);break;case'openFlow':(function(methodName){FxAccountsUI.login(function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'signOut':(function(methodName){var email=event.detail.email;FxAccountsUI.signOut(email,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'checkPassword':(function(methodName){var email=event.detail.email;var title=event.detail.title;FxAccountsUI.checkPassword(email,title,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'changePassword':(function(methodName){var email=event.detail.email;FxAccountsUI.changePassword(email,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'createAccount':(function(methodName){FxAccountsUI.createAccount(function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'refreshAuthentication':(function(methodName){var email=event.detail.email;if(!email){self.sendPortMessage({methodName:methodName,error:'NO_VALID_EMAIL'});return;}
FxAccountsUI.refreshAuthentication(email,function(data){self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;case'phoneVerification':(function(methodName){FxAccountsUI.phoneVerification(function(data){self._debug('--> phoneVerification: data = '+data);self.sendPortMessage({methodName:methodName,data:data});},function(error){self.sendPortMessage({methodName:methodName,error:error});});})(methodName);break;}},_sendContentEvent:function fxa_mgmt_sendContentEvent(msg){var event=new CustomEvent('mozFxAccountsRPContentEvent',{detail:msg});window.dispatchEvent(event);},handleEvent:function fxa_mgmt_handleEvent(event){if(!event||!event.detail){console.error('Wrong event');return;}
var message=event.detail;var email;this._debug('--> mozFxAccountsUnsolChromeEvent handleEvent(): '+'event.detail.eventName = '+event.detail.eventName);if(message.eventName==='openFlow'&&this._isConfigToPhoneMethod){message.eventName='phoneVerification';this._debug('mozFxAccountsUnsolChromeEvent handleEvent():'+' replace method to be "phoneVerification"');}
switch(message.eventName){case'openFlow':FxAccountsUI.login(function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'phoneVerification':FxAccountsUI.phoneVerification(function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'signOut':email=message.email;FxAccountsUI.signOut(email,function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'checkPassword':email=message.email;var title=event.detail.title;FxAccountsUI.checkPassword(email,title,function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'changePassword':email=message.email;FxAccountsUI.changePassword(email,function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'createAccount':FxAccountsUI.createAccount(function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'refreshAuthentication':email=message.data.email;if(!email){console.error('No account id specified');return;}
FxAccountsUI.refreshAuthentication(email,function(result){this._sendContentEvent({id:message.id,result:result});}.bind(this),function(error){this._sendContentEvent({id:message.id,error:error});}.bind(this));break;case'onlogin':case'onverified':case'onlogout':FxAccountsManager.sendPortMessage({eventName:message.eventName});break;}}};FxAccountsManager.init();