var AudioMetadata=function(){function e(e){var r=e.name;if(r&&"DCIM/"===r.slice(0,5)&&".3gp"===r.slice(-4).toLowerCase())return Promise.reject("skipping 3gp video file");if(e.size<128)return Promise.reject("file is empty or too small");var i={};if(i.artist=i.album=i.title="",i.rated=i.played=0,r){var a=r.lastIndexOf("/"),o=r.lastIndexOf(".");a>=o&&(o=r.length),i.title=r.substring(a+1,o)}return new Promise(function(r,a){var o=Math.min(65536,e.size);BlobView.get(e,0,o,function(o,s){if(s)return a(s),void 0;try{var u=MetadataFormats.findParser(o);u?r(u.parse(o,i).then(function(t){return n(e,t)})):r(t(e).then(function(){return i}))}catch(c){console.error("AudioMetadata.parse:",c,c.stack),a(c)}})})}function t(e){var t=new Audio;t.mozAudioChannelType="content";var n=e.type&&t.canPlayType(e.type);return"probably"===n?Promise.resolve():new Promise(function(n,r){var i=URL.createObjectURL(e);t.src=i,t.onerror=function(){URL.revokeObjectURL(i),t.removeAttribute("src"),t.load(),r("Unplayable music file")},t.oncanplay=function(){URL.revokeObjectURL(i),t.removeAttribute("src"),t.load(),n()}})}function n(e,t){t.title||(t.title=""),t.album||(t.album=""),t.artist||(t.artist="");var n=e.name;if(!n)return Promise.resolve(t);if(t.picture){if(t.picture.blob){var u;if(t.artist||t.album){var c=(t.artist||"").substr(0,64),l=(t.album||"").substr(0,64);u=c+"."+l}else u=n.substr(-128);var f=t.picture.blob;delete t.picture.blob;var d="image/jpeg"===f.type?".jpg":".png",g=r(u)+"."+f.size+d,p=i(n);return a(f,g,p).then(function(e){return t.picture.filename=e,t},function(){return delete t.picture,t})}return Promise.resolve(t)}var m=n.lastIndexOf("/"),v=n.substring(0,m+1);return v in s?(t.picture=s[v],Promise.resolve(t)):new Promise(function(e){var n=["folder.jpg","cover.jpg","front.jpg"],r=function(i){if(i===n.length)return s[v]=null,e(t),void 0;var a=v+n[i],u=o.get(a);u.onsuccess=function(){t.picture={flavor:"external",filename:a},s[v]=t.picture,e(t)},u.onerror=function(){r(i+1)}};r(0)})}function r(e){return e.replace(/["*\/:<>?\|]/g,"_")}function i(e){if("/"===e[0]){var t=e.indexOf("/",1);if(0>t){var n=Error('handleCoverArt: Bad filename: "'+e+'"');return console.error(n),Promise.reject(n)}return e.substring(0,t+1)}return""}function a(e,t,n){var r=n+".music/covers/"+t;return u.has(r)?Promise.resolve(r):new Promise(function(n){var i=o.get(r);i.onsuccess=function(){u.add(r),n(r)},i.onerror=function(){var i=o.addNamed(e,r);i.onerror=function(){console.error("Could not save cover image",t)},u.add(r),n(r)}})}var o=navigator.getDeviceStorage("pictures"),s={},u=new Set;return{parse:e,pictureStorage:o}}();