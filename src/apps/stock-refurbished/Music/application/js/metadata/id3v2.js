var ID3v2Metadata=function(){function e(e,r){var i=t(e);return i.version>4?(console.warn("mp3 file with unknown metadata version"),Promise.resolve(r)):(r.tag_format=i.versionString,new Promise(function(t,a){e.getMore(e.index,i.length,function(e,o){if(o)return a(o),void 0;try{n(i,e,r),t(r)}catch(s){a(s)}})}))}function t(e){e.seek(3);var t={get versionString(){return"id3v2."+this.version+"."+this.revision},get tag_unsynchronized(){return 0!==(128&this.flags)},get has_extended_header(){return 0!==(64&this.flags)}};return t.version=e.readUnsignedByte(),t.revision=e.readUnsignedByte(),t.flags=e.readUnsignedByte(),t.length=e.readID3Uint28BE(),t}function n(e,t,n){if(e.tag_unsynchronized&&3===e.version&&(t=i(t,e.length)),e.has_extended_header){var a;a=4===e.version?t.readID3Uint28BE()-4:t.readUnsignedInt(),t.advance(a)}for(;t.index<t.byteLength&&0!==t.getUint8(t.index);)r(e,t,n)}function r(e,t,n){var r,u,c,f=!1;switch(e.version){case 2:r=t.readASCIIText(3),u=t.readUint24(),c=0;break;case 3:r=t.readASCIIText(4),u=t.readUnsignedInt(),c=t.readUnsignedShort();break;case 4:r=t.readASCIIText(4),u=t.readID3Uint28BE(),c=t.readUnsignedShort(),f=0!==(2&c)}var g=t.index+u,v=l[r];if(!v)return t.seek(g),void 0;if(0!==(253&c))return console.warn("Skipping",r,"frame with flags",c),t.seek(g),void 0;try{var p,m;switch(f?(p=i(t,u),u=p.sliceLength):p=t,r){case"TPE1":case"TP1":case"TALB":case"TAL":case"TIT2":case"TT2":m=a(e,p,u);break;case"TRCK":case"TRK":case"TPOS":case"TPA":m=o(e,p,u),null!==m[1]&&(n[d[r]]=m[1]),m=m[0];break;case"APIC":case"PIC":m=s(e,p,u);break;default:console.error("Should not have gotten here")}m&&(n[v]=m)}catch(h){console.warn("Error parsing mp3 metadata frame",r,":",h)}t.seek(g)}function i(e,t){for(var n=new Uint8Array(t),r=!1,i=0,a=0;t>a;a++){var o=e.readUnsignedByte();r&&0===o||(r=255===o,n[i++]=o)}var s=new BlobView.getFromArrayBuffer(n.buffer,0,i,e.littleEndian);return s.deunsynced=!0,s}function a(e,t,n,r){return void 0===r&&(r=t.readUnsignedByte(),n-=1),0===r&&t.getUint8(t.index)>128?t.readGBKText(n):4===e.version?u(t,n,r):c(t,n,r)}function o(e,t,n,r){var i=a(e,t,n,r),o=i.split("/",2).map(function(e){var t=parseInt(e,10);return isNaN(t)||!isFinite(t)?null:t});return 1===o.length&&o.push(null),o}function s(e,t,n){var r,i=t.index,a=t.readUnsignedByte();2===e.version?(r=t.readASCIIText(3),"JPG"===r?r="image/jpeg":"PNG"===r&&(r="image/png")):r=t.readNullTerminatedLatin1Text(n-1),t.readUnsignedByte(),c(t,n-(t.index-i),a);var o=t.sliceOffset+t.viewOffset+t.index,s=n-(t.index-i),u=o+s;return t.deunsynced?{flavor:"unsynced",blob:new Blob([t.buffer.slice(o,u)],{type:r})}:{flavor:"embedded",start:o,end:u,type:r}}function u(e,t,n){var r;switch(n){case 0:r=e.readASCIIText(t);break;case 1:r=e.readUTF16Text(t,void 0);break;case 2:r=e.readUTF16Text(t,!1);break;case 3:r=e.readUTF8Text(t);break;default:throw Error("unknown text encoding")}return r.replace(/\0+$/,"").replace("\0"," / ")}function c(e,t,n){switch(n){case 0:return e.readNullTerminatedLatin1Text(t);case 1:return e.readNullTerminatedUTF16Text(t,void 0);case 2:return e.readNullTerminatedUTF16Text(t,!1);case 3:return e.readNullTerminatedUTF8Text(t);default:throw Error("unknown text encoding")}}var l={TPE1:"artist",TP1:"artist",TALB:"album",TAL:"album",TIT2:"title",TT2:"title",TRCK:"tracknum",TRK:"tracknum",TPOS:"discnum",TPA:"discnum",APIC:"picture",PIC:"picture"},d={TRCK:"trackcount",TRK:"trackcount",TPOS:"disccount",TPA:"disccount"};return{parse:e}}();