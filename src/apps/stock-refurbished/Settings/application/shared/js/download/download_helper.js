var DownloadHelper=function(){function e(e,t,n){e.failed({message:t,code:n}),console.error(t)}function t(t){var n=new d,o=u(t.storageName),r=o.available();return r.onsuccess=function(){var i=t.storagePath;switch(r.result){case"unavailable":e(n," Could not open the file: "+i+" from "+t.storageName,l.NO_SDCARD);break;case"shared":e(n," Could not open the file: "+i+" from "+t.storageName,l.UNMOUNTED_SDCARD);break;default:try{var a=o.get(i);a.onsuccess=function(){n.done(a.result)},a.onerror=function(){e(n,a.error.name+" Could not open the file: "+i+" from "+t.storageName,l.FILE_NOT_FOUND)}}catch(c){e(n,"Error getting the file "+i+" from "+t.storageName,l.DEVICE_STORAGE)}}},r.onerror=function(){e(n,"Error getting storage state ",l.DEVICE_STORAGE)},n}function n(e){var t=DownloadFormatter.getFileName(e),n=MimeMapper.guessTypeFromFileProperties(t,e.contentType);return n}function o(o,r){var i=new d;return window.setTimeout(function(){var a=r.state;return"succeeded"===a||"finalized"===a?(LazyLoader.load(["shared/js/mime_mapper.js","shared/js/download/download_formatter.js"],function(){var e=n(r);0===e.length&&(e=r.contentType);var a=t(r);a.onsuccess=function(){N.create({actionType:o,download:r,type:e,blob:a.result,request:i}).run()},a.onerror=function(){i.failed(a.error)}}),void 0):(e(i,"Becareful, the download is not finished!",l.INVALID_STATE),void 0)},0),i}function r(t){var n=new d,o="succeeded"!==t.state;return setTimeout(function(){o?navigator.mozDownloadManager?t.pause().then(function(){navigator.mozDownloadManager.remove(t).then(function(){n.done(t)},function(){e(n,"DownloadManager doesnt know about this download",l.INVALID_STATE)})},function(){e(n,"Failed to pause download before removal",l.INVALID_STATE)}):e(n,"DownloadManager not present",l.INVALID_STATE):n.done(t)},0),o?n:i(n,t)}function i(t,n){var o=new d;return t.onsuccess=function(){var t=u(n.storageName),r=t.available();r.onsuccess=function(){var i=n.path;switch(r.result){case"unavailable":e(o," Could not delete the file: "+i+" from "+v,l.NO_SDCARD);break;case"shared":e(o," Could not delete the file: "+i+" from "+v,l.UNMOUNTED_SDCARD);break;default:var a=t.delete(n.storagePath);a.onsuccess=function(){"succeeded"===n.state&&LazyLoader.load(["/shared/js/download/download_store.js"],function(){DownloadStore.remove(n)}),o.done(a.result)},a.onerror=function(){e(o,a.error.name+" Could not remove the file: "+n.path+" from "+v,l.FILE_NOT_FOUND)}}},r.onerror=function(){e(o,"Error getting storage state ",l.DEVICE_STORAGE)}},t.onerror=function(t){e(o,t.message,t.code)},o}function a(e,t,n){LazyLoader.load("shared/js/download/download_ui.js",function(){var o,r=DownloadUI.show;if(e.message&&(e.message.endsWith("canceled")||e.message.endsWith("Canceled")||e.message.endsWith("cancelled")||e.message.endsWith("Cancelled")))return n&&n(null),void 0;switch(e.code){case l.NO_SDCARD:case l.UNMOUNTED_SDCARD:case l.FILE_NOT_FOUND:case l.NO_PROVIDER:o=r(DownloadUI.TYPE[e.code],t,!0),o.onconfirm=n;break;case l.MIME_TYPE_NOT_SUPPORTED:o=r(DownloadUI.TYPE.UNSUPPORTED_FILE_TYPE,t,!0),o.onconfirm=function(){c(t,n)};break;default:o=r(DownloadUI.TYPE.FILE_OPEN_ERROR,t,!0),o.onconfirm=function(){c(t,n)}}o.oncancel=n})}function c(e,t){var n=DownloadUI.show(DownloadUI.TYPE.DELETE,e,!0);n.oncancel=t,n.onconfirm=function(){"function"==typeof t?t(e):r(e)}}function s(e){var t=navigator.getDeviceStorage(v);if(!t)return console.error("Cannot get free space size in sdcard"),e(null),void 0;var n=t.freeSpace();n.onsuccess=function(t){e(t.target.result)},n.onerror=function(){e(null)}}function u(e){var t=navigator.getDeviceStorages("sdcard");if(!e||""===e)return t[0];for(var n=0;n<t.length;++n)if(t[n].storageName===e)return t[n];return t[0]}var l={FILE_NOT_FOUND:"FILE_NOT_FOUND",DEVICE_STORAGE:"DEVICE_STORAGE",MIME_TYPE_NOT_SUPPORTED:"MIME_TYPE_NOT_SUPPORTED",INVALID_STATE:"INVALID_STATE",NO_SDCARD:"NO_SDCARD",NO_PROVIDER:"NO_PROVIDER",UNMOUNTED_SDCARD:"UNMOUNTED_SDCARD"},d=function(){this.done=function(e){"function"==typeof this.onsuccess&&(this.result=e,window.setTimeout(function(){this.onsuccess({target:this})}.bind(this),0))},this.failed=function(e){"function"==typeof this.onerror&&(this.error=e,window.setTimeout(function(){this.onerror({target:this})}.bind(this),0))}},f="sdcard",g="device.storage.writable.name",v=f;LazyLoader.load("shared/js/settings_listener.js",function(){SettingsListener.observe(g,f,function(e){var t=e.settingValue;t&&(v=t)})});var m=function(e){this.req=e.request,this.name=e.actionType.activityName};m.prototype={run:function(){var e=new MozActivity({name:this.name,data:this.data});e.onsuccess=this._onsuccess.bind(this),e.onerror=this._onerror.bind(this)},_onsuccess:function(){this.req.done()},_onerror:function(e){this.req.failed({message:e.target.error.name})}};var h=function(e){m.call(this,e),this.data={url:e.download.path,filename:DownloadFormatter.getFileName(e.download),type:e.type,blob:e.blob}};h.prototype={__proto__:m.prototype};var p=function(e){m.call(this,e),this.data={type:e.type.split("/")[0]+"/*",blobs:[e.blob],filenames:[DownloadFormatter.getFileName(e.download)]}};p.prototype={__proto__:m.prototype,_onerror:function(t){"NO_PROVIDER"===t.target.error.name&&e(this.req,"No provider to share file",l.NO_PROVIDER)}};var E=function(e){m.call(this,e),this.data={name:DownloadFormatter.getFileName(e.download),type:e.type,blob:e.blob,size:e.download.totalBytes,path:e.download.path}};E.prototype={__proto__:m.prototype,run:function(){this.req.done(this.data)}};var N={TYPE:{OPEN:{activityName:"open",actionClass:h},SHARE:{activityName:"share",actionClass:p},INFO:{actionClass:E},WALLPAPER:{activityName:"setwallpaper",actionClass:p},RINGTONE:{activityName:"setringtone",actionClass:p}},create:function(e){return new e.actionType.actionClass(e)}};return{open:function(e){return o(N.TYPE.OPEN,e)},share:function(e){return o(N.TYPE.SHARE,e)},wallpaper:function(e){return o(N.TYPE.WALLPAPER,e)},ringtone:function(e){return o(N.TYPE.RINGTONE,e)},info:function(e){return o(N.TYPE.INFO,e)},remove:r,get CODE(){return l},handlerError:a,getFreeSpace:s}}();