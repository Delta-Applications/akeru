navigator.mozL10n.once(function(){function e(e){c.checked=e}function t(){if(r.enabled){var e=r.getDefaultAdapter();e.onsuccess=function(){return a=e.result,null==a?(o.createLock().set({"bluetooth.enabled":!1}),void 0):(a.ondevicefound=d.onDeviceFound,u.initWithAdapter(),d.initWithAdapter(),void 0)},e.onerror=function(){o.createLock().set({"bluetooth.enabled":!1})}}}var n={HFP:4382,A2DP:4365},i=navigator.mozL10n.get,o=Settings.mozSettings,r=navigator.mozBluetooth,a=null,s=20;if(o&&r){var c=document.querySelector("#bluetooth-status input");c.onchange=function(){var e=o.createLock().set({"bluetooth.enabled":this.checked});this.disabled=!0,e.onerror=function(){c.disabled=!1}};var u=function(){function e(e){var t=a.setName(e);t.onsuccess=function(){b=d.textContent=a.name}}function t(e){if(f.hidden=!e,e){u.hidden=!1;var t=o.createLock().get("bluetooth.visible");t.onsuccess=function(){var e=t.result["bluetooth.visible"];"undefined"==typeof e&&(e=!0),c(e)},t.onerror=function(){l.checked=!0}}else u.hidden=!0,p.disabled=!0,y&&(clearTimeout(y),y=null)}function n(){l.checked=a.discoverable,c(l.checked),setTimeout(function(){b=d.textContent=a.name,p.disabled=!1},1e3)}function c(e){r.enabled&&a&&(o.createLock().set({"bluetooth.visible":e}),a.setDiscoverable(e),e?y||(y=setTimeout(function(){c(!1)},w)):y&&(clearTimeout(y),y=null),l.checked=e)}var u=document.getElementById("device-visible"),d=document.getElementById("bluetooth-device-name"),l=document.querySelector("#device-visible input"),f=document.getElementById("bluetooth-rename"),p=document.getElementById("rename-device"),h=document.getElementById("update-device-name"),m=document.getElementById("update-device-name-input"),g=document.getElementById("update-device-name-cancel"),v=document.getElementById("update-device-name-confirm"),y=null,w=12e4,b="";return l.onchange=function(){c(this.checked)},p.onclick=function(){""===b&&(b=d.textContent=a.name),m.value=b,h.hidden=!1,m.focus();var e=m.value.length;m.setSelectionRange(0,e)},g.onclick=function(){h.hidden=!0},v.onclick=function(){var t=m.value;if(t=t.replace(/^\s+|\s+$/g,""),t.length>s){var n=window.confirm(i("bluetooth-name-maxlength-alert",{length:s}));return n||(h.hidden=!0),void 0}if(t===b||!r.enabled||!a)return h.hidden=!0,void 0;if(""!==t)e(t);else{var c=o.createLock().get("deviceinfo.product_model");c.onsuccess=function(){var t=c.result["deviceinfo.product_model"];e(t)}}h.hidden=!0},{update:t,initWithAdapter:n}}(),d=function(){function e(e,t){var n=document.createElement("span");""!==e.name?n.textContent=e.name:n.setAttribute("data-l10n-id","unnamed-device");var i=document.createElement("small");t&&i.setAttribute("data-l10n-id",t);var o=document.createElement("li"),r=document.createElement("a");return o.classList.add("bluetooth-device"),o.classList.add("bluetooth-type-"+e.icon),r.appendChild(n),r.appendChild(i),o.appendChild(r),o}function t(e){w.hidden=!e,e?(S.hidden=!0,k.show(!0),_.hidden=!1,document.addEventListener("visibilitychange",v)):(k.show(!1),I.show(!1),S.hidden=!1,_.hidden=!0,D.close(),E=null,T=null,A=null,clearTimeout(C),C=null,document.removeEventListener("visibilitychange",v))}function o(){a.onpairedstatuschanged=function(e){dispatchEvent(new CustomEvent("bluetooth-pairedstatuschanged")),l(e.status,"Authentication Failed",e.address)},a.ondiscoverystatechanged=function(e){e.discovering?(b.disabled=!0,_.hidden=!1):(b.disabled=!1,_.hidden=!0,clearTimeout(C),C=null)},a.onhfpstatuschanged=function(e){m(e.address,e.status,n.HFP)},a.ona2dpstatuschanged=function(e){m(e.address,e.status,n.A2DP)},c(function(){for(var e in I.index){var t=I.index[e];if(Object.keys(t.connectedProfiles).length>0)return}s()}),g()}function s(){window.asyncStorage.getItem("device.connected",function(e){if(e&&I.index[e]){var t=I.index[e].device;h(t)}})}function c(t){if(r.enabled&&a){var n=a.getPairedDevices();n.onsuccess=function(){var i=n.result.slice(),o=i.length;if(0==o)return I.show(!1),void 0;I.clear(),i.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()});for(var r=0;o>r;r++)!function(t){var n=e(t,"");if(n.onclick=function(){D.show(t)},I.list.appendChild(n),I.index[t.address]={device:t,item:n,connectedProfiles:{}},t.address===T&&"audio-card"===t.icon){var i=n.querySelector("small");i.setAttribute("data-l10n-id","device-status-connecting"),setTimeout(function(){h(t)},5e3)}}(i[r]);u(function(e){e.length>0&&e.forEach(function(e){var t=e.device,n=e.connectedProfiles;for(var i in n)m(t.address,!0,i)}),I.show(!0),t&&t()})}}}function u(e){if(e){if(!a)return e([]),void 0;var t=function(e,t){if(t){var n=a.getConnectedDevices(e);n.onsuccess=function(){t(n.result||[])},n.onerror=function(){t(null)}}},i={},o=function(e,t){t&&t.forEach(function(t){var n=i[t.address];n?n.connectedProfiles[e]=!0:(n={device:t,connectedProfiles:{}},n.connectedProfiles[e]=!0),i[t.address]=n})};t(n.HFP,function(r){o(n.HFP,r),t(n.A2DP,function(t){o(n.A2DP,t);var r=[];for(var a in i){var s=i[a];r.push(s)}e(r)})})}}function d(t){var n=t.device,i=k.index[n.address]||I.index[n.address];if(i){var o=i.item;if(n.name&&o){var r=o.querySelector("span");r&&(r.removeAttribute("data-l10n-id"),r.textContent=n.name)}}else{var s=e(n,"device-status-tap-connect");s.onclick=function(){if(!E){var e=s.querySelector("small");e.setAttribute("data-l10n-id","device-status-pairing"),this.setAttribute("aria-disabled",!0),this.classList.add("none-select"),y();var t=a.pair(n.address);E=n.address,t.onerror=function(){l(!1,t.error.name)}}},k.list.appendChild(s),k.index[n.address]={device:n,item:s,connectedProfiles:{}}}}function l(e,t,n){if(E){var o=E;if(E=null,e){if(k.index[o]){k.index[o].device;var r=k.index[o].item;k.list.removeChild(r),delete k.index[o],T=o}}else{var a=i("error-pair-title");if("Repeated Attempts"===t?a=a+"\n"+i("error-pair-toofast"):"Authentication Failed"===t&&(a=a+"\n"+i("error-pair-pincode")),window.alert(a),k.index[o]){var r=k.index[o].item,s=r.querySelector("small");r.removeAttribute("aria-disabled"),r.classList.remove("none-select"),s.setAttribute("data-l10n-id","device-status-tap-connect")}}c()}else if(c(),n&&e&&k.index[n]){var u=k.index[n].item;k.list.removeChild(u),delete k.index[n]}}function f(e){if(e.address===A){var t=i("unpair-title")+"\n"+i("unpair-msg");if(!window.confirm(t))return;A=null}var n=a.unpair(e.address);n.onerror=function(){l(!0,null)}}function p(e,t){if(!r.enabled||!a||e.address!==A)return t&&t(),void 0;var n=a.disconnect(e);n.onsuccess=n.onerror=function(){t&&t()}}function h(e){if(!r.enabled||!a||"audio-card"!==e.icon||e.address===A)return T=null,void 0;var t=function(){var t=function(){T&&(T=null)},n=function(){if(T){var e=I.index[T].item.querySelector("small");e.removeAttribute("data-l10n-id"),e.textContent="",T=null,window.alert(i("error-connect-msg"))}};y();var o=a.connect(e);if(o.onsuccess=t,o.onerror=n,T=e.address,I.index[T]){var r=I.index[T].item.querySelector("small");r.setAttribute("data-l10n-id","device-status-connecting")}};A&&I.index[A]?p(I.index[A].device,t):t()}function m(e,t,i){var o=I.index[e];if(o){o.connectedProfiles[i]=t;var r=!1;if(t)r=!0;else for(var i in o.connectedProfiles)r=r||o.connectedProfiles[i];r?(A=e,window.asyncStorage.setItem("device.connected",A)):A===e&&(A=null,window.asyncStorage.removeItem("device.connected"));var a="",s=o.connectedProfiles[n.HFP],c=o.connectedProfiles[n.A2DP];a=s&&c?"device-status-connected-device-media":s?"device-status-connected-device":c?"device-status-connected-media":null;var u=I.index[e].item.querySelector("small");a?u.setAttribute("data-l10n-id",a):(u.removeAttribute("data-l10n-id"),u.textContent="")}}function g(){if(r.enabled&&a&&!C&&!document.hidden){var e=a.startDiscovery();e.onsuccess=function(){C||(C=setTimeout(y,L))},e.onerror=function(){console.error("Can not discover nearby device"),b.disabled=!1,_.hidden=!0}}}function v(){document.hidden&&y()}function y(){if(r.enabled&&a&&C){var e=a.stopDiscovery();e.onerror=function(){console.error("Can not stop discover nearby device")},clearTimeout(C),C=null}}var w=document.getElementById("bluetooth-search"),b=document.getElementById("search-device"),_=document.getElementById("bluetooth-searching"),S=document.getElementById("bluetooth-enable-msg"),E=null,T=null,A=null,L=6e4,C=null,I={title:document.getElementById("bluetooth-paired-title"),list:document.getElementById("bluetooth-paired-devices"),index:[],clear:function(){for(;this.list.hasChildNodes();)this.list.removeChild(this.list.lastChild);this.index=[]},show:function(e){e||this.clear(),this.title.hidden=!e,this.list.hidden=!e}},k={title:document.getElementById("bluetooth-found-title"),list:document.getElementById("bluetooth-devices"),index:[],clear:function(){for(;this.list.hasChildNodes();)this.list.removeChild(this.list.lastChild);this.index=[]},show:function(e){e||this.clear(),this.title.hidden=!e,this.list.hidden=!e}},D={menu:document.getElementById("paired-device-option"),connectOpt:document.getElementById("connect-option"),disconnectOpt:document.getElementById("disconnect-option"),unpairOpt:document.getElementById("unpair-option"),confirmDlg:document.getElementById("unpair-device"),unpairCancel:document.getElementById("unpair-device-cancel"),confirmOpt:document.getElementById("confirm-option"),showActions:function(){var e=this;A&&this.device.address===A?(this.connectOpt.style.display="none",this.disconnectOpt.style.display="block",this.disconnectOpt.onclick=function(){p(e.device)}):(this.connectOpt.style.display="block",this.disconnectOpt.style.display="none",this.connectOpt.onclick=function(){h(e.device)}),this.unpairOpt.onclick=function(){f(e.device)},this.menu.onsubmit=function(){return e.close()},this.menu.hidden=!1},showConfirm:function(){var e=this;this.unpairCancel.onclick=function(){return e.close()},this.confirmOpt.onclick=function(){return f(e.device),e.close()},this.confirmDlg.hidden=!1},show:function(e){this.device=e,this["audio-card"===this.device.icon?"showActions":"showConfirm"]()},close:function(){return this.menu.hidden=!0,this.confirmDlg.hidden=!0,!1}};return b.onclick=function(){t(!0),k.clear(),g()},{update:t,initWithAdapter:o,startDiscovery:g,onDeviceFound:d}}(),l=!1;o.addObserver("bluetooth.enabled",function(t){var n=t.settingValue;l!=n&&(c.disabled=!0,l=n,e(n),d.update(n),u.update(n),n||(a=null))});var f=o.createLock().get("bluetooth.enabled");f.onsuccess=function(){l=f.result["bluetooth.enabled"],l&&t(),e(l),d.update(l),u.update(l)},r.addEventListener("adapteradded",function(){c.disabled=!1,t(),dispatchEvent(new CustomEvent("bluetooth-adapter-added"))}),r.addEventListener("disabled",function(){c.disabled=!1,a=null,dispatchEvent(new CustomEvent("bluetooth-disabled"))})}});