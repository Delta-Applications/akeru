define(["require","shared/settings_listener","modules/settings_panel","panels/accessibility_captions/rgbaHelper"],function(e){var t=e("shared/settings_listener"),n=e("modules/settings_panel"),i=e("panels/accessibility_captions/rgbaHelper");return function(){function e(){var e={menuClassName:"menu-button",header:{l10nId:"message"},items:[{name:"Select",l10nId:"select",priority:2,method:function(){}}]};SettingsSoftkey.init(e)}var o,r,a,s,c,u,d,l,f,p,h,m,g="accessibility.captions",v="accessibility.caption.font-size",b="accessibility.caption.theme",y="accessibility.caption.font-color",w="accessibility.caption.font-shadow",_="accessibility.caption.box-color",S="accessibility.captions.theme.custom";return n({onInit:function(e){m=document.querySelectorAll("#accessibility-captions li"),a=document.getElementById("captions-preview-example"),r=document.getElementById("caption-preview").offsetHeight,s=e.querySelector("#captions-enable"),c=e.querySelector("#captions-theme"),u=e.querySelector("#captions-font-color"),d=e.querySelector("#captions-font-opacity"),l=e.querySelector("#captions-edge-type"),f=e.querySelector("#captions-edge-color"),p=e.querySelector("#captions-background-color"),h=e.querySelector("#captions-background-opacity"),this.boundCaptionEnableHandler=this.captionEnableHandler.bind(this),this.boundThemeHandler=this.themeHandler.bind(this),this.boundFontHandler=this.fontHandler.bind(this),this.boundBackgroundHandler=this.backgroundHandler.bind(this),this.boundEdgeHandler=this.edgeHandler.bind(this),this.boundThemeCustomHandler=this.themeCustomHandler.bind(this)},onBeforeShow:function(t){e(),ListFocusHelper.updateSoftkey(t),ListFocusHelper.addEventListener(m),o={},this.initCaptionEnable(),this.initTheme(),this.initFont(),this.initEdge(),this.initBackground(),this.initThemeCustom()},onBeforeHide:function(){this.deInitTheme(),this.deInitCaptionEnable(),this.deInitFont(),this.deInitEdge(),this.deInitBackground(),this.deInitThemeCustom(),ListFocusHelper.removeEventListener(m)},initCaptionEnable:function(){t.observe(g,!1,this.boundCaptionEnableHandler)},deInitCaptionEnable:function(){t.unobserve(g,this.boundCaptionEnableHandler)},captionEnableHandler:function(e){o[g]=e,this.setThemeCustom()},initTheme:function(){c.onchange=this.setTheme.bind(this),t.observe(b,"font-color:white;box-color:black;font-shadow:none;",this.boundThemeHandler)},deInitTheme:function(){t.unobserve(b,this.boundThemeHandler)},themeHandler:function(e){o[b]=e;var t=e.split(";");t.forEach(function(e){if(e.length){e=e.split(":");var t=e[0].trim(),n=e[1].trim();switch(t){case"font-color":t="color";break;case"box-color":t="backgroundColor";break;case"font-shadow":t="textShadow"}a.style[t]=n}});for(var n=c.options,i=!0,r=0;r<n.length;r++){var s=n[r];if(s.value===e){i=!1;break}}i&&(e="custom"),c.value=e,this.setThemeCustom()},initFont:function(){u.onchange=this.setFont.bind(this),d.onchange=this.setFont.bind(this),t.observe(y,"rgba(255,255,255,1)",this.boundFontHandler),t.observe(v,"0.08",function(e){a.style.fontSize=Math.round(100*r*e)/100+"px"}.bind(this))},deInitFont:function(){t.unobserve(y,this.boundFontHandler)},fontHandler:function(e){o[y]=e,"custom"===c.value&&(a.style.color=e);var t,n,r=i.getRgbaValue(e);r?(t=r[1],t+=","+r[2],t+=","+r[3],n=r[4]||1):(t=e,n=1),u.value=i.convertRgbToColor(t),d.value=n,this.checkSettingsComplete()},initBackground:function(){p.onchange=this.setBackground.bind(this),h.onchange=this.setBackground.bind(this),t.observe(_,"rgba(0,0,0,1)",this.boundBackgroundHandler)},deInitBackground:function(){t.unobserve(_,this.boundBackgroundHandler)},backgroundHandler:function(e){o[_]=e,"custom"===c.value&&(a.style.backgroundColor=e);var t,n,r=i.getRgbaValue(e);r?(t=r[1],t+=","+r[2],t+=","+r[3],t=i.convertRgbToColor(t),n=r[4]||1):"transparent"===e?(t=e,n=h.value):(t=e,n=1),p.value=t,h.value=n,this.checkSettingsComplete()},initEdge:function(){l.onchange=this.setEdge.bind(this),f.onchange=this.setEdge.bind(this),t.observe(w,"none",this.boundEdgeHandler)},deInitEdge:function(){t.unobserve(w,this.boundEdgeHandler)},edgeHandler:function(e){o[w]=e,"custom"===c.value&&(a.style.textShadow=e);var t,n=e.split(",");switch(n.length){case 1:"none"===n[0]?l.value="none":(t=n[0].trim().split(" ")[3],l.value="dropshadow",f.value=t);break;case 2:t=n[0].trim().split(" ")[3],"#FFFFFF"===t?(t=n[1].trim().split(" ")[3],l.value="raised",f.value=t):(l.value="depressed",f.value=t);break;case 4:t=n[0].trim().split(" ")[3],l.value="outline",f.value=t}this.checkSettingsComplete()},initThemeCustom:function(){t.observe(S,!1,this.boundThemeCustomHandler)},deInitThemeCustom:function(){t.unobserve(S,this.boundThemeCustomHandler)},themeCustomHandler:function(){NavigationMap.refresh()},setTheme:function(){var e={};if("custom"!==c.value)e[b]=c.value;else if(o[y]&&o[_]&&o[w]){var t="font-color:"+o[y]+";";t+="box-color:"+o[_]+";",t+="font-shadow:"+o[w]+";",e[b]=t}navigator.mozSettings.createLock().set(e)},setFont:function(){if("custom"===c.value){var e=u.value,t=d.value,n={};n[y]=this.getRgbaString(e,t),navigator.mozSettings.createLock().set(n)}},setBackground:function(){if("custom"===c.value){var e=p.value,t=h.value,n={};n[_]="transparent"===e?e:this.getRgbaString(e,t),navigator.mozSettings.createLock().set(n)}},setEdge:function(){if("custom"===c.value){var e={};e[w]=this.getEdgeString(l.value,f.value),navigator.mozSettings.createLock().set(e)}},getRgbaString:function(e,t){var n="rgba(";return n+=i.convertColorToRgb(e)+","+t,n+=")"},getEdgeString:function(e,t){var n="none";switch(e){case"outline":n="-1px -1px 0 "+t+",",n+="1px -1px 0 "+t+",",n+="-1px 1px 0 "+t+",",n+="1px 1px 0 "+t;break;case"dropshadow":n="1px 1px 2px "+t;break;case"raised":n="-1px -1px 2px #FFFFFF,",n+="1px 1px 2px "+t;break;case"depressed":n="-1px -1px 2px "+t+",",n+="1px 1px 2px #FFFFFF"}return n},setThemeCustom:function(){var e=!0;if(o[b]){"custom"!==c.value?e=!1:0==o[g]&&(e=!1);var t={};t[S]=e,navigator.mozSettings.createLock().set(t)}},checkSettingsComplete:function(){o[b]&&"custom"!==c.value||o[b]&&o[y]&&o[_]&&o[w]&&this.setTheme()}})}});