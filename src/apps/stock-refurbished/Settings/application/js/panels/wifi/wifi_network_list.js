define(["require","modules/dialog_service","modules/wifi_utils","shared/wifi_helper","modules/wifi_context"],function(e){var t=e("modules/dialog_service"),n=e("modules/wifi_utils"),i=e("shared/wifi_helper"),o=e("modules/wifi_context"),r=i.getWifiManager(),a=function(e){var a=e.wifiAvailableNetworks,s={_scanRate:5e3,_scanning:!1,_autoscan:!1,_index:{},_networks:{},_list:e.wifiAvailableNetworks,clear:function(e){this._index={},this._networks={};for(var t=a.querySelectorAll("li:not([data-state])"),n=t.length,i=n-1;i>=0;i--)a.removeChild(t[i]);a.dataset.state=e?"on":"off"},scan:function(){var t=this;if(!this._scanning){if(!r.enabled||document.hidden)return this._scanning=!1,void 0;this._scanning=!0;var o=i.getAvailableAndKnownNetworks();o.onsuccess=function(){t.clear(!1);for(var r,s=o.result,c=0;c<s.length;++c){r=s[c];var u=n.getNetworkKey(r);!t._networks[u]||r.connected?t._networks[u]=r:!t._networks[u].connected&&r.relSignalStrength>t._networks[u].relSignalStrength&&(t._networks[u]=r)}var l=Object.getOwnPropertyNames(t._networks);if(l.length){l.sort(function(e,n){return t._networks[n].relSignalStrength-t._networks[e].relSignalStrength});for(var d=0;d<l.length;d++){r=t._networks[l[d]];var f=n.newListItem({network:r,onClick:t._toggleNetwork.bind(t),showNotInRange:!0});i.isConnected(r)?a.insertBefore(f,e.infoItem.nextSibling):a.insertBefore(f,e.scanItem),t._index[l[d]]=f}}else a.insertBefore(n.newExplanationItem("noNetworksFound"),e.scanItem);a.dataset.state="ready",t._autoscan&&window.setTimeout(t.scan.bind(t),t._scanRate),t._scanning=!1},o.onerror=function(){t._scanning=!1,window.setTimeout(t.scan.bind(t),t._scanRate)}}},getWpsAvailableNetworks:function(){for(var e=Object.getOwnPropertyNames(this._networks),t=[],n=0;n<e.length;n++){var o=this._networks[e[n]];i.isWpsAvailable(o)&&t.push(o)}return t},set autoscan(e){this._autoscan=e},get autoscan(){return this._autoscan},get scanning(){return this._scanning},_toggleNetwork:function(e){var n=this,r=i.getSecurity(e),a=r&&r.length?r.join(", "):"",s=Math.min(Math.floor(e.relSignalStrength/20),4);if(i.isConnected(e))t.show("wifi-status",{sl:s,network:e,security:a}).then(function(t){var i=t.type;"submit"===i&&o.forgetNetwork(e,function(){n.scan()})});else if(e.password&&"*"==e.password)i.setPassword(e),o.associateNetwork(e);else{var c=i.getKeyManagement(e);switch(c){case"WEP":case"WPA-PSK":case"WPA-EAP":case"WPA2-PSK":case"WPA/WPA2-PSK":t.show("wifi-auth",{sl:s,security:a,network:e}).then(function(t){var n=t.type,r=t.value;"submit"===n&&(i.setPassword(e,r.password,r.identity,r.eap,r.authPhase2,r.certificate,r.keyIndex),o.associateNetwork(e))});break;default:o.associateNetwork(e)}}}};return o.addEventListener("wifiEnabled",function(e){n.updateListItemStatus({listItems:s._index,activeItemDOM:a.querySelector(".active"),network:e.network,networkStatus:e.status})}),o.addEventListener("wifiStatusChange",function(e){n.updateListItemStatus({listItems:s._index,activeItemDOM:a.querySelector(".active"),network:e.network,networkStatus:e.status})}),o.addEventListener("wifiConnectionInfoUpdate",function(e){n.updateNetworkSignal(e.network,e.relSignalStrength)}),s};return a});