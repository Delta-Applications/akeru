define(["require","modules/mvvm/observable","modules/mvvm/observable_array","shared/keyboard_helper","shared/manifest_helper"],function(e){function t(e){e.forEach(function(e){var t=u[e.app.manifestURL];t&&(t[e.layoutId].enabled=!0)})}function n(e,t){g.forEach(function(n){n(e[0],t[0])})}function i(e,t){function n(e){var t=u[e.app.manifestURL];return t||(t=u[e.app.manifestURL]={}),t[e.layoutId]?(t[e.layoutId].enabled=e.enabled,t[e.layoutId]):(t[e.layoutId]=v(e.layoutId,e.manifest.name,e.app.manifestURL,e.inputManifest.name,e.inputManifest.description,e.inputManifest.types,e.enabled),t[e.layoutId])}function i(e,t){return e.some(function(e){return e.app===t.app?(e.layouts.push(n(t)),!0):void 0})||e.push({app:t.app,manifest:t.manifest,layouts:[n(t)]}),e}function r(e){return m(e.manifest.name,e.manifest.description,e.manifest.launch_path,e.layouts,e.app)}if(p=!0,t.apps){u={};var a=e.reduce(i,[]),s=a.map(r);l.reset(s)}var c=e.filter(function(e){return e.enabled}).map(n);d.reset(c),p=!1,o&&(o(),o=void 0)}var o,r=e("modules/mvvm/observable"),a=e("modules/mvvm/observable_array"),s=e("shared/keyboard_helper"),c=e("shared/manifest_helper"),u=null,l=a([]),d=a([]),f=!1,p=!1,h=[],g=[],m=function(e,t,n,i,o){var a=r({name:e,description:t,launchPath:n,layouts:i,app:o});return a},v=function(e,i,o,a,c,u,l){var d=r({id:e,appName:i,name:a,description:c,types:u,enabled:l});return d.observe("enabled",function(i){p||(s.setLayoutEnabled(o,e,i),i||s.checkDefaults(function(e,i){t(e),n(e,i)}))}),d},y=function(e){window.addEventListener("localized",function(){l.forEach(function(e){var t=e.app,n=new c(t.manifest),i=n.inputs;e.name=n.name,e.description=n.description,e.layouts.forEach(function(e){var t=e.id,o=i[t];e.appName=n.name,e.name=o.name,e.description=o.description})})}),o=e,s.stopWatching(),s.watchLayouts(i)},_=function(e){e&&(f?e():h.push(e))};return{reset:function(){u=null,l=a([]),d=a([]),f=!1,p=!1,h=[],g=[]},init:function(e){g=[],f=!1,y(function(){f=!0,h.forEach(function(e){e()})}),_(e)},keyboards:function(e){_(function(){e(l)})},enabledLayouts:function(e){_(function(){e(d)})},defaultKeyboardEnabled:function(e){g.push(e)}}});