define(["require","modules/mvvm/observable"],function(e){var t=e("modules/mvvm/observable"),n=window.navigator.mozSettings,i="time.clock.automatic-update.enabled",o="time.timezone.automatic-update.enabled",r="time.clock.automatic-update.available",a="time.timezone.automatic-update.available",s="time.timezone",c="time.timezone.user-selected",u="locale.hour12",l="home.clock.visible",d=null,f=null;const p=[{oldTimeZone:"Europe/Saint_Petersburg",newTimeZone:"Europe/Moscow"},{oldTimeZone:"Europe/Volgograd",newTimeZone:"Europe/Samara"},{oldTimeZone:"Europe/Astrakhan",newTimeZone:"Europe/Samara"},{oldTimeZone:"Europe/Izhevsk",newTimeZone:"Europe/Samara"},{oldTimeZone:"Europe/Ufa",newTimeZone:"Asia/Yekaterinburg"},{oldTimeZone:"Asia/Chelyabinsk",newTimeZone:"Asia/Yekaterinburg"},{oldTimeZone:"Asia/Novosibirsk",newTimeZone:"Asia/Krasnoyarsk"},{oldTimeZone:"Asia/Barnaul",newTimeZone:"Asia/Krasnoyarsk"},{oldTimeZone:"Asia/Ulan-Ude",newTimeZone:"Asia/Irkutsk"},{oldTimeZone:"Asia/Chita",newTimeZone:"Asia/Yakutsk"},{oldTimeZone:"Asia/Khabarovsk",newTimeZone:"Asia/Vladivostok"},{oldTimeZone:"Asia/Yuzhno-Sakhalinsk",newTimeZone:"Asia/Magadan"},{oldTimeZone:"Asia/Severo-Kurilsk",newTimeZone:"Asia/Magadan"},{oldTimeZone:"Asia/Petropavlovsk-Kamchatsky",newTimeZone:"Asia/Anadyr"}];var h={clockAutoEnabled:!0,clockAutoAvailable:!0,timezoneAutoAvailable:!0,timezone:"",userSelectedTimezone:"",date:"",time:"",currentHour12:!0,HomeScreenLockAvailable:!0,_init:function(){return this._mozTime=window.navigator.mozTime,this._mozTime?(this._boundSetTimeAutoEnabled=function(e){this.clockAutoEnabled=e.settingValue,this._setTimezoneAutoEnabled(e.settingValue)}.bind(this),this._boundSetClockAutoAvailable=function(e){this.clockAutoAvailable=e.settingValue}.bind(this),this._boundSetTimezoneAutoAvailable=function(e){this.timezoneAutoAvailable=e.settingValue}.bind(this),this._boundSetTimezone=function(e){this.timezone=e.settingValue}.bind(this),this._boundUserSelectedTimezone=function(e){this.userSelectedTimezone=e.settingValue}.bind(this),this._boundCurrentHour12=function(e){this.currentHour12=e.settingValue,this._autoUpdateDateTime()}.bind(this),this._boundHomeScreenLockAvailable=function(e){this.HomeScreenLockAvailable=e.settingValue}.bind(this),this._getDefaults(),this._attachListeners(),void 0):(console.error("Could not get window.navigator.mozTime"),void 0)},_attachListeners:function(){window.navigator.mozSettings.addObserver(i,this._boundSetTimeAutoEnabled),window.navigator.mozSettings.addObserver(r,this._boundSetClockAutoAvailable),window.navigator.mozSettings.addObserver(a,this._boundSetTimezoneAutoAvailable),window.navigator.mozSettings.addObserver(s,this._boundSetTimezone),window.navigator.mozSettings.addObserver(c,this._boundUserSelectedTimezone),window.navigator.mozSettings.addObserver(u,this._boundCurrentHour12),window.navigator.mozSettings.addObserver(l,this._boundHomeScreenLockAvailable),window.addEventListener("localized",this),window.addEventListener("moztimechange",this)},handleEvent:function(e){switch(e.type){case"moztimechange":navigator.mozL10n.ready(function(){this._autoUpdateDateTime()}.bind(this));break;case"localized":var t=new Date;this.date=this._formatDate(t),this.time=this._formatTime(t)}},_getDefaults:function(){SettingsDBCache.getSettings(function(e){this.clockAutoEnabled=e[i],this.clockAutoAvailable=e[r],this.timezoneAutoAvailable=e[a],this.timezone=e[s],this.userSelectedTimezone=e[c],this.currentHour12=e[u],this.HomeScreenLockAvailable=e[l],this._autoUpdateDateTime()}.bind(this))},_autoUpdateDateTime:function(){window.clearTimeout(d),window.clearTimeout(f),this._autoUpdateDate(),this._autoUpdateTime()},_autoUpdateDate:function(){var e=new Date;this.date=this._formatDate(e);var t=1e3*3600*(24-e.getHours())-1e3*60*e.getMinutes()-e.getMilliseconds();d=window.setTimeout(function(){this._autoUpdateDate()}.bind(this),t)},_autoUpdateTime:function(){var e=new Date;this.time=this._formatTime(e);var t=1e3*(59-e.getSeconds());f=window.setTimeout(function(){this._autoUpdateTime()}.bind(this),t)},_formatDate:function(e,t){if(e instanceof Date){if(t)return e.toLocaleFormat("%Y-%m-%d");var n=e.toLocaleString(navigator.language,{year:"numeric",month:"long",day:"numeric"});return n}return e},_formatTime:function(e,t){if(e instanceof Date){var n;if(t)return n="%H:%M",e.toLocaleFormat(n);var i=e.toLocaleString(navigator.language,{hour:"numeric",minute:"numeric",hour12:navigator.mozHour12});return i}return 1==e.indexOf(":")&&(e="0"+e),e},setTime:function(e,t){var i="",o="",r=new Date;switch(e){case"date":i=this._formatDate(t),o=this._formatTime(r,!0);break;case"time":i=this._formatDate(r,!0),o=this._formatTime(t)}console.log("NPS Settings DateTime, update time before changed"),n.createLock().set({"nps.settings.before_time_changed":Date.now()});var a=new Date(i+"T"+o);this._mozTime.set(a),console.log("NPS Settings DateTime, update time after changed"),n.createLock().set({"nps.settings.after_time_changed":Date.now()})},_setTimezoneAutoEnabled:function(e){var t={};t[o]=e,n.createLock().set(t)},setUserSelectedTimezone:function(e){for(var t={},i=0;i<p.length;i++)if(p[i].oldTimeZone==e){e=p[i].newTimeZone,dump("setUserSelectedTimezone newCity="+e);break}t[s]=e,n.createLock().set(t)},setCurrentHour12:function(e){var t={};t[u]=e,n.createLock().set(t)},setHomeScreenLockAvailable:function(e){var t={};t[l]=e,n.createLock().set(t)}},g=t(h);return g._init(),g});