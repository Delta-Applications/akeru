'use strict';const INDEX_NULL=-1;const DIR_CROP_UNIT=25;const ROTATE_RE=/rotate\(([0-9]+)/i;const CUT_SUBVIEW={cropTool:'cropTool',cropToolRevert:'cropToolRevert',cropRect:'cropRect',};const ZOOM_SUBVIEW={zoom:'zoom',zoomin:'zoomin',zoomout:'zoomout',};const EDIT_SUBVIEW=Object.assign(CUT_SUBVIEW,{home:'home',edited:'edited',exposure:'exposure',rotate:'rotate',filters:'filters',autoCorrect:'autoCorrect',});const CROP_SUBVIEW=Object.assign(CUT_SUBVIEW,ZOOM_SUBVIEW,{pickWallpaper:'pickWallpaper',pickImage:'pickImage',});const FS_SUBVIEW=Object.assign(ZOOM_SUBVIEW,{home:'home',});Object.freeze(CUT_SUBVIEW);Object.freeze(ZOOM_SUBVIEW);Object.freeze(EDIT_SUBVIEW);Object.freeze(CROP_SUBVIEW);Object.freeze(FS_SUBVIEW);var Gallery={debug:debug.bind(window,'App'),currentFocusIndex:0,lastCropIndex:INDEX_NULL,lastSubView:null,lastView:null,subView:null,fullscreen:{arrows:null,settingWallpaper:false,zooming:false,},columnCount:null,thumbnailRefreshIndex:0,isTriggerAll:false,triggerCamera:false,deleteFiles:[],deleteSuccessFiles:[],deleteErrorFiles:[],deleteSelected:false,isFirstScreen:true,creatingThumbnails:false,hideProgressBarTimeout:null,enumerateState:null,enumerateIndex:0,enumerateFiles:[],enumerateEnd:false,visuallyLoaded:false,enumerateTimeout:null,init:function(){let matchMedia=window.matchMedia("(orientation: landscape)");if(matchMedia.matches){this.columnCount=4;}else{this.columnCount=3;}
this.debug('init');this.showScanOverlay();SoftkeyManager.init();},showScanOverlay:function(){Overlay.show('scanning');ProgressBar.showGaiaProgress();},clear:function(){this.subView=null;this.lastView=null;this.lastSubView=null;this.lastCropIndex=INDEX_NULL;},get fullView(){var view=currentView;if(this.subView&&this.subView.length>0){view+='.'+this.subView;}
return view;},updateSubLastView:function(subview){this.subView=subview;this.lastSubView=subview;},focusChangedHandler:function(element,eleIndex){if(ViewHelper.focusChange&&currentActiveDialog==undefined)
ViewHelper.focusChange.call(this,element,eleIndex);},getPrevFileIndex:function(updateNav){return this.getFileKey(false,updateNav);},getNextFileIndex:function(updateNav){return this.getFileKey(true,updateNav);},getFileKey:function(isNext,updateNav){let allThumbnails=null;if(Favorite.isFavoriteList){allThumbnails=Favorite.getALLFavorites();}else{allThumbnails=NavigationMap.listControls();}
let focusIndex=this.currentFocusIndex;let element=allThumbnails[focusIndex];if(isNext){let nextSibling=allThumbnails[focusIndex+1];if(element&&nextSibling){element=nextSibling;focusIndex++;}else{element=null;}
if(element){while(element&&element.classList.contains('largeSize')){nextSibling=allThumbnails[focusIndex+1];if(nextSibling){element=nextSibling;focusIndex++;}else{element=null;}}}}else{let previousSibling=allThumbnails[focusIndex-1];if(previousSibling){element=previousSibling;focusIndex--;}else{element=null;}
if(element){while(element&&element.classList.contains('largeSize')){previousSibling=allThumbnails[focusIndex-1];if(previousSibling){element=previousSibling;focusIndex--;}else{element=null;}}}};if(element){if(updateNav){this.currentFocusIndex=focusIndex;}
return this.numberFilesKeyCounter(element.firstElementChild);}else{return-1;}},editedImageAddBg:function(imageDiv,fileInfo){let url=URL.createObjectURL(fileInfo.metadata.thumbnail);imageDiv.dataset.src=url;imageDiv.style.backgroundImage='url('+url+')';},numberFilesKeyCounter:function(imageDiv){return Number(imageDiv.getAttribute('data-fileskeycounter'));},setCurrentFileKeyByElement:function(element){let fileKey=FilesStore.getFilesKeyCounterByName(element.firstElementChild.dataset.filename);if(-1!==fileKey){FilesStore.currentFileKey=fileKey;this.debug("setCurrentFileKeyByElement:FilesStore.currentFileKey:",fileKey);}},liveFocusChange:function(element,eleIndex){this.setCurrentFileKeyByElement(element);this.currentFocusIndex=eleIndex;Favorite.updateOptionsMenu();},selectFocusChange:function(element,eleIndex){this.setCurrentFileKeyByElement(element);this.currentFocusIndex=eleIndex;const selected=element.querySelector('.thumbnail-list-img').classList.contains('selected');Gallery.setSelectSubView(!isSelectAll?'all':(selected?'des':''));},pickFocusChange:function(element,eleIndex){this.setCurrentFileKeyByElement(element);this.currentFocusIndex=eleIndex;},editFocusChange:function(element,eleIndex){if([EDIT_SUBVIEW.cropTool,EDIT_SUBVIEW.cropToolRevert,EDIT_SUBVIEW.filters,EDIT_SUBVIEW.autoCorrect].contains(Gallery.subView)){element.click();}
if(EDIT_SUBVIEW.cropTool===Gallery.subView||EDIT_SUBVIEW.cropToolRevert===Gallery.subView)
Gallery.lastCropIndex=eleIndex;},setHeaderL10nId:function(id,l10nId){$(id).setAttribute('data-l10n-id',l10nId);},setEditHeader:function(l10nId){this.setHeaderL10nId('edit-title',l10nId);},fsDirChange:function(dir){if(currentActiveDialog){this.setSelection(dir);return;}
if(Gallery.fullscreen.zooming){window.dispatchEvent(new CustomEvent('moveframe',{detail:{keyId:dir}}));}else{if(SoftkeyManager.menuVisible()||!$('set-wallpaper').classList.contains('hidden'))
return;switch(dir){case DIR.LEFT:if(FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation
!==0){Gallery.updateRotateValue(0,Gallery.currentImage);}
if(FS_SUBVIEW.home===this.subView)
previousFile(150);SoftkeyManager.setSkMenu();break;case DIR.RIGHT:if(FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation
!==0){Gallery.updateRotateValue(0,Gallery.currentImage);}
if(FS_SUBVIEW.home===this.subView)
nextFile(150);SoftkeyManager.setSkMenu();break;case DIR.UP:break;case DIR.DOWN:break;default:break;}}},editDirChange:function(dir){switch(Gallery.subView){case EDIT_SUBVIEW.exposure:if(DIR.LEFT===dir||DIR.RIGHT===dir){exposureSlider.positionChange(document.documentElement.dir==='rtl'?DIR.RIGHT!==dir:DIR.RIGHT===dir);}
break;case EDIT_SUBVIEW.cropRect:imageEditor.updateCrop(this.getDelta(dir,DIR_CROP_UNIT));break;}},getDelta:function(dir,unit){var delta={x:0,y:0};switch(dir){case DIR.LEFT:delta.x=-unit;break;case DIR.RIGHT:delta.x=unit;break;case DIR.UP:delta.y=-unit;break;case DIR.DOWN:delta.y=unit;break;}
return delta;},enterEditHome:function(isback){this.lastSubView=this.subView;if(isback)onCancelButton();if(imageEditor&&imageEditor.isEdited()){this.subView=EDIT_SUBVIEW.edited;}else{this.subView=EDIT_SUBVIEW.home;}
SoftkeyManager.setSkMenu();$('edit-toolbar').classList.remove('hidden');},editDone:function(){applyEditTool();this.enterEditHome(false);},editorRotate:function(isClockwise){if(imageEditor){imageEditor.rotate(isClockwise);}},renameEditedImage:function(cb){editSaveCallback=function(findex){editSaveCallback=null;this.debug("renameEditedImage:editSaveCallback:",findex);this.currentFocusIndex=getInsertPosition(FilesStore.getFileInfo(findex),true);}.bind(this,FilesStore.currentFileKey);if(!!cb){saveEditedImage(cb);}else{saveEditedImage(this.exitEdit.bind(this));}},setSelection:function(dir){if(document.activeElement.type==='text'&&currentActiveDialog){switch(dir){case DIR.LEFT:if(document.activeElement.selectionStart>0)
document.activeElement.setSelectionRange(document.activeElement.selectionStart-1,document.activeElement.selectionStart-1);break;case DIR.RIGHT:if(document.activeElement.selectionStart<document.activeElement.value.length)
document.activeElement.setSelectionRange(document.activeElement.selectionStart+1,document.activeElement.selectionStart+1);break;}}},checkExists:function(newFilename,callback,errcallback){photodb.getFile(newFilename,function(){if(errcallback)
errcallback();},function(){if(callback)
callback();});},fileInfoQuit:function(){infoDialog.classList.add('hidden');},exitEdit:function(){var launcher=this.lastView;exitEdit();this.clear();if(LAYOUT_MODE.fullscreen===launcher){setView(LAYOUT_MODE.fullscreen);updateFrames(FilesStore.currentFileKey);}else{if(Favorite.isFavoriteList){setView(LAYOUT_MODE.favorite);Favorite.backFavoriteView();}else{setView(LAYOUT_MODE.list);}}},setEditSubView:function(editSubView){editArrow.classList.remove('hidden');if(editArrowDirection=='upDown'){editArrow.classList.add('rotate90');}else{editArrow.classList.remove('rotate90');}
if(editSubView==='cropTool'||editSubView==='cropToolRevert')
editArrow.classList.add('hidden');NavigationMap.disableNav=false;this.subView=editSubView;var options=$('edit-crop-options');var isOptions=(EDIT_SUBVIEW.cropTool===editSubView||EDIT_SUBVIEW.cropToolRevert===editSubView);options.setVisible(isOptions);if(isOptions)Gallery.optionClick(options);},setSelectSubView:function(selectSubView){Gallery.subView=selectSubView;SoftkeyManager.setSkMenu();},setFsSubView:function(fsSubView){var isZoom=(FS_SUBVIEW.home!==fsSubView);if(['zoom','zoomout','zoomin'].contains(this.subView)&&fsSubView==='home')
restoreFrame();this.subView=fsSubView;this.fullscreen.zooming=isZoom;SoftkeyManager.setSkMenu();},showWallpaper:function(){const wallpaper=$('set-wallpaper');const outputSize={w:document.body.clientWidth*window.devicePixelRatio,h:document.getElementById("frames").offsetHeight};this.fullscreen.settingWallpaper=true;const fileInfo=FilesStore.getFileInfo(FilesStore.currentFileKey);this.downResolusion(fileInfo.metadata,outputSize).then((blob)=>{wallpaper.firstElementChild.src=URL.createObjectURL(blob);wallpaper.firstElementChild.onload=function(){var wallpaperWidth=wallpaper.firstElementChild.width;var wallpaperHeight=wallpaper.firstElementChild.height;wallpaper.firstElementChild.style.top=(outputSize.h-wallpaperHeight)/2+'px';wallpaper.firstElementChild.style.left=(outputSize.w-wallpaperWidth)/2+'px';wallpaper.setVisible(true);};});SoftkeyManager.menuCreate('fullscreenView.setWallpaper');},downResolusion:function(metadata,outputSize){return new Promise((resolve)=>{let imagesize=metadata.width*metadata.height;let scale=(window.innerWidth*window.devicePixelRatio*window.innerHeight*window.devicePixelRatio)/imagesize;let sampleSize=Downsample.areaNoMoreThan(scale);let url=URL.createObjectURL(currentFrame.imageblob);url=url+sampleSize;const canvas=document.createElement('canvas');const screenWidth=outputSize.w;const screenHeight=outputSize.h;canvas.width=screenWidth;canvas.height=screenHeight;const img=new Image();img.src=url;img.onload=()=>{let actualWidth=img.width;let actualHeight=img.height;let widthScale=screenWidth/actualWidth;let heightScale=screenHeight/actualHeight;let scale=Math.max(widthScale,heightScale);let cropWidth=Math.round(screenWidth/scale);let cropHeight=Math.round(screenHeight/scale);let cropLeft=Math.floor((actualWidth-cropWidth)/2);let cropTop=Math.floor((actualHeight-cropHeight)/2);let cvs=document.createElement('canvas');cvs.width=screenWidth;cvs.height=screenHeight;let context=cvs.getContext('2d');context.drawImage(img,cropLeft,cropTop,cropWidth,cropHeight,0,0,screenWidth,screenHeight);cvs.toBlob((newBlob)=>{URL.revokeObjectURL(img.src);resolve(newBlob);},'image/jpeg');};});},setWallpaperBlob:function(wallPaperBlob){var canvas=document.createElement('canvas');var screenWidth=document.body.clientWidth*window.devicePixelRatio;var screenHeight=document.body.clientHeight*window.devicePixelRatio;canvas.width=screenWidth;canvas.height=screenHeight;var ctx=canvas.getContext('2d');var img=new Image();var self=this;img.src=URL.createObjectURL(wallPaperBlob);img.onload=()=>{ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(newBlob){try{var req=navigator.mozSettings.createLock().set({'wallpaper.image':newBlob});req.onsuccess=function(){Message.show('wallpaper-set');};}finally{URL.revokeObjectURL(img.src);self.hideWallpaper();}},'image/jpeg');};},setWallpaper:function(){var w=document.body.clientWidth*window.devicePixelRatio;var h=document.body.clientHeight*window.devicePixelRatio;var outputSize=null;if(this.lowMemory){outputSize={width:w,height:h};}
this.gotImageBlob(outputSize,function(blob){if(this.lowMemory){this.setWallpaperBlob(blob);return;}
try{var req=navigator.mozSettings.createLock().set({'wallpaper.image':blob});req.onsuccess=function(){Message.show('wallpaper-set');};}finally{this.hideWallpaper();}}.bind(this));},hideWallpaper:function(){$('set-wallpaper').setVisible(false);this.fullscreen.settingWallpaper=false;SoftkeyManager.setSkMenu();},zoomIn:function(){var zoomResult=zoomIn();var self=this;if(!zoomResult&&self.subView!=FS_SUBVIEW.zoomout){self.setFsSubView(FS_SUBVIEW.zoomout);}else if(self.subView!=FS_SUBVIEW.zoom){self.setFsSubView(FS_SUBVIEW.zoom);}},zoomOut:function(){var zoomResult=zoomOut();var self=this;if(!zoomResult&&self.subView!=FS_SUBVIEW.zoomin){self.setFsSubView(FS_SUBVIEW.zoomin);}else if(self.subView!=FS_SUBVIEW.zoom){self.setFsSubView(FS_SUBVIEW.zoom);}},pickCancel:function(){Pick.exit();},pickCropOK:function(){Pick.end();},get currentImage(){return currentFrame.container.querySelector('img.displayframe');},getRotateValue:function(obj){var rotateValue;if(undefined===obj)obj=Gallery.currentImage;if(ROTATE_RE.test(obj.style.transform)){var degrees=parseInt(RegExp.$1);if(!isNaN(degrees))rotateValue=degrees;}
return rotateValue;},updateRotateValue:function(degrees,obj){if(isNaN(degrees))return;if(undefined===obj)obj=Gallery.currentImage;obj.style.transform=obj.style.transform.replace(ROTATE_RE,'rotate('+degrees);FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation=degrees;},loadImageEditorJS:function(object,callback){if(typeof ImageEditor==='undefined'||typeof cropResizeRotate==='undefined'){LazyLoader.load(['shared/js/media/downsample.js','shared/js/media/crop_resize_rotate.js','js/ImageEditor.js'],callback.bind(object));}else{callback.call(object);}},activityHelper:function(actName,actData,callback){var activity=new MozActivity({name:actName,data:actData});activity.onsuccess=function(e){callback(e);};activity.onerror=function(e){this.debug('activity',e.error);};},gotImageBlob:function(outputSize,callback){if(typeof cropResizeRotate==='undefined'){LazyLoader.load(['shared/js/media/downsample.js','shared/js/media/crop_resize_rotate.js'],gotModifiedImage.bind(null,outputSize));}else{gotModifiedImage(outputSize);}
function gotModifiedImage(outputSize){Spinner.show();cropResizeRotate(currentFrame.imageblob,null,outputSize,null,FilesStore.getFileInfo(FilesStore.currentFileKey).metadata,(error,rotatedBlob)=>{if(error){log('rotating error',error);rotatedBlob=currentFrame.imageblob;}
LazyLoader.load('js/ensure_file_backed_blob.js',function(){ensureFileBackedBlob(rotatedBlob,function(blob){Spinner.hide();callback(blob);});});});}},onEndkeyHandled:function(e){if(currentView===LAYOUT_MODE.edit&&EDIT_SUBVIEW.edited===Gallery.subView){e.stopPropagation();e.preventDefault();if(!endKeyPressed){SoftkeyManager.editBack(e,true);}}},optionClick:function(options,index){if(undefined===index)
index=NavigationMap.getEditFocusIndex();if(options.children&&index<options.children.length)
options.children[index].click();},};