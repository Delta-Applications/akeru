'use strict';(function(exports){var SoftkeyManager={debug:debug.bind(window,'SoftkeyManager'),softkey:null,softkeyItems:null,menuItems:null,init:function(){this.debug('init');var self=this;window.addEventListener('keyup',function(e){if((e.key==='Clear')&&NavigationMap.currentActivatedLength==0&&!currentActiveDialog&&!SoftkeyManager.menuVisible())
self.menuDelete();});this.menuItems={delete:{name:'Delete',l10nId:'delete',priority:4,method:this.menuDelete.bind(this)},edit:{name:'Name',l10nId:'edit',priority:5,method:this.menuEdit.bind(this)},addfavorite:{name:'Add to favorites',l10nId:'add-favorite',priority:6,method:this.menuUpdateFavoriteStatus.bind(this)},removefavorite:{name:'Remove from favorites',l10nId:'remove-favorite',priority:6,method:this.menuUpdateFavoriteStatus.bind(this)},rotate:{name:'Rotate',l10nId:'kai-rotate',priority:7,method:this.menuRotate.bind(this)},share:{name:'Share',l10nId:'kai-share',priority:8,method:this.menuShare.bind(this)},select:{name:'Select Multiple',l10nId:'kai-select-multiple',priority:9,method:this.menuMultiple.bind(this)},finfo:{name:'File Info',l10nId:'kai-file-info',priority:10,method:this.menuFileinfo.bind(this)},setasWallpaper:{name:'Set as wallpaper',l10nId:'set-as-wallpaper',priority:11,method:this.menuWallpaper.bind(this)},setas:{name:'Set as',id:'setas',l10nId:'kai-set-as',priority:12,},wallpaper:{name:'Wallpaper',fid:'setas',l10nId:'kai-wallpaper',priority:13,method:this.menuWallpaper.bind(this)},contact:{name:'Image for existing contact',fid:'setas',priority:14,l10nId:'kai-existing-contact-image',method:this.menuContact.bind(this)},sortandgroup:{name:'Sort and Group',l10nId:'sort-and-group',priority:15,method:this.menuSettings.bind(this)},listOptions:function(){if(chkIsCurrentLarge()){if(lowMemory){return[this.delete,this.select,this.finfo];}else{return[this.delete,this.select,this.finfo,this.sortandgroup];};};let menuFavorite=Favorite.checkIsFavorite()?this.removefavorite:this.addfavorite;if(lowMemory){return[this.delete,menuFavorite,this.share,this.select,this.finfo];}else{return[this.delete,this.edit,menuFavorite,this.share,this.select,this.finfo,this.sortandgroup];};},selectOptions:function(){let isSelected=selectedFileNames.length>0?true:false;let isSelectedInvalid=selectedInvalid>0?true:false;if(!isSelected){return[];}
if(isSelected&&!isSelectedInvalid){return lowMemory?[this.delete]:[this.delete,this.share];}
if(isSelected&&isSelectedInvalid){if(selectedFileNames.length===selectedInvalid){return[this.delete];}else{return lowMemory?[this.delete]:[this.delete,this.share];}}},fullscreenOptions:function(){if(chkIsCurrentLarge()){SoftkeyManager.setSkVisible(false,1);return[this.delete,this.sortandgroup];}
if(!SoftkeyManager.isSkVisible(1)){SoftkeyManager.setSkVisible(true,1);}
if(FS_SUBVIEW.home!=Gallery.subView)return[];let menuFavorite=Favorite.checkIsFavorite()?this.removefavorite:this.addfavorite;if(lowMemory){if(dmWallpaperImage){return[this.delete,menuFavorite,this.share,this.finfo];}else{return[this.delete,menuFavorite,this.share,this.finfo,this.setasWallpaper];}}else{if(dmWallpaperImage){return[this.delete,this.edit,menuFavorite,this.share,this.finfo,this.setas,this.contact,this.sortandgroup];}else{return[this.delete,this.edit,menuFavorite,this.share,this.finfo,this.setas,this.wallpaper,this.contact,this.sortandgroup];}}}},this.softkeyItems={'thumbnailListView':[{name:'Favorites',l10nId:'favorite',priority:1,method:Favorite.showFavoriteScreen.bind(Favorite)},{name:'Select',l10nId:'kai-select',priority:2,method:null,},],'favoriteView':[{name:'Gallery',l10nId:'gallery',priority:1,method:Favorite.showThumbnailListView.bind(Favorite)},{name:'Select',l10nId:'kai-select',priority:2,method:null,},],'thumbnailSelectView':[{name:'All',l10nId:'kai-select-all',priority:1,method:selectAllPhotos,},{name:'Select',l10nId:'select',priority:2,method:null,}],'thumbnailSelectView.des':[{name:'All',l10nId:'kai-select-all',priority:1,method:selectAllPhotos,},{name:'Deselect',l10nId:'deselect',priority:2,method:null,}],'thumbnailSelectView.all':[{name:'None',l10nId:'kai-deselect-all',priority:1,method:selectAllPhotos,},{name:'Deselect',l10nId:'deselect',priority:2,method:null,}],'fullscreenView.home':[{name:'Zoom',l10nId:'kai-zoom',priority:1,method:function(){if(!SoftkeyManager.isSkVisible(1)){return;}
let preloadBgImage=new Image();let preloadSrcImage=new Image();preloadBgImage.src=currentFrame.previewImageURL;preloadSrcImage.src=currentFrame.fullImageURL;preloadSrcImage.addEventListener("load",function(){currentFrame._switchToFullSizeImage();zoomResize();var zoomInTimes=parseInt(currentFrame.image.getAttribute('data-zoom-in'));var zoomOutTimes=parseInt(currentFrame.image.getAttribute('data-zoom-out'));if(zoomInTimes>=ZOOM_IN_LIMIT){Gallery.setFsSubView(FS_SUBVIEW.zoomout);}else if(zoomOutTimes>=ZOOM_OUT_LIMIT){Gallery.setFsSubView(FS_SUBVIEW.zoomin);}else{Gallery.setFsSubView(FS_SUBVIEW.zoom);};});}},],'fullscreenView.setWallpaper':[{name:'Cancel',l10nId:'cancel',priority:1,method:Gallery.hideWallpaper.bind(Gallery),},{name:'Set',l10nId:'kai-set',priority:3,method:Gallery.setWallpaper.bind(Gallery),},],'fullscreenView.zoom':[{name:'Zoom Out',l10nId:'kai-zoom-out',priority:1,method:Gallery.zoomOut.bind(Gallery),},{name:'Zomm In',l10nId:'kai-zoom-in',priority:3,method:Gallery.zoomIn.bind(Gallery),},],'fullscreenView.zoomin':[{name:'Zomm In',l10nId:'kai-zoom-in',priority:3,method:Gallery.zoomIn.bind(Gallery),},],'fullscreenView.zoomout':[{name:'Zomm Out',l10nId:'kai-zoom-out',priority:1,method:Gallery.zoomOut.bind(Gallery),},],'editView.home':[{name:'Cancel',l10nId:'cancel',priority:1,method:SoftkeyManager.editBack,},{name:'Select',l10nId:'kai-select',priority:2,method:null,},],'editView.edited':[{name:'Cancel',l10nId:'cancel',priority:1,method:SoftkeyManager.editBack,},{name:'Select',l10nId:'kai-select',priority:2,method:null,},{name:'Save',l10nId:'save',priority:3,method:Gallery.renameEditedImage.bind(Gallery),},],'editView.exposure':[{name:'Done',l10nId:'done',priority:2,method:Gallery.editDone.bind(Gallery),},],'editView.rotate':[{name:'Done',l10nId:'done',priority:2,method:Gallery.editDone.bind(Gallery),},{name:'Rotate',l10nId:'kai-rotate',priority:3,method:Gallery.editorRotate.bind(Gallery,true),},],'editView.cropRect':[{name:'OK',l10nId:'ok',priority:2,method:Gallery.editDone.bind(Gallery),},{name:'',l10nId:'',priority:3,method:Gallery.setEditSubView.bind(Gallery,EDIT_SUBVIEW.cropTool),},],'editView.cropTool':[{name:'OK',l10nId:'ok',priority:2,method:Gallery.setEditSubView.bind(Gallery,EDIT_SUBVIEW.cropRect),}],'editView.cropToolRevert':[{name:'OK',l10nId:'ok',priority:2,method:Gallery.setEditSubView.bind(Gallery,EDIT_SUBVIEW.cropRect),},{name:'Revert',l10nId:'revert',priority:3,method:function(){undoCropHandler();imageEditor.isChange=false;Gallery.setEditSubView(EDIT_SUBVIEW.cropTool);NavigationMap.reset(NAV_TYPE.view);}}],'info-view':[{name:'Cancel',l10nId:'cancel',priority:1,method:SoftkeyManager.dialogBack}],'settings-dialog':[{name:'Select',l10nId:'select',priority:2,method:null}]};this.softkeyItems['editView.filters']=this.softkeyItems['editView.autoCorrect']=this.softkeyItems['editView.exposure'];this.debug('init done');},initPickRelateButton:function(){this.softkeyItems['pickView']=[{name:'Cancel',l10nId:'cancel',priority:1,method:Gallery.pickCancel,},{name:'Select',l10nId:'select',priority:2,method:null,}];this.softkeyItems['cropView.pickImage']=[{name:'Cancel',l10nId:'cancel',priority:1,method:SoftkeyManager.cropBack,},{name:'Done',l10nId:'done',priority:3,method:Pick.save.bind(Pick),}];this.softkeyItems['cropView.pickWallpaper']=this.softkeyItems['cropView.pickImage'];},initDongleButton:function(){const select={name:'Select',l10nId:'select',priority:2,method:null,};const deselect={name:'Deselect',l10nId:'deselect',priority:2,method:null,}
const paly={name:'DonglePlay',l10nId:'donglePlay',priority:3,method:Dongle.donglePlay.bind(Dongle)}
this.softkeyItems['dongle-select-selected']=[select,paly];this.softkeyItems['dongle-select-not-selected']=[select];this.softkeyItems['dongle-deselect']=[deselect,paly];},setMethod:function(view,index,method){this.debug('setMethod',view,index,method);this.softkeyItems[view][index].method=method;},setSkMenu:function(view){if(undefined===view){view=Gallery.fullView;}
this.debug('setSkMenu:',view);var items=this.softkeyItems[view];if(items){if(ViewHelper.options){var options=ViewHelper.options.call(this.menuItems);items=items.concat(options);}
this.create(items);}
this.showRsk(true);},setSkMenu4Dialog:function(id){if(id){this.create(this.softkeyItems[id]);}else{this.setSkMenu();}},create:function(items){var self=this;if((!items||items.length===0)&&!Overlay.empty){if(this.softkey)this.softkey.hide();return;}
this.debug('create',items);var skParams={header:lget('kai-options'),handleDelay:true,items:items};if(!this.softkey){this.softkey=new SoftkeyPanel(skParams);}else{self.softkey.initSoftKeyPanel(skParams);}
if(!NavigationMap.inProgress&&!overlaySK.softKeyVisible)
this.softkey.show();else
this.softkey.hide();},menuVisible:function(){if(SoftkeyManager.softkey==null)
return false;else
return SoftkeyManager.softkey.menuVisible;},menuCreate:function(key){this.items=this.softkeyItems[key];},menuEnd:function(){if(this.items){this.create(this.items);this.items=null;}},getSk:function(priority){var sks=this.softkeyItems[Gallery.fullView];if(undefined===priority)priority=sks[0].priority;var ids=['left','center','rigth'];return $('software-keys-'+ids[priority-1]);},updateSkText:function(l10nId,priority){var sk=this.getSk(priority);if(sk)sk.innerHTML=lget(l10nId);},setSkVisible:function(visibile,priority){var sk=this.getSk(priority);if(sk)sk.setVisible(visibile);},isSkVisible:function(priority){var sk=this.getSk(priority);if(sk){return!sk.classList.contains('hidden');}},disable:function(disable,priority){var sk=this.getSk(priority);if(sk)sk.disable=disable;},dirKeyHandler:function(arrowDir){if(ViewHelper.dirChange)
ViewHelper.dirChange.call(Gallery,arrowDir);},endKeyHandler:function(evt){var handled=SoftkeyManager.dialogBack();if(handled){evt.preventDefault();}},enterKeyHandler:function(){if(currentActiveDialog){let input_box=currentActiveDialog.querySelector('input');if(input_box&&['text','password','email','checkbox'].indexOf(input_box.type)>-1){input_box.focus();}
return;}},dialogBack:function(callback){if(['scanning','upgrade'].contains(Overlay.current)){return false;}
if(['emptygallery','pluggedin','nocard'].contains(Overlay.current)){return false;}
if(Overlay.current==="emptyfavorite"){callback&&callback();return false;}
if(currentActiveDialog!=undefined){if(currentActiveDialog.id==='overlay'){overlaySK.hide();}else if(currentActiveDialog.id==='settings-dialog'){NavigationMap.reset(NAV_TYPE.view);}
var cdialog=currentActiveDialog;currentActiveDialog=undefined;cdialog.classList.add('hidden');NavigationMap.showDialog=null;return true;}else if(NavigationMap.currentActivatedLength<1){callback&&callback();return false;}},get showingMenu(){var focusedMenus=document.getElementsByClassName('group-menu visible');return focusedMenus.length>0;},otherHandler:function(key){},backKeyHandler:function(event){if(this.menuVisible()){return true;}
if(ViewHelper.back){ViewHelper.back(event);}},showRsk:function(show){var rsk=document.querySelector('#softkeyPanel #software-keys-right');if(!rsk){return;}
if(show){rsk.classList.remove('disable');}else{rsk.classList.add('disable');}},selectBack:function(evt){evt.preventDefault();setView(Gallery.lastView);if(currentView===LAYOUT_MODE.favorite){Favorite.backFavoriteView()}},fullscreenBack:function(evt){var handled=SoftkeyManager.dialogBack(function(){if(Gallery.fullscreen.settingWallpaper){Gallery.hideWallpaper.call(Gallery);evt&&evt.preventDefault();return;}
if(FS_SUBVIEW.home!=Gallery.subView){Gallery.setFsSubView(FS_SUBVIEW.home);evt&&evt.preventDefault();}else{let rotate=FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation||0;if(0===rotate){if(Favorite.isFavoriteList){setView(LAYOUT_MODE.favorite);Favorite.backFavoriteView();}else{setView(LAYOUT_MODE.list);}
Favorite.refreshBackground(Gallery.currentFocusIndex);}else{Gallery.updateRotateValue(0);}
evt&&evt.preventDefault();}});if(handled){evt&&evt.preventDefault();}},editBack:function(evt,endkeyCall){var endKeyCallFn=null;if(evt){evt.preventDefault();}
if(!!endkeyCall){endKeyCallFn=()=>{window.close();};}
if(EDIT_SUBVIEW.home===Gallery.subView){Gallery.exitEdit();}else if(EDIT_SUBVIEW.edited===Gallery.subView){endKeyPressed=true;var dialogConfig={title:{id:'kai-confirmation',args:{}},body:{id:'save-changes-warning',args:{}},backcallback:function(){endKeyPressed=false;return false;},confirm:{l10nId:'discard',callback:function(){endKeyPressed=false;if(endKeyCallFn){endKeyCallFn();}else{Gallery.exitEdit();}}},cancel:{l10nId:'cancel',callback:function(){endKeyPressed=false;}},accept:{l10nId:'save',callback:function(){endKeyPressed=false;Gallery.renameEditedImage(endKeyCallFn);}}};confirmDialog(dialogConfig);}else{Gallery.enterEditHome(true);}},cropBack:function(evt){Gallery.lastSubView=Gallery.subView;if([CROP_SUBVIEW.pickWallpaper,CROP_SUBVIEW.pickImage].contains(Gallery.subView)){pickEditor.destroy();setView(LAYOUT_MODE.pick);NavigationMap.disableNav=false;evt.preventDefault();evt.stopPropagation();return;}},menuContact:function(){this.debug('menuContact');shareProcess=true;Gallery.activityHelper('pick',{type:'webcontacts/contact',params:{typeOfContact:'all'}},function(contactEvent){var contact=contactEvent.currentTarget.result.contact;if(!contact){shareProcess=false;return;}
var request=window.navigator.mozContacts.find({filterBy:['id'],filterValue:contact.id,filterOp:'equals',filterLimit:1});request.onsuccess=function(){shareProcess=false;Gallery.gotImageBlob({width:320,height:320},(blob)=>{request.result[0].photo=[blob];var saveReq=navigator.mozContacts.save(request.result[0]);saveReq.onsuccess=function(){Message.show('kai-contact-set-ok');};saveReq.onerror=function(e){Message.show('kai-contact-set-fail');log('save contact error:',saveReq.error.name);};});};request.onerror=function(e){shareProcess=false;Message.show('kai-contact-set-fail');log('find contact error:',request.error.name);};});},menuDelete:function(){if(ViewHelper.delete)
ViewHelper.delete();},menuEdit:function(){if(FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation){FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation=0;}
Gallery.loadImageEditorJS(null,()=>{Gallery.lastView=currentView;editPhotoIfCardNotFull(FilesStore.currentFileKey);});},menuFileinfo:function(){NavigationMap.showDialog='info-view';LazyLoader.load(['js/fileinfo.js','style/info.css'],()=>{showFileInformation(FilesStore.getFileInfo(FilesStore.currentFileKey));});},menuRotate:function(){var lastDegrees=Gallery.getRotateValue();if(undefined!==lastDegrees){var degrees=Utilities.getLoopNum(0,270,lastDegrees,true,90);Gallery.updateRotateValue(degrees);FilesStore.getFileInfo(FilesStore.currentFileKey).metadata.rotation=degrees;}},menuSettings:function(){NavigationMap.showDialog='settings-dialog';Settings.gallerySettings();},menuShare:function(){if(ViewHelper.share)
ViewHelper.share();},menuMultiple:function(){setView(LAYOUT_MODE.select);this.setSkMenu();},menuWallpaper:function(){Gallery.showWallpaper();},menuUpdateFavoriteStatus:function(){Favorite.updateStatus();},};exports.SoftkeyManager=SoftkeyManager;})(window);