'use strict';(function(exports){let Dongle={request:null,isDonglePick:false,isDonglePickMultiple:false,dongleManager:null,dongleEnabled:null,maxPickCount:0,DEFAULT_MAX_PICK_COUNT:50,JIO_MEDIA_CABLE_APP_ORIGIN:'app://jiomediacable.gaiamobile.org',initDongle(activity){const{data}=activity.source;this.request=activity;this.maxPickCount=data.limit||this.DEFAULT_MAX_PICK_COUNT;this.isDonglePick=true;this.isDonglePickMultiple=data.selectMode==='multiple'?true:false;this.initDongleView();},initDongleView(){currentView=LAYOUT_MODE.dongle;document.body.classList.add(LAYOUT_MODE.dongle);document.body.classList.add(LAYOUT_MODE.select);resetSelection();SoftkeyManager.initDongleButton();this.updateSoftKeyButton(false);ViewHelper.resetView();},initDongleManager(){this.dongleManager=navigator.dongleManager;if(this.dongleManager){this.dongleEnabled=this.dongleManager.dongleStatus;this.monitorDongleStatusChange();}},monitorDongleStatusChange(){this.dongleManager.addEventListener('donglestatuschange',(event)=>{this.dongleEnabled=event.isConnected;if(this.dongleEnabled&&currentView===LAYOUT_MODE.fullscreen){this.hasJioMediaCable().then((hasApp)=>{if(hasApp){Preview.playImageOnDongleDevice();}});}else if(!this.dongleEnabled&&this.request){this.dongleBackHandle();}});},imagePlayOnDongleDevice(data){let dataPath=data?data.getAttribute('data-filename'):currentFrame.filename;const startPos=dataPath.lastIndexOf('/');const dataTitle=dataPath.substring(startPos+1).match(/^.+(?=\.\w+$)/)[0];const activity=new MozActivity({name:'show',data:{type:'dongle/controller',mediaType:'image',mediaList:[{path:dataPath,title:dataTitle}]}});activity.onerror=()=>{SoftkeyManager.fullscreenBack();console.error('Dongle activity error!');};activity.onsuccess=()=>{SoftkeyManager.fullscreenBack();};},donglePlay(){let arr=[];const thumbnails=thumbnailList.getAllThumbnails();for(let i=0;i<thumbnails.length;i++){const{name}=thumbnails[i].data;if(selectedFileNames.contains(name)){const title=name.substring(name.lastIndexOf('/')+1).match(/^.+(?=\.\w+$)/)[0];arr.push({path:name,title});}
if(arr.length===selectedFileNames.length){break;}}
this.request.postResult(arr);},updateSoftKeyButton(select){let softKeyID=null;if(select){softKeyID='dongle-deselect';}else{softKeyID=selectedFileNames.length===0?'dongle-select-not-selected':'dongle-select-selected';}
SoftkeyManager.setSkMenu(softKeyID);},dongleFocusChange(element,eleIndex){Gallery.setCurrentFileKeyByElement(element);Gallery.currentFocusIndex=eleIndex;const selected=element.querySelector('.thumbnail-list-img').classList.contains('selected');Dongle.updateSoftKeyButton(selected);},dongleBackHandle(){Dongle.request.postResult('go back dongle');},hasJioMediaCable(){return new Promise((resolve)=>{const pendingGetAll=navigator.mozApps.mgmt.getAll();pendingGetAll.onsuccess=(event)=>{const apps=event.target.result||[];const appIndex=apps.findIndex((mozApp)=>mozApp.origin.includes(this.JIO_MEDIA_CABLE_APP_ORIGIN));resolve(appIndex!==-1);};});}};exports.Dongle=Dongle;})(window);